<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="ä½ æ„¿æ„é™ªæˆ‘ä¸€èµ·èœé¸¡å˜å‡¤å‡°å—">
<meta property="og:type" content="website">
<meta property="og:title" content="Coding_dogçš„æˆé•¿ç¬”è®°">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
<meta property="og:description" content="ä½ æ„¿æ„é™ªæˆ‘ä¸€èµ·èœé¸¡å˜å‡¤å‡°å—">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Coding_dogçš„æˆé•¿ç¬”è®°">
<meta name="twitter:description" content="ä½ æ„¿æ„é™ªæˆ‘ä¸€èµ·èœé¸¡å˜å‡¤å‡°å—">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"right","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Coding_dogçš„æˆé•¿ç¬”è®°</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Coding_dogçš„æˆé•¿ç¬”è®°</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/22/å†…å­˜æ³„æ¼å¤„ç†/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/22/å†…å­˜æ³„æ¼å¤„ç†/" itemprop="url">è®°å½•ä¸€æ¬¡å†…å­˜æ³„æ¼å¤„ç†</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-06-22T00:00:00+08:00">
                2021-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/22/å†…å­˜æ³„æ¼å¤„ç†/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/06/22/å†…å­˜æ³„æ¼å¤„ç†/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="èƒŒæ™¯ï¼š"><a href="#èƒŒæ™¯ï¼š" class="headerlink" title="èƒŒæ™¯ï¼š"></a>èƒŒæ™¯ï¼š</h2><p>ç›¸åº”å…¬å¸Q2æŠ€æœ¯æˆ˜ç•¥ï¼Œæ ¹æ®é¢†å¯¼å®‰æ’ï¼Œé›†ä¸­å¤„ç†ä¸»ç«¯çš„å†…å­˜æ³„æ¼æƒ…å†µã€‚<br>ä¸»ç«¯é‡‡ç”¨å‹ç›Ÿæ£€æµ‹å¼‚å¸¸åŒ…æ‹¬å´©æºƒï¼ŒANRç­‰ç­‰ï¼Œç¼ºä¹ç›´è§‚çš„å†…å­˜æ³„æ¼æ£€æµ‹ï¼Œä¸ºäº†å¼¥è¡¥è¿™å—ç¼ºå¤±ï¼Œä¸»ç«¯åœ¨æ—©æœŸå°±æ¥å…¥äº†LeakCanaryç”¨ä»¥æ£€æµ‹ï¼Œå› æ­¤æˆ‘æ¥åˆ°ä»»åŠ¡ä¹‹åç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä½¿ç”¨LeakCanaryæŸ¥çœ‹ï¼ŒæŸ¥çœ‹ç»“æœæƒ¨ä¸å¿ç¹ï¼Œé«˜ç¹ä½¿ç”¨appä¹‹åå†…å­˜æ³„æ¼æ¬¡æ•°é«˜è¾¾1000+</p>
<h2 id="å¯»æ±‚è§£å†³æ–¹æ³•ï¼š"><a href="#å¯»æ±‚è§£å†³æ–¹æ³•ï¼š" class="headerlink" title="å¯»æ±‚è§£å†³æ–¹æ³•ï¼š"></a>å¯»æ±‚è§£å†³æ–¹æ³•ï¼š</h2><h3 id="å·¥å…·é€‰æ‹©ï¼š"><a href="#å·¥å…·é€‰æ‹©ï¼š" class="headerlink" title="å·¥å…·é€‰æ‹©ï¼š"></a>å·¥å…·é€‰æ‹©ï¼š</h3><p>é¢å¯¹ä¸»ç«¯åŠ¨è¾„å‡ ç™¾ä¸Šåƒè¡Œä»£ç çš„ç±»ï¼Œä»…ä»…ä¾é LeakCanaryæä¾›çš„ä¿¡æ¯å·²ç»ä¸å¤ªå¤Ÿç”¨äº†ï¼Œæˆ‘ä»¬éœ€è¦å°è¯•å…¶ä»–æ–¹æ³•</p>
<p>éœ€è¦å·¥å…·ï¼šAndroid studioå’ŒMemory Analyzer Tool</p>
<p>é™„ä¸ŠMemory Analyzer Toolä¸‹è½½åœ°å€ï¼š<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">http://www.eclipse.org/mat/downloads.php</a></p>
<h3 id="å®æ“æ­¥éª¤ï¼š"><a href="#å®æ“æ­¥éª¤ï¼š" class="headerlink" title="å®æ“æ­¥éª¤ï¼š"></a>å®æ“æ­¥éª¤ï¼š</h3><h4 id="ç¬¬ä¸€æ­¥ï¼šå€ŸåŠ©-Android-Profilerè·å¾—å†…å­˜å¿«ç…§"><a href="#ç¬¬ä¸€æ­¥ï¼šå€ŸåŠ©-Android-Profilerè·å¾—å†…å­˜å¿«ç…§" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šå€ŸåŠ© Android Profilerè·å¾—å†…å­˜å¿«ç…§"></a>ç¬¬ä¸€æ­¥ï¼šå€ŸåŠ© Android Profilerè·å¾—å†…å­˜å¿«ç…§</h4><p>åœ¨æ‰‹æœºéšæœºåˆ‡æ¢,åˆ·æ–°é¢‘é“ï¼Œæ‰“å¼€æ­£æ–‡é¡µï¼Œä½¿ç”¨æœç´¢ç­‰ä¸»è¦åŠŸèƒ½ï¼Œç„¶ååœ¨Android studioé‡Œæ‰“å¼€Android Profiler</p>
<p><img src="https://z3.ax1x.com/2021/06/22/RVRrq0.png" alt="å›¾ç‰‡"></p>
<p>æ‹–åŠ¨é¼ æ ‡é€‰æ‹©æƒ³è¦æŸ¥çœ‹çš„ç‰‡æ®µï¼Œç‚¹å‡»Dump Java Heap</p>
<p><img src="https://z3.ax1x.com/2021/06/22/RVR7dK.png" alt="å›¾ç‰‡"></p>
<p>æˆªæ­¢åˆ°æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å†…å­˜æ³„æ¼çš„ç±»åï¼Œè¿™å’ŒLeakCanaryå¾—åˆ°çš„ä¿¡æ¯æ˜¯ä¸€æ ·çš„</p>
<p>ç‚¹å‡»Export Heap Dump,å°†è¾“å‡ºçš„.HPROFæ–‡ä»¶ä¿å­˜å¥½</p>
<p><img src="https://z3.ax1x.com/2021/06/22/RVOUv6.png" alt="å›¾ç‰‡"></p>
<h4 id="ç¬¬äºŒæ­¥ï¼šå°†å¾—åˆ°çš„å†…å­˜å¿«ç…§å¯¼å…¥Memory-Analyzer-Toolåˆ†æ"><a href="#ç¬¬äºŒæ­¥ï¼šå°†å¾—åˆ°çš„å†…å­˜å¿«ç…§å¯¼å…¥Memory-Analyzer-Toolåˆ†æ" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šå°†å¾—åˆ°çš„å†…å­˜å¿«ç…§å¯¼å…¥Memory Analyzer Toolåˆ†æ"></a>ç¬¬äºŒæ­¥ï¼šå°†å¾—åˆ°çš„å†…å­˜å¿«ç…§å¯¼å…¥Memory Analyzer Toolåˆ†æ</h4><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒMemory Analyzer Toolæ— æ³•ç›´æ¥æ‰“å¼€æˆ‘ä»¬éœ€è¦ä½¿ç”¨SDK platform-tools æŠŠ hprof æ–‡ä»¶è½¬æ¢æˆ MATå·¥å…·å¯è¯†åˆ«çš„æ ¼å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è½¬æ¢matæ ‡å‡†æ–‡ä»¶</span><br><span class="line">å‘½ä»¤ï¼šhprof-conv -z src dst</span><br><span class="line">src  æ˜¯åŸæ–‡ä»¶</span><br><span class="line">dst  æ˜¯éœ€è¦è½¬æ¢æˆçš„æ–‡ä»¶, æ³¨æ„åå­—ä¸€å®šæœ‰ _mat</span><br></pre></td></tr></table></figure>
<p>æˆ‘æ‰§è¡Œçš„å‘½ä»¤ï¼šhprof-conv -z /Users/jiangweihao/Downloads/å†…å­˜æ³„æ¼/2021052601/memory-20210526T154455.hprof memory_mat.hprof</p>
<p>å°±è¿™æ ·åœ¨æŒ‡å®šçš„ç›®å½•é‡ŒæˆåŠŸå¾—åˆ°äº†æˆ‘éœ€è¦çš„memory_mat.hprof</p>
<p>ç„¶ååœ¨Memory Analyzer Toolä¸­æŠŠmemory_mat.hprofæ‰“å¼€</p>
<p><img src="https://z3.ax1x.com/2021/06/22/RVOqx0.png" alt="å›¾ç‰‡"></p>
<p>è¿™æ ·å°±å¾—åˆ°äº†ä¸€å¼ å¤§é¥¼ï¼ŒMATå¾ˆå¼ºå¤§ï¼Œæœ¬æ¬¡ä»»åŠ¡åªå…³æ³¨å†…å­˜æ³„æ¼ï¼Œç›´æ¥ç‚¹å‡»Histogramå³å¯</p>
<p><img src="https://z3.ax1x.com/2021/06/22/RVXZZD.png" alt="å›¾ç‰‡"></p>
<p>åœ¨çº¢æ¡†æ¡†é‡Œæœç´¢æˆ‘ä»¬ä¹‹å‰åœ¨Android studioä¸­è·çŸ¥çš„äº§ç”Ÿå†…å­˜æ³„æ¼çš„ç±»</p>
<p>å°†æ‰€å¾—ç»“æœè¿›è¡Œåˆå¹¶ï¼Œæ’é™¤â€œè½¯â€ã€â€œå¼±â€ã€â€œè™šâ€å¼•ç”¨å¯¹è±¡ï¼Œå³é”®ç‚¹å‡»æœç´¢åˆ°çš„ç»“æœ</p>
<p><img src="https://z3.ax1x.com/2021/06/22/RVXYdg.png" alt="å›¾ç‰‡"></p>
<p>å¯ä»¥æ¯”è¾ƒç›´è§‚åœ°è·çŸ¥å“ªäº›å¯¹è±¡å¼•èµ·çš„å†…å­˜æ³„æ¼ï¼Œè¿™å¯¹äº7000å¤šè¡Œçš„NewsActivityæ¥è¯´å¾ˆé‡è¦</p>
<p><img src="https://z3.ax1x.com/2021/06/22/RVXdWn.png" alt="å›¾ç‰‡"></p>
<p>ä¹‹åå°±æ˜¯é€ä¸€æ’æŸ¥ä¿®æ”¹äº†</p>
<h2 id="åç»­ï¼š"><a href="#åç»­ï¼š" class="headerlink" title="åç»­ï¼š"></a>åç»­ï¼š</h2><p>ä¿®æ”¹æˆæœæ¶‰åŠå…¬å¸éšç§ä¸å®œå±•ç¤ºï¼Œä»…è®°å½•ä¸€ä¸‹è¿‡ç¨‹</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/01/kotlinæ€»ç»“ï¼ˆäºŒï¼‰/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/01/kotlinæ€»ç»“ï¼ˆäºŒï¼‰/" itemprop="url">Kotlinå¼€å‘å­¦ä¹ (äºŒ)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-01T00:00:00+08:00">
                2020-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kotlin/" itemprop="url" rel="index">
                    <span itemprop="name">Kotlin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/01/kotlinæ€»ç»“ï¼ˆäºŒï¼‰/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/01/kotlinæ€»ç»“ï¼ˆäºŒï¼‰/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æ–‡æ¥ä¸Šå›ï¼Œç»§ç»­kotlinå’Œjavaå°±ä½¿ç”¨ä¸Šçš„å·®å¼‚æ€§è¿›è¡Œè®¨è®º</p>
<h2 id="kotlinçš„é›†åˆ"><a href="#kotlinçš„é›†åˆ" class="headerlink" title="kotlinçš„é›†åˆ"></a>kotlinçš„é›†åˆ</h2><h3 id="åªè¯»å’Œå¯å˜"><a href="#åªè¯»å’Œå¯å˜" class="headerlink" title="åªè¯»å’Œå¯å˜"></a>åªè¯»å’Œå¯å˜</h3><p>Kotlin æ ‡å‡†åº“æä¾›äº†åŸºæœ¬é›†åˆç±»å‹çš„å®ç°ï¼š setã€list ä»¥åŠ mapã€‚ ä¸€å¯¹æ¥å£ä»£è¡¨æ¯ç§é›†åˆç±»å‹ï¼š<br>Collection åªè¯» æ¥å£ï¼Œæä¾›è®¿é—®é›†åˆå…ƒç´ çš„æ“ä½œã€‚<br>MutableCollection å¯å˜ æ¥å£ï¼Œé€šè¿‡å†™æ“ä½œæ‰©å±•ç›¸åº”çš„åªè¯»æ¥å£ï¼šæ·»åŠ ã€åˆ é™¤å’Œæ›´æ–°å…¶å…ƒç´ ã€‚</p>
<p><img src="https://s3.ax1x.com/2020/12/02/DI65cD.jpg" alt="å›¾ç‰‡"></p>
<p>å…ˆä¸Šä¸€å¼ å›¾ï¼š</p>
<p>ç®€å•æ¥è¯´ï¼Œç»¿è‰²éƒ¨åˆ†æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ï¼Œå®ç°åªè¯»æ¥å£çš„é›†åˆã€‚<br>è€Œçº¢è‰²éƒ¨åˆ†ï¼Œåˆ™æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ï¼Œå®ç°å¯å˜æ¥å£çš„é›†åˆ</p>
<p>æ³¨æ„ï¼šåªè¯»é›†åˆç±»å‹æ˜¯å‹å˜çš„ã€‚ è¿™æ„å‘³ç€ï¼Œå¦‚æœç±» Rectangle ç»§æ‰¿è‡ª Shapeï¼Œåˆ™å¯ä»¥åœ¨éœ€è¦ List <shape> çš„ä»»ä½•åœ°æ–¹ä½¿ç”¨ List <rectangle>ã€‚<br>     æ¢å¥è¯è¯´ï¼Œé›†åˆç±»å‹ä¸å…ƒç´ ç±»å‹å…·æœ‰ç›¸åŒçš„å­ç±»å‹å…³ç³»ã€‚ map åœ¨å€¼ï¼ˆvalueï¼‰ç±»å‹ä¸Šæ˜¯å‹å˜çš„ï¼Œä½†åœ¨é”®ï¼ˆkeyï¼‰ç±»å‹ä¸Šä¸æ˜¯ã€‚</rectangle></shape></p>
<pre><code>åä¹‹ï¼Œå¯å˜é›†åˆä¸æ˜¯å‹å˜çš„ï¼›å¦åˆ™å°†å¯¼è‡´è¿è¡Œæ—¶æ•…éšœã€‚ å¦‚æœ MutableList &lt;Rectangle&gt; æ˜¯ MutableList &lt;Shape&gt; çš„å­ç±»å‹ï¼Œ
ä½ å¯ä»¥åœ¨å…¶ä¸­æ’å…¥å…¶ä»– Shape çš„ç»§æ‰¿è€…ï¼ˆä¾‹å¦‚ï¼ŒCircleï¼‰ï¼Œä»è€Œè¿åäº†å®ƒçš„ Rectangle ç±»å‹å‚æ•°ã€‚
</code></pre><h3 id="kotlinçš„list"><a href="#kotlinçš„list" class="headerlink" title="kotlinçš„list"></a>kotlinçš„list</h3><p>ä»¥listä¸¾ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//é›†åˆ</span><br><span class="line">   var i = listOf(&quot;å‘¨ä¸€&quot;,&quot;å‘¨äºŒ&quot;,&quot;å‘¨ä¸‰&quot;)</span><br><span class="line">   var j = mutableListOf(&quot;å‘¨ä¸€&quot;,&quot;å‘¨äºŒ&quot;,&quot;å‘¨ä¸‰&quot;)</span><br><span class="line"></span><br><span class="line">   fun lookList()&#123;</span><br><span class="line">       i.size</span><br><span class="line">       i.indexOf(&quot;å‘¨äºŒ&quot;)</span><br><span class="line">       i.add() //æŠ¥é”™</span><br><span class="line">       </span><br><span class="line">       j.size</span><br><span class="line">       j.add(&quot;å‘¨å››&quot;)</span><br><span class="line">       j.remove(&quot;å‘¨å››&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //è¿˜æœ‰å¾ˆå¤šç‰¹æœ‰çš„ï¼Œæ›´æ–¹ä¾¿çš„æ–¹æ³•,å¯ä»¥é€‰æ‹©æ€§æŒæ¡</span><br><span class="line">       val numbers = mutableListOf(1,2,3,4,5,6,7,8,9,10)</span><br><span class="line">       numbers.getOrNull(11) //å¦‚æœæœ‰å°±è¿”å›ï¼Œæ²¡æœ‰å°±è¿”å›null</span><br><span class="line">       numbers.indexOfFirst &#123; it &gt; 2 &#125; //è¿”å›ç¬¬ä¸€ä¸ªå¤§äº2çš„ç´¢å¼•ï¼Œç»“æœä¸º2</span><br><span class="line">       numbers.indexOfLast &#123; it &gt; 2 &#125;  //è¿”å›æœ€åä¸€ä¸ªå¤§äº2çš„ç´¢å¼•</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æŸäº›æ–¹é¢ï¼ŒList ä¸æ•°ç»„ï¼ˆArrayï¼‰éå¸¸ç›¸ä¼¼ã€‚ ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼šæ•°ç»„çš„å¤§å°æ˜¯åœ¨åˆå§‹åŒ–æ—¶å®šä¹‰çš„ï¼Œæ°¸è¿œä¸ä¼šæ”¹å˜; åä¹‹ï¼ŒList æ²¡æœ‰é¢„å®šä¹‰çš„å¤§å°ï¼›ä½œä¸ºå†™æ“ä½œçš„ç»“æœï¼Œå¯ä»¥æ›´æ”¹ List çš„å¤§å°ï¼šæ·»åŠ ï¼Œæ›´æ–°æˆ–åˆ é™¤å…ƒç´ ã€‚</p>
<p>åœ¨ Kotlin ä¸­ï¼ŒList çš„é»˜è®¤å®ç°æ˜¯ ArrayListï¼Œå¯ä»¥å°†å…¶è§†ä¸ºå¯è°ƒæ•´å¤§å°çš„æ•°ç»„ã€‚</p>
<h3 id="æ•°ç»„ä¸é›†åˆçš„æ“ä½œç¬¦"><a href="#æ•°ç»„ä¸é›†åˆçš„æ“ä½œç¬¦" class="headerlink" title="æ•°ç»„ä¸é›†åˆçš„æ“ä½œç¬¦"></a>æ•°ç»„ä¸é›†åˆçš„æ“ä½œç¬¦</h3><p>å…¶å® Kotlin ä¸­ï¼Œè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†è®¸å¤šä½¿æ•°ç»„ä¸é›†åˆæ“ä½œèµ·æ¥æ›´åŠ æ–¹ä¾¿çš„å‡½æ•°ã€‚è¿™éƒ¨åˆ†å’ŒJavaæœ‰æ‰€åŒºåˆ«</p>
<ul>
<li><p>1 filter:å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œè¿‡æ»¤æ“ä½œï¼Œå¦‚æœ lambda è¡¨è¾¾å¼ä¸­çš„æ¡ä»¶æˆç«‹åˆ™ç•™ä¸‹è¯¥å…ƒç´ ï¼Œå¦åˆ™å‰”é™¤ï¼Œæœ€ç»ˆç”Ÿæˆæ–°çš„é›†åˆ</p>
</li>
<li><p>2 mapï¼šéå†æ¯ä¸ªå…ƒç´ å¹¶æ‰§è¡Œç»™å®šè¡¨è¾¾å¼ï¼Œæœ€ç»ˆå½¢æˆæ–°çš„é›†åˆ</p>
</li>
<li><p>3 flatMapï¼šéå†æ¯ä¸ªå…ƒç´ ï¼Œå¹¶ä¸ºæ¯ä¸ªå…ƒç´ åˆ›å»ºæ–°çš„é›†åˆï¼Œæœ€ååˆå¹¶åˆ°ä¸€ä¸ªé›†åˆä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//è¿‡æ»¤æ‰ç­‰äºè¢«2æ•´é™¤çš„å…ƒç´ </span><br><span class="line">val filterList = numbers.filter &#123; i -&gt; i % 2 != 0  &#125;</span><br><span class="line"></span><br><span class="line">//æ¯ä¸ªå…ƒç´ åŠ 1</span><br><span class="line">val mapList = numbers.map &#123; i -&gt; i + 1 &#125;</span><br><span class="line"></span><br><span class="line">//ç”Ÿæˆæ–°é›†åˆ&#123;1,&quot;a&quot;,2,&quot;a&quot;,3,&quot;a&quot;,4,&quot;a&quot;,5,&quot;a&quot;,6,&quot;a&quot;,7,&quot;a&quot;,8,&quot;a&quot;,9,&quot;a&quot;,10,&quot;a&quot;&#125;</span><br><span class="line">val flatMapList = numbers.flatMap &#123; i -&gt; listOf(i,&quot;a&quot; )&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="åç¨‹"><a href="#åç¨‹" class="headerlink" title="åç¨‹"></a>åç¨‹</h2><h3 id="åç¨‹åˆ°åº•æ˜¯å•¥"><a href="#åç¨‹åˆ°åº•æ˜¯å•¥" class="headerlink" title="åç¨‹åˆ°åº•æ˜¯å•¥"></a>åç¨‹åˆ°åº•æ˜¯å•¥</h3><p>å°±æ˜¯kotlinå°è£…çš„ï¼Œä¾¿äºæˆ‘ä»¬ä½¿ç”¨çº¿ç¨‹çš„api,æœ¬è´¨ä¸Šå’ŒJavaçš„çº¿ç¨‹æ± ï¼Œandroidçš„AsyncTaskä¸€æ ·<br>åŒæ ·æˆ‘ä»¬åœ¨kotlinä¸­åŒæ ·å¯ä»¥ä½¿ç”¨è¿™äº›æ¥å¤„ç†æˆ‘ä»¬çš„å¹¶å‘æ“ä½œ,å®Œå…¨æ”¯æŒ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">fun lookThread()&#123;</span><br><span class="line">        //java çº¿ç¨‹æ± </span><br><span class="line">        val executor = Executors.newCachedThreadPool()</span><br><span class="line">        executor.execute &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        //Android AsyncTask</span><br><span class="line">        //å¯è§MyAsyncTask</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class MyAsyncTask constructor(context: Context):AsyncTask&lt;String, String, String&gt;()&#123;</span><br><span class="line">        override fun doInBackground(vararg params: String?): String &#123;</span><br><span class="line">            TODO(&quot;Not yet implemented&quot;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun onProgressUpdate(vararg values: String?) &#123;</span><br><span class="line">            super.onProgressUpdate(*values)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun onPostExecute(result: String?) &#123;</span><br><span class="line">            super.onPostExecute(result)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="åç¨‹æ€ä¹ˆç”¨"><a href="#åç¨‹æ€ä¹ˆç”¨" class="headerlink" title="åç¨‹æ€ä¹ˆç”¨"></a>åç¨‹æ€ä¹ˆç”¨</h3><h4 id="å£°æ˜åç¨‹çš„å‡ ç§æ–¹å¼"><a href="#å£°æ˜åç¨‹çš„å‡ ç§æ–¹å¼" class="headerlink" title="å£°æ˜åç¨‹çš„å‡ ç§æ–¹å¼"></a>å£°æ˜åç¨‹çš„å‡ ç§æ–¹å¼</h4><p>ä¸‹é¢åˆ—ä¸¾äº†åç¨‹çš„ä¸‰ç§ä½¿ç”¨æ–¹æ³•å’Œä½¿ç”¨javaå†™ç›¸åŒä»£ç çš„æ¡ˆä¾‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">fun lookCoroutine() &#123;</span><br><span class="line">       /**</span><br><span class="line">        * æ–¹æ³•ä¸€é€šå¸¸é€‚ç”¨äºå•å…ƒæµ‹è¯•çš„åœºæ™¯ï¼Œè€Œä¸šåŠ¡å¼€å‘ä¸­ä¸ä¼šç”¨åˆ°è¿™ç§æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯çº¿ç¨‹é˜»å¡çš„ã€‚</span><br><span class="line">        */</span><br><span class="line">       runBlocking &#123;</span><br><span class="line">           // ç½‘ç»œè¯·æ±‚ï¼ˆIO çº¿ç¨‹</span><br><span class="line">           val list = getData()</span><br><span class="line">           // æ›´æ–° UIï¼ˆä¸»çº¿ç¨‹ï¼‰</span><br><span class="line">           //nameTv.text = list[0]</span><br><span class="line">       &#125;</span><br><span class="line">       /**</span><br><span class="line">        * æ–¹æ³•äºŒå’Œä½¿ç”¨ runBlocking çš„åŒºåˆ«åœ¨äºä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚</span><br><span class="line">        * ä½†åœ¨ Android å¼€å‘ä¸­åŒæ ·ä¸æ¨èè¿™ç§ç”¨æ³•ï¼Œå› ä¸ºå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¼šå’Œ app ä¸€è‡´ï¼Œä¸”ä¸èƒ½å–æ¶ˆ</span><br><span class="line">        */</span><br><span class="line">       GlobalScope.launch &#123;</span><br><span class="line">           // ç½‘ç»œè¯·æ±‚ï¼ˆIO çº¿ç¨‹)</span><br><span class="line">           val list = getData()</span><br><span class="line">           // æ›´æ–° UIï¼ˆä¸»çº¿ç¨‹ï¼‰</span><br><span class="line">           //nameTv.text = list[0]</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       /**</span><br><span class="line">        * æ–¹æ³•ä¸‰æ˜¯æ¯”è¾ƒæ¨èçš„ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ context å‚æ•°å»ç®¡ç†å’Œæ§åˆ¶åç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">        * ï¼ˆè¿™é‡Œçš„ context å’Œ Android é‡Œçš„ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œæ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æ¦‚å¿µï¼Œä¼šæœ‰ä¸€ä¸ª Android å¹³å°çš„å°è£…æ¥é…åˆä½¿ç”¨ï¼‰</span><br><span class="line">        */</span><br><span class="line">       val coroutineScope = CoroutineScope(constext)</span><br><span class="line">       coroutineScope.launch(Dispatchers.Main) &#123;</span><br><span class="line">           // ç½‘ç»œè¯·æ±‚ï¼ˆIO çº¿ç¨‹)</span><br><span class="line">           val list = getData()</span><br><span class="line">           //ä¸»çº¿ç¨‹æ›´æ–° UI</span><br><span class="line">           //nameTv.text = list[0]</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       /**</span><br><span class="line">        * javaå®ç°ä¸Šè¿°åŠŸèƒ½</span><br><span class="line">        */</span><br><span class="line">       /*</span><br><span class="line">    getData(new Callback&lt;User&gt;() &#123;</span><br><span class="line">       @Override</span><br><span class="line">       public void success(List list) &#123;</span><br><span class="line">           runOnUiThread(new Runnable() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               public void run() &#123;</span><br><span class="line">                   nameTv.setText(list[0]);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void failure(Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">        */</span><br><span class="line">    /**</span><br><span class="line">        * é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰asyncï¼Œç”¨äºå¹¶å‘æ“ä½œ</span><br><span class="line">        */</span><br><span class="line">       val timeOne = measureTimeMillis &#123;</span><br><span class="line">           val one = doSomethingUsefulOne()</span><br><span class="line">           val two = doSomethingUsefulTwo()</span><br><span class="line">           println(&quot;The answer is $&#123;one + two&#125;&quot;)</span><br><span class="line">       &#125;</span><br><span class="line">       println(&quot;Completed in $timeOne ms&quot;)</span><br><span class="line">       //The answer is 42</span><br><span class="line">       //Completed in 2017 ms</span><br><span class="line"></span><br><span class="line">       val timeTwo = measureTimeMillis &#123;</span><br><span class="line">           val one = CoroutineScope(constext).async &#123; doSomethingUsefulOne() &#125;</span><br><span class="line">           val two = CoroutineScope(constext).async &#123; doSomethingUsefulTwo() &#125;</span><br><span class="line">           println(&quot;The answer is $&#123;one.await() + two.await()&#125;&quot;)</span><br><span class="line">       &#125;</span><br><span class="line">       println(&quot;Completed in $timeTwo ms&quot;)</span><br><span class="line">       //The answer is 42</span><br><span class="line">       //Completed in 1017 ms</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   //å‡è®¾å®ƒæ˜¯ç½‘ç»œè¯·æ±‚æ–¹æ³•</span><br><span class="line">   private fun getData() = ArrayList&lt;String&gt;()</span><br></pre></td></tr></table></figure>
<h4 id="æœ‰äº›ä¸šåŠ¡åœºæ™¯åç¨‹æ›´é€‚åˆ"><a href="#æœ‰äº›ä¸šåŠ¡åœºæ™¯åç¨‹æ›´é€‚åˆ" class="headerlink" title="æœ‰äº›ä¸šåŠ¡åœºæ™¯åç¨‹æ›´é€‚åˆ"></a>æœ‰äº›ä¸šåŠ¡åœºæ™¯åç¨‹æ›´é€‚åˆ</h4><p>é™¤äº†æ¶ˆé™¤å›è°ƒï¼Œè¿˜æœ‰å¾ˆå¤šåœºæ™¯åç¨‹æ˜¾å¾—æ›´åŠ æ–¹ä¾¿ï¼Œæ¯”å¦‚é‡åˆ°çš„åœºæ™¯æ˜¯å¤šä¸ªç½‘ç»œè¯·æ±‚éœ€è¦ç­‰å¾…æ‰€æœ‰è¯·æ±‚ç»“æŸä¹‹åå†å¯¹ UI è¿›è¡Œæ›´æ–°ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//æ¯”å¦‚è¿™ä¸¤ä¸ªè¯·æ±‚</span><br><span class="line">api.getAvatar(user, callback)</span><br><span class="line">api.getCompanyLogo(user, callback)</span><br></pre></td></tr></table></figure></p>
<p>é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šè¦æ±‚åç«¯åªç»™ä¸€ä¸ªå€Ÿå£ï¼Œå®åœ¨æä¸å®šå°±å†™æˆä¸²è¡Œè¯·æ±‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">api.getAvatar(user) &#123; avatar -&gt;</span><br><span class="line">    api.getCompanyLogo(user) &#123; logo -&gt;</span><br><span class="line">        show(merge(avatar, logo))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è€Œå¦‚æœä½¿ç”¨åç¨‹ï¼Œå®ƒå¯ä»¥è¿™æ ·å†™å¹¶è¡Œè¯·æ±‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">coroutineScope.launch(Dispatchers.Main) &#123;</span><br><span class="line">    //            ğŸ‘‡  async å‡½æ•°ä¹‹åå†è®²</span><br><span class="line">    val avatar = async &#123; api.getAvatar(user) &#125;    // è·å–ç”¨æˆ·å¤´åƒ</span><br><span class="line">    val logo = async &#123; api.getCompanyLogo(user) &#125; // è·å–ç”¨æˆ·æ‰€åœ¨å…¬å¸çš„ logo</span><br><span class="line">    val merged = suspendingMerge(avatar, logo)    // åˆå¹¶ç»“æœ</span><br><span class="line">    //                  ğŸ‘†</span><br><span class="line">    show(merged) // æ›´æ–° UI</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="æ›´è½»æ¾å†™æ„çš„çº¿ç¨‹åˆ‡æ¢"><a href="#æ›´è½»æ¾å†™æ„çš„çº¿ç¨‹åˆ‡æ¢" class="headerlink" title="æ›´è½»æ¾å†™æ„çš„çº¿ç¨‹åˆ‡æ¢"></a>æ›´è½»æ¾å†™æ„çš„çº¿ç¨‹åˆ‡æ¢</h4><p>å¦‚æœåªæ˜¯ä½¿ç”¨ launch å‡½æ•°ï¼Œåç¨‹å¹¶ä¸èƒ½æ¯”çº¿ç¨‹åšæ›´å¤šçš„äº‹ã€‚ä¸è¿‡åç¨‹ä¸­å´æœ‰ä¸€ä¸ªå¾ˆå®ç”¨çš„å‡½æ•°ï¼šwithContext ã€‚<br>è¿™ä¸ªå‡½æ•°å¯ä»¥åˆ‡æ¢åˆ°æŒ‡å®šçš„çº¿ç¨‹ï¼Œå¹¶åœ¨é—­åŒ…å†…çš„é€»è¾‘æ‰§è¡Œç»“æŸä¹‹åï¼Œè‡ªåŠ¨æŠŠçº¿ç¨‹åˆ‡å›å»ç»§ç»­æ‰§è¡Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//å‡è®¾å®ƒæ˜¯ç½‘ç»œè¯·æ±‚æ–¹æ³•</span><br><span class="line">   private fun getData() = ArrayList&lt;String&gt;()</span><br><span class="line">//çº¿ç¨‹åˆ‡æ¢</span><br><span class="line">   fun lookSwitchOne()&#123;</span><br><span class="line">       CoroutineScope(constext).launch(Dispatchers.Main) &#123;</span><br><span class="line"></span><br><span class="line">           val listOne = withContext(Dispatchers.IO) &#123;</span><br><span class="line">               getData()</span><br><span class="line">           &#125;</span><br><span class="line">           val listTwo = withContext(Dispatchers.IO) &#123;</span><br><span class="line">               getData()</span><br><span class="line">           &#125;</span><br><span class="line">           //nameTv.text = listOne[0] + listTwo[0]</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="åç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹å—ï¼Ÿ"><a href="#åç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹å—ï¼Ÿ" class="headerlink" title="åç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹å—ï¼Ÿ"></a>åç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹å—ï¼Ÿ</h3><p>ä¸Šé¢çš„ä»£ç ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fun lookSwitchTwo()&#123;</span><br><span class="line">        CoroutineScope(constext).launch(Dispatchers.Main) &#123;</span><br><span class="line">            val listOne = getDataList()</span><br><span class="line">            val listTwo = getDataList()</span><br><span class="line">            //nameTv.text = listOne[0] + listTwo[0]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //æ”¹é€ åçš„ç½‘ç»œè¯·æ±‚æ–¹æ³•</span><br><span class="line">    suspend fun getDataList() = withContext(Dispatchers.IO)&#123;</span><br><span class="line">        getData()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<pre><code>suspendåˆæ˜¯å•¥ç©æ„å„¿ï¼Ÿ
</code></pre><h4 id="æŒ‚èµ·"><a href="#æŒ‚èµ·" class="headerlink" title="æŒ‚èµ·"></a>æŒ‚èµ·</h4><p>å«ä¹‰ï¼š** ä»å½“å‰çº¿ç¨‹æŒ‚èµ·ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯è¿™ä¸ªåç¨‹ä»æ­£åœ¨æ‰§è¡Œå®ƒçš„çº¿ç¨‹ä¸Šè„±ç¦»ã€‚</p>
<p>æ³¨æ„ï¼Œä¸æ˜¯è¿™ä¸ªåç¨‹åœä¸‹æ¥äº†ï¼æ˜¯è„±ç¦»ï¼Œå½“å‰çº¿ç¨‹ä¸å†ç®¡è¿™ä¸ªåç¨‹è¦å»åšä»€ä¹ˆäº†ã€‚</p>
<p>suspend æ˜¯æœ‰æš‚åœçš„æ„æ€ï¼Œä½†æˆ‘ä»¬åœ¨åç¨‹ä¸­åº”è¯¥ç†è§£ä¸ºï¼šå½“çº¿ç¨‹æ‰§è¡Œåˆ°åç¨‹çš„ suspend å‡½æ•°çš„æ—¶å€™ï¼Œå°±æš‚æ—¶ä¸å†æ‰§è¡Œå‰©ä½™çš„åç¨‹ä»£ç ï¼Œè·³å‡ºåç¨‹çš„ä»£ç å—ã€‚**</p>
<p>é‚£ä¹ˆä»æ­¤æ—¶å¼€å§‹ï¼Œå…µåˆ†ä¸¤è·¯ï¼Œçº¿ç¨‹å»åšå®ƒåŸæœ¬çš„å·¥ä½œï¼Œè‹¥æ˜¯åå°çº¿ç¨‹å°±æ‰§è¡Œå…¶ä»–ä»»åŠ¡æˆ–ç­‰å¾…å›æ”¶ï¼Œè‹¥ä¸ºä¸»çº¿ç¨‹å°±åˆ·æ–°å±å¹•ã€‚</p>
<p>è€Œåç¨‹å‘¢ï¼Œæ¥ä¸‹æ¥åç¨‹ä¼šä»è¿™ä¸ª suspend å‡½æ•°å¼€å§‹ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œä¸è¿‡æ˜¯åœ¨æŒ‡å®šçš„çº¿ç¨‹ã€‚</p>
<p>è°æŒ‡å®šçš„ï¼Ÿæ˜¯ suspend å‡½æ•°æŒ‡å®šçš„ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°å†…éƒ¨çš„ withContext ä¼ å…¥çš„ Dispatchers.IO æ‰€æŒ‡å®šçš„ IO çº¿ç¨‹ã€‚</p>
<ul>
<li>Dispatchers è°ƒåº¦å™¨<blockquote>
<p>å®ƒå¯ä»¥å°†åç¨‹é™åˆ¶åœ¨ä¸€ä¸ªç‰¹å®šçš„çº¿ç¨‹æ‰§è¡Œï¼Œæˆ–è€…å°†å®ƒåˆ†æ´¾åˆ°ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæˆ–è€…è®©å®ƒä¸å—é™åˆ¶åœ°è¿è¡Œã€‚<br>é‚£æˆ‘ä»¬å¹³æ—¥é‡Œå¸¸ç”¨åˆ°çš„è°ƒåº¦å™¨æœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li>å¸¸ç”¨çš„ Dispatchers ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§ï¼š<br>Dispatchers.Mainï¼šAndroid ä¸­çš„ä¸»çº¿ç¨‹<br>Dispatchers.IOï¼šé’ˆå¯¹ç£ç›˜å’Œç½‘ç»œ IO è¿›è¡Œäº†ä¼˜åŒ–ï¼Œé€‚åˆ IO å¯†é›†å‹çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼šè¯»å†™æ–‡ä»¶ï¼Œæ“ä½œæ•°æ®åº“ä»¥åŠç½‘ç»œè¯·æ±‚<br>Dispatchers.Defaultï¼šé€‚åˆ CPU å¯†é›†å‹çš„ä»»åŠ¡ï¼Œæ¯”å¦‚è®¡ç®—</li>
</ul>
</blockquote>
</li>
</ul>
<p>å›åˆ°æˆ‘ä»¬çš„åç¨‹ï¼Œå®ƒä» suspend å‡½æ•°å¼€å§‹è„±ç¦»å¯åŠ¨å®ƒçš„çº¿ç¨‹ï¼Œç»§ç»­æ‰§è¡Œåœ¨ Dispatchers æ‰€æŒ‡å®šçš„ IO çº¿ç¨‹ã€‚</p>
<p>ç´§æ¥ç€åœ¨ suspend å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åï¼Œåç¨‹ä¸ºæˆ‘ä»¬åšçš„æœ€çˆ½çš„äº‹å°±æ¥äº†ï¼šä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æŠŠçº¿ç¨‹å†åˆ‡å›æ¥ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„åç¨‹åŸæœ¬æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹çš„ï¼Œå½“ä»£ç é‡åˆ° suspend å‡½æ•°çš„æ—¶å€™ï¼Œå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œæ ¹æ® Dispatchers åˆ‡æ¢åˆ°äº† IO çº¿ç¨‹ï¼›</p>
<p>å½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçº¿ç¨‹åˆåˆ‡äº†å›æ¥ï¼Œã€Œåˆ‡å›æ¥ã€ä¹Ÿå°±æ˜¯åç¨‹ä¼šå¸®æˆ‘å† post ä¸€ä¸ª Runnableï¼Œè®©æˆ‘å‰©ä¸‹çš„ä»£ç ç»§ç»­å›åˆ°ä¸»çº¿ç¨‹å»æ‰§è¡Œã€‚</p>
<p>ç°åœ¨å¯ä»¥è§£é‡Šsuspendäº†ï¼šåç¨‹åœ¨æ‰§è¡Œåˆ°æœ‰ suspend æ ‡è®°çš„å‡½æ•°çš„æ—¶å€™ï¼Œä¼šè¢« suspend ä¹Ÿå°±æ˜¯è¢«æŒ‚èµ·ï¼Œè€Œæ‰€è°“çš„è¢«æŒ‚èµ·ï¼Œå°±æ˜¯åˆ‡ä¸ªçº¿ç¨‹ï¼›</p>
<p>ä¸è¿‡åŒºåˆ«åœ¨äºï¼ŒæŒ‚èµ·å‡½æ•°åœ¨æ‰§è¡Œå®Œæˆä¹‹åï¼Œåç¨‹ä¼šé‡æ–°åˆ‡å›å®ƒåŸå…ˆçš„çº¿ç¨‹ã€‚è€ŒæŒ‚èµ·ï¼Œæ˜¯é withContextå‡½æ•°ï¼Œåªå†™suspendè€Œæ²¡æœ‰withContextå‡½æ•°çš„è¯ï¼Œ</p>
<p>ç¼–è¯‘å™¨ä¼šç»™å‡ºâ€œredundant suspend modifierâ€ï¼Œå‘Šè¯‰ä½ è¿™ä¸ª suspend æ˜¯å¤šä½™çš„ã€‚å› æ­¤suspendåªæ˜¯ç”¨æ¥æé†’å¼€å‘è€…çš„ï¼Œ</p>
<p>è¿™æ˜¯ä¸€ä¸ªæŒ‚èµ·å‡½æ•°ï¼Œè€Œç”±äºæŒ‚èµ·éœ€è¦åˆ‡å›æ¥ï¼Œæ‰€ä»¥æŒ‚èµ·å‡½æ•°å¿…é¡»åœ¨åç¨‹æˆ–è€…å¦ä¸€ä¸ªæŒ‚èµ·å‡½æ•°é‡Œè¢«è°ƒç”¨ã€‚</p>
<p>å†ç®€å•æ¥è®²ï¼Œåœ¨ Kotlin ä¸­æ‰€è°“çš„æŒ‚èµ·ï¼Œå°±æ˜¯ä¸€ä¸ªç¨åä¼šè¢«è‡ªåŠ¨åˆ‡å›æ¥çš„çº¿ç¨‹è°ƒåº¦æ“ä½œã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/06/okhttpæºç åˆ†æ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/06/okhttpæºç åˆ†æ/" itemprop="url">OKhttpæºç åˆ†æ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-03-06T00:00:00+08:00">
                2020-03-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/06/okhttpæºç åˆ†æ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/06/okhttpæºç åˆ†æ/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="OKhttpåŸºæœ¬ä½¿ç”¨"><a href="#OKhttpåŸºæœ¬ä½¿ç”¨" class="headerlink" title="OKhttpåŸºæœ¬ä½¿ç”¨"></a>OKhttpåŸºæœ¬ä½¿ç”¨</h2><p>è¿™é‡Œä»¥getå¼‚æ­¥è¯·æ±‚ä¸ºä¾‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//åˆ›å»ºokHttpClientå¯¹è±¡</span><br><span class="line">OkHttpClient mOkHttpClient = new OkHttpClient();</span><br><span class="line">//åˆ›å»ºä¸€ä¸ªRequest</span><br><span class="line">final Request request = new Request.Builder()</span><br><span class="line">                .url(&quot;https://baidu.com&quot;)</span><br><span class="line">                .build();</span><br><span class="line">//new call</span><br><span class="line">Call call = mOkHttpClient.newCall(request); </span><br><span class="line">//è¯·æ±‚åŠ å…¥è°ƒåº¦</span><br><span class="line">call.enqueue(new Callback()</span><br><span class="line">        &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(Request request, IOException e)</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onResponse(final Response response) throws IOException</span><br><span class="line">            &#123;</span><br><span class="line">                    //String htmlStr =  response.body().string();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="ä¸‰ä¸ªé˜Ÿåˆ—"><a href="#ä¸‰ä¸ªé˜Ÿåˆ—" class="headerlink" title="ä¸‰ä¸ªé˜Ÿåˆ—"></a>ä¸‰ä¸ªé˜Ÿåˆ—</h3><p>åˆ›å»ºOkHttpClientå’ŒRequestéƒ½ç”¨åˆ°äº†å»ºé€ è€…æ¨¡å¼ï¼Œæ¥é…ç½®åˆå§‹åŒ–å‚æ•°å’Œè®¾ç½®å‚æ•°<br>mOkHttpClient.newCall(request)ï¼Œå®é™…è°ƒç”¨äº†RealCall,åœ¨RealCallä¸­ç”¨äº†å·¥å‚æ¨¡å¼<br>æˆ‘ä»¬è·Ÿè¿›enqueue()<br>ä¸‹é¢ä»£ç æ˜¯enqueueï¼ˆï¼‰åœ¨RealCallä¸­çš„å®ç°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override public void enqueue(Callback responseCallback) &#123;</span><br><span class="line">  //1.çœ‹ä¸‹å¤´</span><br><span class="line">  synchronized (this) &#123;</span><br><span class="line">    if (executed) throw new IllegalStateException(&quot;Already Executed&quot;);</span><br><span class="line">    executed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  //åŠ å…¥äº†ä¸€ä¸ªç”¨äºè¿½è¸ªå †æ ˆä¿¡æ¯çš„callStackTrace</span><br><span class="line">  captureCallStackTrace();</span><br><span class="line">  eventListener.callStart(this);</span><br><span class="line">  //2.çœ‹ä¸‹å¤´</span><br><span class="line">  client.dispatcher().enqueue(new AsyncCall(responseCallback));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>1 é¦–å…ˆåˆ©ç”¨synchronizedåŠ å…¥äº†å¯¹è±¡é”ï¼Œé˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œè¿™é‡Œå…ˆåˆ¤æ–­ä¸€ä¸‹executedæ˜¯å¦ä¸ºtrueåˆ¤æ–­å½“å‰callæ˜¯å¦è¢«æ‰§è¡Œäº†ï¼Œå¦‚æœä¸ºtureï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œæ²¡æœ‰åˆ™è®¾ç½®ä¸ºtrueï¼Œè¿™æ„å‘³ç€callè¯·æ±‚åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚</li>
<li>2 è·Ÿè¿›client.dispatcher().enqueue(new AsyncCall(responseCallback))æ–¹æ³•<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public final class Dispatcher &#123;</span><br><span class="line">  //çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°</span><br><span class="line">  private int maxRequests = 64;</span><br><span class="line">  //æ¯ä¸ªä¸»æœºæœ€å¤§è¯·æ±‚æ•°</span><br><span class="line">  private int maxRequestsPerHost = 5;</span><br><span class="line">  private @Nullable Runnable idleCallback;</span><br><span class="line"></span><br><span class="line">  /** Executes calls. Created lazily. */</span><br><span class="line">  private @Nullable ExecutorService executorService;</span><br><span class="line"></span><br><span class="line">  /** Ready async calls in the order they&apos;ll be run. */</span><br><span class="line">  private final Deque&lt;AsyncCall&gt; readyAsyncCalls = new ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  /** Running asynchronous calls. Includes canceled calls that haven&apos;t finished yet. */</span><br><span class="line">  private final Deque&lt;AsyncCall&gt; runningAsyncCalls = new ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  /** Running synchronous calls. Includes canceled calls that haven&apos;t finished yet. */</span><br><span class="line">  private final Deque&lt;RealCall&gt; runningSyncCalls = new ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  //ä¸­é—´çœç•¥äº†å¾ˆå¤šéå¿…è¦ä»£ç </span><br><span class="line"></span><br><span class="line">  synchronized void enqueue(AsyncCall call) &#123;</span><br><span class="line">      if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">        runningAsyncCalls.add(call);</span><br><span class="line">        executorService().execute(call);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        readyAsyncCalls.add(call);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œç”¨ä¸‰ä¸ªé˜Ÿåˆ—ArrayDequeç”¨äºä¿å­˜Callå¯¹è±¡ï¼Œåˆ†ä¸ºä¸‰ç§çŠ¶æ€å¼‚æ­¥ç­‰å¾…,å¼‚æ­¥running,åŒæ­¥runningã€‚<br>å½“æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥é˜Ÿåˆ—ä¸ªæ•°å°äºmaxRequest(64)å¹¶ä¸”è¯·æ±‚åŒä¸€ä¸ªä¸»æœºçš„ä¸ªæ•°å°äºmaxRequestsPerHost(5)æ—¶ï¼Œåˆ™å°†è¿™ä¸ªè¯·æ±‚åŠ å…¥å¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—runningAsyncCallï¼Œå¹¶ç”¨çº¿ç¨‹æ± æ‰§è¡Œexecuteï¼ˆï¼‰ï¼Œå¦åˆ™åŠ å…¥å¼‚æ­¥ç­‰å¾…é˜Ÿåˆ—ã€‚<br>è¿™é‡Œçœ‹ä¸€ä¸‹çº¿ç¨‹æ± <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public synchronized ExecutorService executorService() &#123;</span><br><span class="line">   if (executorService == null) &#123;</span><br><span class="line">     //</span><br><span class="line">     executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS,</span><br><span class="line">         new SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false));</span><br><span class="line">   &#125;</span><br><span class="line">   return executorService;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>corePoolSize    æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ï¼Œå¦‚æœæ˜¯0çš„è¯ï¼Œç©ºé—²ä¸€æ®µæ—¶é—´åæ‰€æœ‰çº¿ç¨‹å°†å…¨éƒ¨è¢«é”€æ¯</li>
<li>maximumPoolSize æœ€å¤§çº¿ç¨‹æ± å¤§å°ï¼Œå½“ä»»åŠ¡è¿›æ¥æ—¶å¯ä»¥æ‰©å……çš„çº¿ç¨‹æœ€å¤§å€¼ï¼Œå½“å¤§äºäº†è¿™ä¸ªå€¼å°±ä¼šæ ¹æ®ä¸¢å¼ƒå¤„ç†æœºåˆ¶æ¥å¤„ç†</li>
<li>keepAliveTime   çº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œå½“çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´</li>
<li>unit            æ—¶é—´å•ä½</li>
<li>workQueue       çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—</li>
<li>threadFactory   çº¿ç¨‹åˆ›å»ºå·¥å‚</li>
</ul>
<p>åˆ«å¿˜äº†çœ‹çœ‹AsyncCall</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">final class AsyncCall extends NamedRunnable &#123;</span><br><span class="line">  private final Callback responseCallback;</span><br><span class="line"></span><br><span class="line">  AsyncCall(Callback responseCallback) &#123;</span><br><span class="line">    super(&quot;OkHttp %s&quot;, redactedUrl());</span><br><span class="line">    this.responseCallback = responseCallback;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">  ......</span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  @Override protected void execute() &#123;</span><br><span class="line">    boolean signalledCallback = false;</span><br><span class="line">    try &#123;</span><br><span class="line">    </span><br><span class="line">      //&apos;1. æˆ‘ä»¬å¯ä»¥å‘ç°æœ€åçº¿ç¨‹æ± æ‰§è¡Œçš„ä»»åŠ¡å°±æ˜¯getResponseWithInterceptorChainæ–¹æ³•&apos;</span><br><span class="line">      Response response = getResponseWithInterceptorChain();</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      if (retryAndFollowUpInterceptor.isCanceled()) &#123;</span><br><span class="line">        signalledCallback = true;</span><br><span class="line">        responseCallback.onFailure(RealCall.this, new IOException(&quot;Canceled&quot;));</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        signalledCallback = true;</span><br><span class="line">        responseCallback.onResponse(RealCall.this, response);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      if (signalledCallback) &#123;</span><br><span class="line">        // Do not signal the callback twice!</span><br><span class="line">        Platform.get().log(INFO, &quot;Callback failure for &quot; + toLoggableString(), e);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        eventListener.callFailed(RealCall.this, e);</span><br><span class="line">        responseCallback.onFailure(RealCall.this, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      //&apos;2. æœ€åå†ä»Dispatcheré‡Œé¢çš„å¼‚æ­¥é˜Ÿåˆ—ä¸­ç§»é™¤&apos;</span><br><span class="line">      client.dispatcher().finished(this);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ç®¡æ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼Œéƒ½æ˜¯ä¸€æ ·çš„:</p>
<ul>
<li>1 åŠ å…¥åˆ°Dispatcheré‡Œé¢çš„åŒæ­¥(æˆ–å¼‚æ­¥)é˜Ÿåˆ—</li>
<li>2 æ‰§è¡ŒgetResponseWithInterceptorChainæ–¹æ³•</li>
<li>3 ä»Dispatcheré‡Œé¢çš„åŒæ­¥(æˆ–å¼‚æ­¥)é˜Ÿåˆ—ç§»é™¤ã€‚ï¼ˆåªä¸è¿‡åŒæ­¥æ“ä½œæ˜¯ç›´æ¥è¿è¡Œäº†getResponseWithInterceptorChainæ–¹æ³•ï¼Œè€Œå¼‚æ­¥æ˜¯é€šè¿‡çº¿ç¨‹æ± æ‰§è¡ŒRunnableå†å»æ‰§è¡ŒgetResponseWithInterceptorChainæ–¹æ³•ï¼‰</li>
</ul>
<h3 id="å‡ ä¸ªæ‹¦æˆªå™¨"><a href="#å‡ ä¸ªæ‹¦æˆªå™¨" class="headerlink" title="å‡ ä¸ªæ‹¦æˆªå™¨"></a>å‡ ä¸ªæ‹¦æˆªå™¨</h3><p>é‚£å°±çœ‹çœ‹getResponseWithInterceptorChain<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Response getResponseWithInterceptorChain() throws IOException &#123;</span><br><span class="line">  // Build a full stack of interceptors.</span><br><span class="line">  //&apos;1. åˆ›å»ºä¸€ä¸ªæ‹¦æˆªå™¨List&apos;</span><br><span class="line">  List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;();</span><br><span class="line">  //&apos;2. æ·»åŠ ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„åº”ç”¨æ‹¦æˆªå™¨&apos;</span><br><span class="line">  interceptors.addAll(client.interceptors());</span><br><span class="line">  //&apos;3. æ·»åŠ é‡è¯•ä¸é‡å®šå‘æ‹¦æˆªå™¨&apos;</span><br><span class="line">  interceptors.add(retryAndFollowUpInterceptor);</span><br><span class="line">  //&apos;4. æ·»åŠ å†…å®¹æ‹¦æˆªå™¨&apos;</span><br><span class="line">  interceptors.add(new BridgeInterceptor(client.cookieJar()));</span><br><span class="line">  //&apos;4. æ·»åŠ ç¼“å­˜æ‹¦æˆªå™¨&apos;</span><br><span class="line">  interceptors.add(new CacheInterceptor(client.internalCache()));</span><br><span class="line">  /&apos;5. æ·»åŠ è¿æ¥æ‹¦æˆªå™¨&apos;</span><br><span class="line">  interceptors.add(new ConnectInterceptor(client));</span><br><span class="line">  if (!forWebSocket) &#123;</span><br><span class="line">    //&apos;6. æ·»åŠ ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„ç½‘ç»œæ‹¦æˆªå™¨&apos;</span><br><span class="line">    interceptors.addAll(client.networkInterceptors());</span><br><span class="line">  &#125;</span><br><span class="line">  //&apos;7. æ·»åŠ è¯·æ±‚æœåŠ¡æ‹¦æˆªå™¨&apos;</span><br><span class="line">  interceptors.add(new CallServerInterceptor(forWebSocket));</span><br><span class="line"></span><br><span class="line">  //&apos;8.æŠŠè¿™äº›æ‹¦æˆªå™¨ä»¬ä¸€èµ·å°è£…åœ¨ä¸€ä¸ªæ‹¦æˆªå™¨é“¾æ¡ä¸Šé¢(RealInterceptorChain)&apos;</span><br><span class="line">  Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0,</span><br><span class="line">      originalRequest, this, eventListener, client.connectTimeoutMillis(),</span><br><span class="line">      client.readTimeoutMillis(), client.writeTimeoutMillis());</span><br><span class="line">  </span><br><span class="line">  //&apos;9.ç„¶åæ‰§è¡Œé“¾æ¡çš„proceedæ–¹æ³•&apos;</span><br><span class="line">  return chain.proceed(originalRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æœ€åä¼šèµ°åˆ°8å’Œ9ï¼Œåˆ›å»ºäº†ä¸€ä¸ªRealInterceptorChainï¼Œå¹¶è°ƒç”¨äº†proceedæ–¹æ³•ï¼Œè¿™é‡Œæ³¨æ„ä¸€ä¸‹0è¿™ä¸ªå‚æ•°ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public final class RealInterceptorChain implements Interceptor.Chain &#123;</span><br><span class="line">   </span><br><span class="line">   //&apos;æˆ‘ä»¬åˆšæ‰å»ºç«‹çš„æ”¾æ‹¦æˆªå™¨çš„é˜Ÿåˆ—&apos;</span><br><span class="line">   private final List&lt;Interceptor&gt; interceptors;</span><br><span class="line">   //&apos;å½“å‰æ‰§è¡Œçš„ç¬¬å‡ ä¸ªæ‹¦æˆªå™¨åºå·&apos;</span><br><span class="line">   private final int index;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">public Response proceed(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,</span><br><span class="line">     RealConnection connection) throws IOException &#123;</span><br><span class="line">   if (index &gt;= interceptors.size()) throw new AssertionError();</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">   //&apos;å®ä¾‹åŒ–äº†ä¸€ä¸ªæ–°çš„RealInterceptorChainå¯¹è±¡ï¼Œå¹¶ä¸”ä¼ å…¥ç›¸åŒçš„æ‹¦æˆªå™¨Listï¼Œåªä¸è¿‡ä¼ å…¥çš„indexå€¼+1&apos;</span><br><span class="line">   RealInterceptorChain next = new RealInterceptorChain(interceptors, streamAllocation, httpCodec,</span><br><span class="line">       connection, index + 1, request, call, eventListener, connectTimeout, readTimeout,</span><br><span class="line">       writeTimeout);</span><br><span class="line">   //&apos;è·å–å½“å‰indexå¯¹åº”çš„æ‹¦æˆªå™¨é‡Œé¢çš„å…·ä½“çš„æŸä¸ªæ‹¦æˆªå™¨ï¼Œ</span><br><span class="line">   Interceptor interceptor = interceptors.get(index);</span><br><span class="line">   //ç„¶åæ‰§è¡Œæ‹¦æˆªå™¨çš„interceptæ–¹æ³•,åŒæ—¶ä¼ å…¥æ–°çš„RealInterceptorChainå¯¹è±¡(ä¸»è¦çš„åŒºåˆ«åœ¨äºindex+1äº†)&apos;</span><br><span class="line">   Response response = interceptor.intercept(next);</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">   return response;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œindexå°±æ˜¯æˆ‘ä»¬åˆšæ‰çš„0ï¼Œä¹Ÿå°±æ˜¯ä»0å¼€å§‹ï¼Œå¦‚æœindexè¶…è¿‡äº†è¿‡æ»¤å™¨çš„ä¸ªæ•°æŠ›å‡ºå¼‚å¸¸ï¼Œåé¢ä¼šå†newä¸€ä¸ªRealInterceptorChainï¼Œè€Œä¸”ä¼šå°†å‚æ•°ä¼ é€’ï¼Œå¹¶ä¸”index+1äº†ï¼Œæ¥ç€è·å–indexçš„interceptor,å¹¶è°ƒç”¨interceptæ–¹æ³•ï¼Œä¼ å…¥æ–°newçš„nextå¯¹è±¡ã€‚<br>è¿™æ˜¯okhttpå¾ˆç‰›é€¼çš„ä¸€ä¸ªåœ°æ–¹ï¼Œä¼ è¯´ä¸­çš„è´£ä»»é“¾æ¥è®¾è®¡æ¨¡å¼ï¼Œä¸ºäº†æ›´å¥½çš„ç†è§£å¹¶åŠ æ·±å°è±¡ï¼Œæˆ‘æŠ„äº†ä¸€å¼ å›¾<br><img src="https://s2.ax1x.com/2020/03/06/3qLsw6.png" alt="å›¾ç‰‡"></p>
<h4 id="RetryAndFollowUpInterceptor"><a href="#RetryAndFollowUpInterceptor" class="headerlink" title="RetryAndFollowUpInterceptor"></a>RetryAndFollowUpInterceptor</h4><p>RetryAndFollowUpInterceptorçš„å®šä¹‰ä¸ºï¼šThis interceptor recovers from failures and follows redirects as necessary å³ç½‘ç»œè¯·æ±‚å¤±è´¥åï¼Œåœ¨ä¸€äº›å¿…è¦çš„æ¡ä»¶ä¸‹ï¼Œä¼šé‡æ–°è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚<br>è¿›å»RetryAndFollowUpInterceptorçœ‹æ ¸å¿ƒä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">@Override public Response intercept(Chain chain) throws IOException &#123;</span><br><span class="line">   Request request = chain.request();</span><br><span class="line">   RealInterceptorChain realChain = (RealInterceptorChain) chain;</span><br><span class="line">   Call call = realChain.call();</span><br><span class="line">   EventListener eventListener = realChain.eventListener();</span><br><span class="line"></span><br><span class="line">   StreamAllocation streamAllocation = new StreamAllocation(client.connectionPool(),</span><br><span class="line">       createAddress(request.url()), call, eventListener, callStackTrace);</span><br><span class="line">   this.streamAllocation = streamAllocation;</span><br><span class="line">   //é‡å®šå‘æ¬¡æ•°</span><br><span class="line">   int followUpCount = 0;</span><br><span class="line">   Response priorResponse = null;</span><br><span class="line">   //æ­»å¾ªç¯</span><br><span class="line">   while (true) &#123;</span><br><span class="line">     if (canceled) &#123;</span><br><span class="line">       streamAllocation.release();</span><br><span class="line">       throw new IOException(&quot;Canceled&quot;);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Response response;</span><br><span class="line">     boolean releaseConnection = true;</span><br><span class="line">     try &#123;</span><br><span class="line">       response = realChain.proceed(request, streamAllocation, null, null);</span><br><span class="line">       releaseConnection = false;</span><br><span class="line">     &#125; catch (RouteException e) &#123;</span><br><span class="line">       //è¿™é‡Œèƒ½è·³å‡ºå¾ªå</span><br><span class="line">       //å½“å‘ç”ŸRouteExceptionæ—¶å€™ï¼Œå¹¶ä¸” recoverä¸ºfalseçš„æ—¶å€™ï¼Œè¿™æ—¶å€™ä¼šè·³å‡ºå¾ªç¯ï¼Œç„¶åæŠ›å‡ºå»å¼‚å¸¸ï¼Œå¹¶å›è°ƒcallback.onFailure(Exception e),è¿”å›ç»™UIå±‚è¿›è¡Œå¤„ç† ï¼Œå‡å¦‚è¯´æ²¡æœ‰å¼€æ•°æ®æµé‡çš„æƒ…å†µä¸‹ï¼Œå»è¯·æ±‚ç½‘ç»œï¼Œåˆ™ä¼šæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚</span><br><span class="line">       // The attempt to connect via a route failed. The request will not have been sent.</span><br><span class="line">       if (!recover(e.getLastConnectException(), streamAllocation, false, request)) &#123;</span><br><span class="line">         throw e.getLastConnectException();</span><br><span class="line">       &#125;</span><br><span class="line">       releaseConnection = false;</span><br><span class="line">       continue;</span><br><span class="line">     &#125; catch (IOException e) &#123;</span><br><span class="line">       // An attempt to communicate with a server failed. The request may have been sent.</span><br><span class="line">       //å½“å‘ç”ŸIOExceptionæ—¶å€™ï¼Œrecoverä¸ºfalseçš„æ—¶å€™ï¼Œåˆ™throw exceptionï¼Œä¸­æ–­æ­»å¾ªç¯çš„æ“ä½œï¼Œ</span><br><span class="line">       boolean requestSendStarted = !(e instanceof ConnectionShutdownException);</span><br><span class="line">       if (!recover(e, streamAllocation, requestSendStarted, request)) throw e;</span><br><span class="line">       releaseConnection = false;</span><br><span class="line">       continue;</span><br><span class="line">     &#125; finally &#123;</span><br><span class="line">       // We&apos;re throwing an unchecked exception. Release any resources.</span><br><span class="line">       if (releaseConnection) &#123;</span><br><span class="line">         streamAllocation.streamFailed(null);</span><br><span class="line">         streamAllocation.release();</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // Attach the prior response if it exists. Such responses never have a body.</span><br><span class="line">     if (priorResponse != null) &#123;</span><br><span class="line">       response = response.newBuilder()</span><br><span class="line">           .priorResponse(priorResponse.newBuilder()</span><br><span class="line">                   .body(null)</span><br><span class="line">                   .build())</span><br><span class="line">           .build();</span><br><span class="line">     &#125;</span><br><span class="line">     //é‡å®šå‘æ–¹æ³•</span><br><span class="line">     Request followUp = followUpRequest(response, streamAllocation.route());</span><br><span class="line"></span><br><span class="line">     if (followUp == null) &#123;</span><br><span class="line">       if (!forWebSocket) &#123;</span><br><span class="line">         streamAllocation.release();</span><br><span class="line">       &#125;</span><br><span class="line">       return response;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     closeQuietly(response.body());</span><br><span class="line"></span><br><span class="line">     if (++followUpCount &gt; MAX_FOLLOW_UPS) &#123;</span><br><span class="line">       streamAllocation.release();</span><br><span class="line">       throw new ProtocolException(&quot;Too many follow-up requests: &quot; + followUpCount);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     if (followUp.body() instanceof UnrepeatableRequestBody) &#123;</span><br><span class="line">       streamAllocation.release();</span><br><span class="line">       throw new HttpRetryException(&quot;Cannot retry streamed HTTP body&quot;, response.code());</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     if (!sameConnection(response, followUp.url())) &#123;</span><br><span class="line">       streamAllocation.release();</span><br><span class="line">       streamAllocation = new StreamAllocation(client.connectionPool(),</span><br><span class="line">           createAddress(followUp.url()), call, eventListener, callStackTrace);</span><br><span class="line">       this.streamAllocation = streamAllocation;</span><br><span class="line">     &#125; else if (streamAllocation.codec() != null) &#123;</span><br><span class="line">       throw new IllegalStateException(&quot;Closing the body of &quot; + response</span><br><span class="line">           + &quot; didn&apos;t close its backing stream. Bad interceptor?&quot;);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     request = followUp;</span><br><span class="line">     priorResponse = response;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>å°ç»“ä¸€ä¸‹</p>
<ul>
<li>1 é¦–å…ˆæŸ¥çœ‹è¯·æ±‚æ˜¯å¦å·²ç»å–æ¶ˆ</li>
<li>2 è°ƒç”¨RealInterceptorChainçš„proceedå¤„ç†è¿™ä¸ªè¯·æ±‚å¹¶æŠŠåˆšåˆ›å»ºçš„StreamAllocationä¼ é€’è¿›å»</li>
<li>3 å¦‚æœå‰é¢ç¬¬äºŒæ­¥æ²¡æœ‰å‡ºç°å¼‚å¸¸ï¼Œåˆ™è¯´æ˜è¯·æ±‚å®Œæˆï¼Œè®¾ç½®releaseConnectionä¸ºfalse,å‡ºç°å¼‚å¸¸åˆ™å°†releaseConnectionç½®ä¸ºtrue,å¹¶é‡Šæ”¾å‰é¢åˆ›å»ºçš„StreamAllocation</li>
<li>4 priorResponseä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜å‰é¢å·²ç»è·å–åˆ°äº†å“åº”ï¼Œè¿™é‡Œä¼šç»“åˆå½“å‰è·å–çš„Responseå’Œå…ˆå‰çš„Response</li>
<li>5 è°ƒç”¨followUpRequestæŸ¥çœ‹å“åº”æ˜¯å¦éœ€è¦é‡å®šå‘ï¼Œå¦‚æœä¸éœ€è¦é‡å®šå‘åˆ™è¿”å›å½“å‰è¯·æ±‚</li>
<li>6 é‡å®šå‘æ¬¡æ•°+1ï¼Œå¹¶ä¸”åˆ¤æ–­StreamAllocationæ˜¯å¦éœ€è¦é‡æ–°åˆ›å»º</li>
<li>7 é‡æ–°è®¾ç½®requestï¼Œå¹¶æŠŠå½“å‰çš„Responseä¿å­˜åˆ°priorResponseï¼Œç»§ç»­whileå¾ªç¯</li>
</ul>
<p>ç„¶åæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹é‡å®šå‘æ–¹æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">private Request followUpRequest(Response userResponse, Route route) throws IOException &#123;</span><br><span class="line">  if (userResponse == null) throw new IllegalStateException();</span><br><span class="line">  int responseCode = userResponse.code();</span><br><span class="line"></span><br><span class="line">  final String method = userResponse.request().method();</span><br><span class="line">  switch (responseCode) &#123;</span><br><span class="line">   //...</span><br><span class="line">    case HTTP_PERM_REDIRECT:</span><br><span class="line">    case HTTP_TEMP_REDIRECT:</span><br><span class="line">      if (!method.equals(&quot;GET&quot;) &amp;&amp; !method.equals(&quot;HEAD&quot;)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">    case HTTP_MULT_CHOICE:</span><br><span class="line">    case HTTP_MOVED_PERM:</span><br><span class="line">    case HTTP_MOVED_TEMP:</span><br><span class="line">    case HTTP_SEE_OTHER:</span><br><span class="line">      if (!client.followRedirects()) return null;</span><br><span class="line"></span><br><span class="line">      String location = userResponse.header(&quot;Location&quot;);</span><br><span class="line">      if (location == null) return null;</span><br><span class="line">      HttpUrl url = userResponse.request().url().resolve(location);</span><br><span class="line"></span><br><span class="line">      boolean sameScheme = url.scheme().equals(userResponse.request().url().scheme());</span><br><span class="line">      Request.Builder requestBuilder = userResponse.request().newBuilder();</span><br><span class="line">      if (HttpMethod.permitsRequestBody(method)) &#123;</span><br><span class="line">        final boolean maintainBody = HttpMethod.redirectsWithBody(method);</span><br><span class="line">        if (HttpMethod.redirectsToGet(method)) &#123;</span><br><span class="line">          requestBuilder.method(&quot;GET&quot;, null);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          RequestBody requestBody = maintainBody ? userResponse.request().body() : null;</span><br><span class="line">          requestBuilder.method(method, requestBody);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!maintainBody) &#123;</span><br><span class="line">          requestBuilder.removeHeader(&quot;Transfer-Encoding&quot;);</span><br><span class="line">          requestBuilder.removeHeader(&quot;Content-Length&quot;);</span><br><span class="line">          requestBuilder.removeHeader(&quot;Content-Type&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      return requestBuilder.url(url).build();</span><br><span class="line"></span><br><span class="line">    default:</span><br><span class="line">      return null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¯¥æ–¹æ³•ä¼šå–åˆ°çŠ¶æ€ç ï¼Œç„¶åè¿›è¡Œswitchåˆ¤æ–­ï¼Œå½“status codeä¸º307å³HTTP_TEMP_REDIRECTæ—¶ï¼Œokhttpä¼šä»ç›¸åº”ä½“ä¸­ï¼Œè·å–Locationå€¼ï¼ˆé‡å®šå‘åœ°å€ï¼‰ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿˜æœ‰å¥½å¤šç§çŠ¶æ€ç çš„åˆ¤æ–­ã€‚è¿™é‡Œåªçœ‹é‡å®šå‘307ï¼Œ<br>ä¼šé‡æ–°åˆ›å»ºå’Œæ‹¼æ¥è¯·æ±‚æ–°çš„Requestï¼Œç„¶åå°†åŸè¯·æ±‚çš„ç›¸å…³Headerä¿¡æ¯è¿›è¡Œæ‹¼è£…ï¼Œæœ€ååˆ›å»ºä¸€ä¸ªæ–°çš„Requestè¿”å›å›å»å†æ¬¡è¿›è¡Œç½‘ç»œè¯·æ±‚</p>
<h4 id="BridgeInterceptor"><a href="#BridgeInterceptor" class="headerlink" title="BridgeInterceptor"></a>BridgeInterceptor</h4><p>ä¸€å¥è¯æ¦‚æ‹¬ï¼š å°†å®¢æˆ·ç«¯æ„å»ºçš„Requestå¯¹è±¡ä¿¡æ¯æ„å»ºæˆçœŸæ­£çš„ç½‘ç»œè¯·æ±‚;ç„¶åå‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œæœ€åå°±æ˜¯å°†æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯å°è£…æˆä¸€ä¸ªResponseå¯¹è±¡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">public final class BridgeInterceptor implements Interceptor &#123;</span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">@Override </span><br><span class="line">public Response intercept(Chain chain) throws IOException &#123;</span><br><span class="line">  Request userRequest = chain.request();</span><br><span class="line">  Request.Builder requestBuilder = userRequest.newBuilder();</span><br><span class="line"></span><br><span class="line"> RequestBody body = userRequest.body();</span><br><span class="line"> //å¦‚æœå­˜åœ¨è¯·æ±‚ä¸»ä½“éƒ¨åˆ†ï¼Œé‚£ä¹ˆéœ€è¦æ·»åŠ Content-Typeã€Content-Lengthé¦–éƒ¨</span><br><span class="line"> if (body != null) &#123;</span><br><span class="line">      MediaType contentType = body.contentType();</span><br><span class="line">      if (contentType != null) &#123;</span><br><span class="line">        requestBuilder.header(&quot;Content-Type&quot;, contentType.toString());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      long contentLength = body.contentLength();</span><br><span class="line">      if (contentLength != -1) &#123;</span><br><span class="line">        requestBuilder.header(&quot;Content-Length&quot;, Long.toString(contentLength));</span><br><span class="line">        requestBuilder.removeHeader(&quot;Transfer-Encoding&quot;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        requestBuilder.header(&quot;Transfer-Encoding&quot;, &quot;chunked&quot;);</span><br><span class="line">        requestBuilder.removeHeader(&quot;Content-Length&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (userRequest.header(&quot;Host&quot;) == null) &#123;</span><br><span class="line">      requestBuilder.header(&quot;Host&quot;, hostHeader(userRequest.url(), false));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (userRequest.header(&quot;Connection&quot;) == null) &#123;</span><br><span class="line">      requestBuilder.header(&quot;Connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If we add an &quot;Accept-Encoding: gzip&quot; header field we&apos;re responsible for also decompressing</span><br><span class="line">    // the transfer stream.</span><br><span class="line">    boolean transparentGzip = false;</span><br><span class="line">    if (userRequest.header(&quot;Accept-Encoding&quot;) == null &amp;&amp; userRequest.header(&quot;Range&quot;) == null) &#123;</span><br><span class="line">      transparentGzip = true;</span><br><span class="line">      requestBuilder.header(&quot;Accept-Encoding&quot;, &quot;gzip&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Cookie&gt; cookies = cookieJar.loadForRequest(userRequest.url());</span><br><span class="line">    if (!cookies.isEmpty()) &#123;</span><br><span class="line">      requestBuilder.header(&quot;Cookie&quot;, cookieHeader(cookies));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  if (userRequest.header(&quot;User-Agent&quot;) == null) &#123;</span><br><span class="line">      requestBuilder.header(&quot;User-Agent&quot;, Version.userAgent());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">Response networkResponse = chain.proceed(requestBuilder.build());</span><br><span class="line"></span><br><span class="line">HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());</span><br><span class="line"></span><br><span class="line">Response.Builder responseBuilder = networkResponse.newBuilder()</span><br><span class="line">        .request(userRequest);</span><br><span class="line"></span><br><span class="line">    if (transparentGzip</span><br><span class="line">        &amp;&amp; &quot;gzip&quot;.equalsIgnoreCase(networkResponse.header(&quot;Content-Encoding&quot;))</span><br><span class="line">        &amp;&amp; HttpHeaders.hasBody(networkResponse)) &#123;</span><br><span class="line">      GzipSource responseBody = new GzipSource(networkResponse.body().source());</span><br><span class="line">      Headers strippedHeaders = networkResponse.headers().newBuilder()</span><br><span class="line">          .removeAll(&quot;Content-Encoding&quot;)</span><br><span class="line">          .removeAll(&quot;Content-Length&quot;)</span><br><span class="line">          .build();</span><br><span class="line">      responseBuilder.headers(strippedHeaders);</span><br><span class="line">      responseBuilder.body(new RealResponseBody(strippedHeaders, Okio.buffer(responseBody)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return responseBuilder.build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /** Returns a &apos;Cookie&apos; HTTP request header with all cookies, like &#123;@code a=b; c=d&#125;. */</span><br><span class="line">  private String cookieHeader(List&lt;Cookie&gt; cookies) &#123;</span><br><span class="line">    StringBuilder cookieHeader = new StringBuilder();</span><br><span class="line">    for (int i = 0, size = cookies.size(); i &lt; size; i++) &#123;</span><br><span class="line">      if (i &gt; 0) &#123;</span><br><span class="line">        cookieHeader.append(&quot;; &quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      Cookie cookie = cookies.get(i);</span><br><span class="line">      cookieHeader.append(cookie.name()).append(&apos;=&apos;).append(cookie.value());</span><br><span class="line">    &#125;</span><br><span class="line">    return cookieHeader.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆè·å–åŸè¯·æ±‚ï¼Œç„¶ååœ¨è¯·æ±‚ä¸­æ·»åŠ å¤´ï¼Œæ¯”å¦‚Hostã€Connectionã€Accept-Encodingå‚æ•°ç­‰ï¼Œç„¶åæ ¹æ®çœ‹æ˜¯å¦éœ€è¦å¡«å……Cookieï¼Œåœ¨å¯¹åŸå§‹è¯·æ±‚åšå‡ºå¤„ç†åï¼Œä½¿ç”¨chainçš„proccedæ–¹æ³•å¾—åˆ°å“åº”ï¼Œæ¥ä¸‹æ¥å¯¹å“åº”åšå¤„ç†å¾—åˆ°ç”¨æˆ·å“åº”ï¼Œæœ€åè¿”å›å“åº”ã€‚æ¥ä¸‹æ¥å†çœ‹ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ConnectInterceptorçš„å¤„ç†ã€‚</p>
<h4 id="CacheInterceptor"><a href="#CacheInterceptor" class="headerlink" title="CacheInterceptor"></a>CacheInterceptor</h4><p>ç¼“å­˜æ‹¦æˆªå™¨ï¼Œç®€å•æ¥è¯´å°±æ˜¯æœ‰ç¼“å­˜å°±ä½¿ç”¨ç¼“å­˜<br>æ„Ÿè§‰å¾ˆå¤æ‚ï¼Œå€Ÿé‰´äº†ä¸€äº›å¤§ç¥çš„åšå®¢<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override public Response intercept(Chain chain) throws IOException &#123;</span><br><span class="line">    //1 å°è¯•é€šè¿‡è¿™ä¸ªRequestæ‹¿ç¼“å­˜</span><br><span class="line">    Response cacheCandidate = cache != null</span><br><span class="line">        ? cache.get(chain.request())</span><br><span class="line">        : null;</span><br><span class="line">    //2 å¦‚æœä¸å…è®¸ä½¿ç”¨ç½‘ç»œå¹¶ä¸”ç¼“å­˜ä¸ºç©ºï¼Œæ–°å»ºä¸€ä¸ª504çš„Resposneè¿”å›ã€‚</span><br><span class="line">    if (networkRequest == null &amp;&amp; cacheResponse == null) &#123;</span><br><span class="line">      return new Response;</span><br><span class="line">    &#125;</span><br><span class="line">    //3 å¦‚æœä¸å…è®¸ä½¿ç”¨ç½‘ç»œï¼Œä½†æ˜¯æœ‰ç¼“å­˜ï¼Œè¿”å›ç¼“å­˜</span><br><span class="line">    if (networkRequest == null) &#123;</span><br><span class="line">      return cacheResponse;</span><br><span class="line">    &#125;</span><br><span class="line">    //4 é“¾å¼è°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨</span><br><span class="line">      networkResponse = chain.proceed(networkRequest);</span><br><span class="line">    //5 å¦‚æœç¼“å­˜ä¸ä¸ºç©ºï¼Œä½†æ˜¯ç½‘ç»œè¯·æ±‚å¾—æ¥çš„è¿”å›ç æ˜¯304ï¼ˆå¦‚æœè¿”å›ç æ˜¯304ï¼Œå®¢æˆ·ç«¯æœ‰ç¼“å†²çš„æ–‡æ¡£å¹¶å‘å‡ºäº†ä¸€ä¸ªæ¡ä»¶æ€§çš„è¯·æ±‚ï¼ˆä¸€èˆ¬æ˜¯æä¾›If-Modified-Sinceå¤´è¡¨ç¤ºå®¢æˆ·åªæƒ³æ¯”æŒ‡å®šæ—¥æœŸæ›´æ–°çš„æ–‡æ¡£ï¼‰ã€‚æœåŠ¡å™¨å‘Šè¯‰å®¢æˆ·ï¼ŒåŸæ¥ç¼“å†²çš„æ–‡æ¡£è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚)åˆ™ä½¿ç”¨ç¼“å­˜çš„å“åº”ã€‚</span><br><span class="line">    if (cacheResponse != null) &#123;</span><br><span class="line">      if (networkResponse.code() == HTTP_NOT_MODIFIED) &#123;</span><br><span class="line">        Response response = cacheResponse.newBuilder()</span><br><span class="line">        return response;</span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    //6</span><br><span class="line">    Response response = networkResponse;</span><br><span class="line">    //7</span><br><span class="line">    cache.put(response);</span><br><span class="line"></span><br><span class="line">    return response;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢è¿™äº›å€Ÿé‰´äº†<a href="https://www.jianshu.com/p/bfb13eb3a425" target="_blank" rel="noopener">https://www.jianshu.com/p/bfb13eb3a425</a><br>è¯¦ç»†å†…å®¹å¯ä»¥å»å¤§ç¥åšå®¢é‡Œçœ‹</p>
<h4 id="ConnectInterceptor"><a href="#ConnectInterceptor" class="headerlink" title="ConnectInterceptor"></a>ConnectInterceptor</h4><p>è¿æ¥æ‹¦æˆªå™¨ï¼Œé¡¾åæ€ä¹‰æ‰“å¼€äº†ä¸æœåŠ¡å™¨çš„é“¾æ¥ï¼Œæ­£å¼å¼€å¯äº†ç½‘ç»œè¯·æ±‚ã€‚<br>æ€»çš„æ¥è¯´ConnectionInterceptorå°±æ˜¯å¼„ä¸€ä¸ªRealConnectionå¯¹è±¡ï¼Œç„¶ååˆ›å»ºSocketé“¾æ¥<br>å…·ä½“å¯ä»¥çœ‹çœ‹<a href="https://www.jianshu.com/p/4bf4c796db6f" target="_blank" rel="noopener">https://www.jianshu.com/p/4bf4c796db6f</a><br>è·Ÿä¸Šé¢çš„æ¨èæ˜¯ä¸€ä¸ªä½œè€…</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p> èƒ½åŠ›ä¸€èˆ¬æ°´å¹³æœ‰é™ï¼Œä¸æƒ³å†™å¤§æ®µçš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ï¼Œå› ä¸ºç°åœ¨ä¸€èˆ¬éƒ½ä¼šé…åˆrxjavaä½¿ç”¨ï¼Œå•ç‹¬è®°å½•okhttpä½¿ç”¨æ–¹å¼æ„ä¹‰ä¸å¤§ï¼Œç¬”è€…åªæ˜¯å¿ å®è®°å½•ä¸‹è‡ªå·±çœ‹okhttpæ¡†æ¶æºç çš„è¿‡ç¨‹ï¼Œä»¥ä¾›æ—¥åæŸ¥é˜…ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/01/Retrofitæºç åˆ†æ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/01/Retrofitæºç åˆ†æ/" itemprop="url">Retrofitæºç åˆ†æ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-03-01T00:00:00+08:00">
                2020-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/01/Retrofitæºç åˆ†æ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/01/Retrofitæºç åˆ†æ/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Retrofitæœ¬è´¨æµç¨‹"><a href="#Retrofitæœ¬è´¨æµç¨‹" class="headerlink" title="Retrofitæœ¬è´¨æµç¨‹"></a>Retrofitæœ¬è´¨æµç¨‹</h2><ul>
<li>1 å°†httpè¯·æ±‚æŠ½è±¡æˆjavaæ¥å£</li>
<li>2 åœ¨æ¥å£ä¸­æ³¨è§£æè¿°å’Œé…ç½®ç½‘ç»œè¯·æ±‚å‚æ•°</li>
<li>3 ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼å°†ç½‘ç»œè¯·æ±‚çš„æ³¨è§£è§£ææˆhttpè¯·æ±‚</li>
<li>4 ç”¨okhttpæ‰§è¡Œhttpè¯·æ±‚</li>
</ul>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="åˆ›å»ºRetrofitå¯¹è±¡"><a href="#åˆ›å»ºRetrofitå¯¹è±¡" class="headerlink" title="åˆ›å»ºRetrofitå¯¹è±¡"></a>åˆ›å»ºRetrofitå¯¹è±¡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Retrofit retrofit = new Retrofit.Builder()</span><br><span class="line">                                 .baseUrl(&quot;http://fanyi.youdao.com/&quot;)</span><br><span class="line">                                 .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                                 .build();</span><br></pre></td></tr></table></figure>
<p>Retrofitå®ä¾‹æ˜¯ä½¿ç”¨å»ºé€ è€…æ¨¡å¼é€šè¿‡Builderç±»è¿›è¡Œåˆ›å»ºçš„(å»ºé€ è€…æ¨¡å¼:å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—ç”¨æˆ·åœ¨ä¸çŸ¥é“å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚æƒ…å†µä¸‹å°±å¯ä»¥ç›´æ¥åˆ›å»ºå¤æ‚çš„å¯¹è±¡ã€‚)<br>è·Ÿè¿›Retrofitç±»<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public final class Retrofit &#123;</span><br><span class="line">  </span><br><span class="line">  private final Map&lt;Method, ServiceMethod&gt; serviceMethodCache = new LinkedHashMap&lt;&gt;();</span><br><span class="line">  // ç½‘ç»œè¯·æ±‚é…ç½®å¯¹è±¡ï¼ˆå¯¹ç½‘ç»œè¯·æ±‚æ¥å£ä¸­æ–¹æ³•æ³¨è§£è¿›è¡Œè§£æåå¾—åˆ°çš„å¯¹è±¡ï¼‰</span><br><span class="line">  // ä½œç”¨ï¼šå­˜å‚¨ç½‘ç»œè¯·æ±‚ç›¸å…³çš„é…ç½®ï¼Œå¦‚ç½‘ç»œè¯·æ±‚çš„æ–¹æ³•ã€æ•°æ®è½¬æ¢å™¨ã€ç½‘ç»œè¯·æ±‚é€‚é…å™¨ã€ç½‘ç»œè¯·æ±‚å·¥å‚ã€åŸºåœ°å€ç­‰</span><br><span class="line">  </span><br><span class="line">  private final HttpUrl baseUrl;</span><br><span class="line">  // ç½‘ç»œè¯·æ±‚çš„urlåœ°å€</span><br><span class="line"></span><br><span class="line">  private final okhttp3.Call.Factory callFactory;</span><br><span class="line">  // ç½‘ç»œè¯·æ±‚å™¨çš„å·¥å‚</span><br><span class="line">  // ä½œç”¨ï¼šç”Ÿäº§ç½‘ç»œè¯·æ±‚å™¨ï¼ˆCallï¼‰</span><br><span class="line">  // Retrofitæ˜¯é»˜è®¤ä½¿ç”¨okhttp</span><br><span class="line">  </span><br><span class="line">   private final List&lt;CallAdapter.Factory&gt; adapterFactories;</span><br><span class="line">    //ç”¨äº†å·¥å‚æ¨¡å¼</span><br><span class="line">  // ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚çš„é›†åˆ</span><br><span class="line">  // ä½œç”¨ï¼šæ”¾ç½®ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚</span><br><span class="line">  // ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚ä½œç”¨ï¼šç”Ÿäº§ç½‘ç»œè¯·æ±‚é€‚é…å™¨ï¼ˆCallAdapterï¼‰</span><br><span class="line">  // ä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  private final List&lt;Converter.Factory&gt; converterFactories;</span><br><span class="line">  //ç”¨äº†å·¥å‚æ¨¡å¼</span><br><span class="line">  // æ•°æ®è½¬æ¢å™¨å·¥å‚çš„é›†åˆ</span><br><span class="line">  // ä½œç”¨ï¼šæ”¾ç½®æ•°æ®è½¬æ¢å™¨å·¥å‚</span><br><span class="line">  // æ•°æ®è½¬æ¢å™¨å·¥å‚ä½œç”¨ï¼šç”Ÿäº§æ•°æ®è½¬æ¢å™¨ï¼ˆconverterï¼‰æ¯”å¦‚gson</span><br><span class="line"></span><br><span class="line">  private final Executor callbackExecutor;</span><br><span class="line">  // å›è°ƒæ–¹æ³•æ‰§è¡Œå™¨</span><br><span class="line"></span><br><span class="line">private final boolean validateEagerly; </span><br><span class="line">// æ ‡å¿—ä½</span><br><span class="line">// ä½œç”¨ï¼šæ˜¯å¦æå‰å¯¹ä¸šåŠ¡æ¥å£ä¸­çš„æ³¨è§£è¿›è¡ŒéªŒè¯è½¬æ¢çš„æ ‡å¿—ä½</span><br><span class="line"></span><br><span class="line">Retrofit(okhttp3.Call.Factory callFactory, HttpUrl baseUrl,  </span><br><span class="line">      List&lt;Converter.Factory&gt; converterFactories, List&lt;CallAdapter.Factory&gt; adapterFactories,  </span><br><span class="line">      Executor callbackExecutor, boolean validateEagerly) &#123;  </span><br><span class="line">    this.callFactory = callFactory;  </span><br><span class="line">    this.baseUrl = baseUrl;  </span><br><span class="line">    this.converterFactories = unmodifiableList(converterFactories); </span><br><span class="line">    this.adapterFactories = unmodifiableList(adapterFactories);   </span><br><span class="line">    // unmodifiableList(list)è¿‘ä¼¼äºUnmodifiableList&lt;E&gt;(list)</span><br><span class="line">    // ä½œç”¨ï¼šåˆ›å»ºçš„æ–°å¯¹è±¡èƒ½å¤Ÿå¯¹listæ•°æ®è¿›è¡Œè®¿é—®ï¼Œä½†ä¸å¯é€šè¿‡è¯¥å¯¹è±¡å¯¹listé›†åˆä¸­çš„å…ƒç´ è¿›è¡Œä¿®æ”¹</span><br><span class="line">    this.callbackExecutor = callbackExecutor;  </span><br><span class="line">    this.validateEagerly = validateEagerly;</span><br></pre></td></tr></table></figure></p>
<p>ä¼—å¤šéœ€è¦é…ç½®çš„å‚æ•°ä¸­ï¼Œæˆ‘ä»¬æ³¨æ„ä¸€ä¸‹calladapterï¼ˆç½‘ç»œè¯·æ±‚é€‚é…å™¨ï¼‰ï¼šå°†é»˜è®¤çš„ç½‘ç»œè¯·æ±‚æ‰§è¡Œå™¨ï¼ˆOkHttpCallï¼‰è½¬æ¢æˆé€‚åˆè¢«ä¸åŒå¹³å°æ¥è°ƒç”¨çš„ç½‘ç»œè¯·æ±‚æ‰§è¡Œå™¨å½¢å¼</p>
<ul>
<li>1 Callåœ¨Retrofité‡Œé»˜è®¤æ˜¯OkHttpCall</li>
<li>2 åœ¨Retrofitä¸­æä¾›äº†å››ç§CallAdapterFactoryï¼š ExecutorCallAdapterFactoryï¼ˆé»˜è®¤ï¼‰ã€GuavaCallAdapterFactoryã€Java8CallAdapterFactoryã€RxJavaCallAdapterFactory</li>
</ul>
<p>è·Ÿè¿›build<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public Retrofit build() &#123;</span><br><span class="line">      if (baseUrl == null) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Base URL required.&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">&lt;--  é…ç½®ç½‘ç»œè¯·æ±‚æ‰§è¡Œå™¨ï¼ˆcallFactoryï¼‰--&gt;</span><br><span class="line">      okhttp3.Call.Factory callFactory = this.callFactory;</span><br><span class="line">      // å¦‚æœæ²¡æŒ‡å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨okhttp</span><br><span class="line">      // æ‰€ä»¥Retrofité»˜è®¤ä½¿ç”¨okhttpè¿›è¡Œç½‘ç»œè¯·æ±‚</span><br><span class="line">      if (callFactory == null) &#123;</span><br><span class="line">        callFactory = new OkHttpClient();</span><br><span class="line">      &#125;</span><br><span class="line">&lt;--  é…ç½®ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚ï¼ˆCallAdapterFactoryï¼‰--&gt;</span><br><span class="line">      Executor callbackExecutor = this.callbackExecutor;</span><br><span class="line">       // å¦‚æœæ²¡æŒ‡å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨Platformæ£€æµ‹ç¯å¢ƒæ—¶çš„é»˜è®¤callbackExecutor</span><br><span class="line">      // å³Androidé»˜è®¤çš„callbackExecutor</span><br><span class="line">      if (callbackExecutor == null) &#123;</span><br><span class="line">        callbackExecutor = platform.defaultCallbackExecutor();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // Make a defensive copy of the adapters and add the default Call adapter.</span><br><span class="line">      List&lt;CallAdapter.Factory&gt; adapterFactories = new ArrayList&lt;&gt;(this.adapterFactories);</span><br><span class="line">      adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</span><br><span class="line"></span><br><span class="line">      // Make a defensive copy of the converters.</span><br><span class="line">      List&lt;Converter.Factory&gt; converterFactories = new ArrayList&lt;&gt;(this.converterFactories);</span><br><span class="line">      //è·å–åˆé€‚çš„ç½‘ç»œè¯·æ±‚é€‚é…å™¨å’Œæ•°æ®è½¬æ¢å™¨éƒ½æ˜¯ä»adapterFactorieså’ŒconverterFactoriesé›†åˆçš„é¦–ä½-æœ«ä½å¼€å§‹éå†</span><br><span class="line">      // å› æ­¤é›†åˆä¸­çš„å·¥å‚ä½ç½®è¶Šé å‰å°±æ‹¥æœ‰è¶Šé«˜çš„ä½¿ç”¨æƒé™</span><br><span class="line"></span><br><span class="line">      return new Retrofit(callFactory, baseUrl, converterFactories, adapterFactories,</span><br><span class="line">          callbackExecutor, validateEagerly);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="åˆ›å»ºç½‘ç»œè¯·æ±‚æ¥å£çš„å®ä¾‹"><a href="#åˆ›å»ºç½‘ç»œè¯·æ±‚æ¥å£çš„å®ä¾‹" class="headerlink" title="åˆ›å»ºç½‘ç»œè¯·æ±‚æ¥å£çš„å®ä¾‹"></a>åˆ›å»ºç½‘ç»œè¯·æ±‚æ¥å£çš„å®ä¾‹</h3><p>åˆ©ç”¨æ³¨è§£ç¡®å®šè¯·æ±‚æ–¹å¼å¹¶å®Œæˆurlçš„æ‹¼æ¥ï¼Œè¿™éƒ½ç›´æ¥å¸¦è¿‡ï¼Œæœ€åç§ç§çº¿ç´¢èšç„¦åˆ°retrofit.create(xxxApi.class)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; T create(final Class&lt;T&gt; service) &#123;</span><br><span class="line">   Utils.validateServiceInterface(service);</span><br><span class="line">   if (validateEagerly) &#123;</span><br><span class="line">   	// é€šè¿‡ä¹‹å‰ä¼ çš„æ ‡å¿—ä½åˆ¤æ–­æ˜¯å¦éœ€è¦æå‰éªŒè¯ï¼Œå¦‚æœä¸æ˜¯æå‰éªŒè¯åˆ™è¿›è¡ŒåŠ¨æ€è§£æå¯¹åº”æ–¹æ³•</span><br><span class="line">     eagerlyValidateMethods(service);</span><br><span class="line">   &#125;</span><br><span class="line">    // åˆ›å»ºäº†ç½‘ç»œè¯·æ±‚æ¥å£çš„åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œå³é€šè¿‡åŠ¨æ€ä»£ç†åˆ›å»ºç½‘ç»œè¯·æ±‚æ¥å£çš„å®ä¾‹ ï¼ˆå¹¶æœ€ç»ˆè¿”å›ï¼‰</span><br><span class="line">       // è¯¥åŠ¨æ€ä»£ç†æ˜¯ä¸ºäº†æ‹¿åˆ°ç½‘ç»œè¯·æ±‚æ¥å£å®ä¾‹ä¸Šæ‰€æœ‰æ³¨è§£</span><br><span class="line">       return (T) Proxy.newProxyInstance(</span><br><span class="line">         service.getClassLoader(),      // åŠ¨æ€ç”Ÿæˆæ¥å£çš„å®ç°ç±» </span><br><span class="line">         new Class&lt;?&gt;[] &#123; service &#125;,    // åŠ¨æ€åˆ›å»ºå®ä¾‹</span><br><span class="line">         new InvocationHandler() &#123;     // å°†ä»£ç†ç±»çš„å®ç°äº¤ç»™ InvocationHandlerç±»ä½œä¸ºå…·ä½“çš„å®ç°ï¼ˆä¸‹é¢ä¼šè§£é‡Šï¼‰</span><br><span class="line">         private final Platform platform = Platform.get();</span><br><span class="line">        // åœ¨ InvocationHandlerç±»çš„invokeï¼ˆï¼‰å®ç°ä¸­ï¼Œé™¤äº†æ‰§è¡ŒçœŸæ­£çš„é€»è¾‘ï¼ˆå¦‚å†æ¬¡è½¬å‘ç»™çœŸæ­£çš„å®ç°ç±»å¯¹è±¡ï¼‰ï¼Œè¿˜å¯ä»¥è¿›è¡Œä¸€äº›æœ‰ç”¨çš„æ“ä½œ</span><br><span class="line">        // å¦‚ç»Ÿè®¡æ‰§è¡Œæ—¶é—´ã€è¿›è¡Œåˆå§‹åŒ–å’Œæ¸…ç†ã€å¯¹æ¥å£è°ƒç”¨è¿›è¡Œæ£€æŸ¥ç­‰ã€‚</span><br><span class="line"></span><br><span class="line">         @Override public Object invoke(Object proxy, Method method, @Nullable Object[] args)</span><br><span class="line">             throws Throwable &#123;</span><br><span class="line">           // If the method is a method from Object then defer to normal invocation.</span><br><span class="line">           if (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">             return method.invoke(this, args);</span><br><span class="line">           &#125;</span><br><span class="line">           if (platform.isDefaultMethod(method)) &#123;</span><br><span class="line">             return platform.invokeDefaultMethod(method, service, proxy, args);</span><br><span class="line">           &#125;</span><br><span class="line">           //ä¸‹é¢ä¸‰è¡Œæ˜¯é‡ç‚¹</span><br><span class="line">           //è¿™è¡Œå¾ˆå¤æ‚ä¸‹é¢åˆ†æ</span><br><span class="line">           ServiceMethod&lt;Object, Object&gt; serviceMethod =</span><br><span class="line">               (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</span><br><span class="line">           //æ ¹æ®ä¸Šè¾¹é‚£è¡Œé…ç½®å¥½çš„ServiceMethodå¯¹è±¡å’Œè¾“å…¥çš„è¯·æ±‚å‚æ•°åˆ›å»ºokHttpCallå¯¹è±¡</span><br><span class="line">           OkHttpCall&lt;Object&gt; okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args);</span><br><span class="line">           //å°†ä¸Šä¸€è¡Œåˆ›å»ºçš„OkHttpCallå¯¹è±¡ä¼ ç»™å†ä¸Šä¸€è¡Œåˆ›å»ºçš„serviceMethodå¯¹è±¡ä¸­å¯¹åº”çš„ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚çš„adaptï¼ˆï¼‰</span><br><span class="line">           return serviceMethod.callAdapter.adapt(okHttpCall);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>  é¦–å…ˆæ˜¯loadServiceMethod<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ServiceMethod loadServiceMethod(Method method) &#123;</span><br><span class="line">    ServiceMethod result;</span><br><span class="line">      // è®¾ç½®çº¿ç¨‹åŒæ­¥é”</span><br><span class="line">    synchronized (serviceMethodCache) &#123;</span><br><span class="line"></span><br><span class="line">      result = serviceMethodCache.get(method);</span><br><span class="line">      // ServiceMethodç±»å¯¹è±¡é‡‡ç”¨äº†å•ä¾‹æ¨¡å¼è¿›è¡Œåˆ›å»º</span><br><span class="line">      // å³åˆ›å»ºServiceMethodå¯¹è±¡å‰ï¼Œå…ˆçœ‹serviceMethodCacheæœ‰æ²¡æœ‰ç¼“å­˜ä¹‹å‰åˆ›å»ºè¿‡çš„ç½‘ç»œè¯·æ±‚å®ä¾‹</span><br><span class="line">      </span><br><span class="line">      // è‹¥æ²¡ç¼“å­˜ï¼Œåˆ™é€šè¿‡å»ºé€ è€…æ¨¡å¼åˆ›å»º serviceMethod å¯¹è±¡</span><br><span class="line">      if (result == null) &#123;</span><br><span class="line">      // è¿™ä¸ªå¾ˆé‡è¦ï¼ï¼ï¼</span><br><span class="line">        result = new ServiceMethod.Builder(this, method).build();</span><br><span class="line">        serviceMethodCache.put(method, result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line">// è¿™é‡Œå°±æ˜¯ä¸Šé¢è¯´çš„åˆ›å»ºå®ä¾‹çš„ç¼“å­˜æœºåˆ¶ï¼šé‡‡ç”¨å•ä¾‹æ¨¡å¼ä»è€Œå®ç°ä¸€ä¸ª ServiceMethod å¯¹è±¡å¯¹åº”äºç½‘ç»œè¯·æ±‚æ¥å£é‡Œçš„ä¸€ä¸ªæ–¹æ³•</span><br></pre></td></tr></table></figure></p>
<p>  ç‰¹åˆ«å…³æ³¨ä¸€ä¸‹ServiceMethod.Builder(this, method).build()<br>  ServiceMethodå¯¹è±¡åŒ…å«äº†è®¿é—®ç½‘ç»œçš„æ‰€æœ‰åŸºæœ¬ä¿¡æ¯,æ„Ÿå…´è¶£å¯ä»¥å»çœ‹ä¸€ä¸‹ServiceMethodç±»ï¼Œè¿™é‡Œä¸è´´äº†å åœ°å„¿</p>
<p>  Builder(this, method)æ–¹æ³•<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public Builder(Retrofit retrofit, Method method) &#123;</span><br><span class="line">    this.retrofit = retrofit;</span><br><span class="line">    this.method = method;</span><br><span class="line"></span><br><span class="line">    // è·å–ç½‘ç»œè¯·æ±‚æ¥å£æ–¹æ³•é‡Œçš„æ³¨é‡Š</span><br><span class="line">    this.methodAnnotations = method.getAnnotations();</span><br><span class="line">    // è·å–ç½‘ç»œè¯·æ±‚æ¥å£æ–¹æ³•é‡Œçš„å‚æ•°ç±»å‹       </span><br><span class="line">    this.parameterTypes = method.getGenericParameterTypes();  </span><br><span class="line">    //è·å–ç½‘ç»œè¯·æ±‚æ¥å£æ–¹æ³•é‡Œçš„æ³¨è§£å†…å®¹    </span><br><span class="line">    this.parameterAnnotationsArray = method.getParameterAnnotations();    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>  ServiceMethodçš„buildï¼ˆï¼‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// ä½œç”¨ï¼šæ§åˆ¶ServiceMethodå¯¹è±¡çš„ç”Ÿæˆæµç¨‹</span><br><span class="line"> public ServiceMethod build() &#123;</span><br><span class="line"></span><br><span class="line">      callAdapter = createCallAdapter();    </span><br><span class="line">      // æ ¹æ®ç½‘ç»œè¯·æ±‚æ¥å£æ–¹æ³•çš„è¿”å›å€¼å’Œæ³¨è§£ç±»å‹ï¼Œä»Retrofitå¯¹è±¡ä¸­è·å–å¯¹åº”çš„ç½‘ç»œè¯·æ±‚é€‚é…å™¨  --&gt;å…³æ³¨ç‚¹1</span><br><span class="line">     </span><br><span class="line">      responseType = callAdapter.responseType();    </span><br><span class="line">     // æ ¹æ®ç½‘ç»œè¯·æ±‚æ¥å£æ–¹æ³•çš„è¿”å›å€¼å’Œæ³¨è§£ç±»å‹ï¼Œä»Retrofitå¯¹è±¡ä¸­è·å–è¯¥ç½‘ç»œé€‚é…å™¨è¿”å›çš„æ•°æ®ç±»å‹</span><br><span class="line">     </span><br><span class="line">      responseConverter = createResponseConverter();    </span><br><span class="line">      // æ ¹æ®ç½‘ç»œè¯·æ±‚æ¥å£æ–¹æ³•çš„è¿”å›å€¼å’Œæ³¨è§£ç±»å‹ï¼Œä»Retrofitå¯¹è±¡ä¸­è·å–å¯¹åº”çš„æ•°æ®è½¬æ¢å™¨  --&gt;å…³æ³¨ç‚¹3</span><br><span class="line">       </span><br><span class="line">       for (Annotation annotation : methodAnnotations) &#123;</span><br><span class="line">        parseMethodAnnotation(annotation);</span><br><span class="line">      &#125;</span><br><span class="line">      // è§£æç½‘ç»œè¯·æ±‚æ¥å£ä¸­æ–¹æ³•çš„æ³¨è§£</span><br><span class="line">      // ä¸»è¦æ˜¯è§£æè·å–Httpè¯·æ±‚çš„æ–¹æ³•</span><br><span class="line">     // æ³¨è§£åŒ…æ‹¬ï¼šDELETEã€GETã€POSTã€HEADã€PATCHã€PUTã€OPTIONSã€HTTPã€retrofit2.http.Headersã€Multipartã€FormUrlEncoded</span><br><span class="line">     // å¤„ç†ä¸»è¦æ˜¯è°ƒç”¨æ–¹æ³• parseHttpMethodAndPath(String httpMethod, String value, boolean hasBody) ServiceMethodä¸­çš„httpMethodã€hasBodyã€relativeUrlã€relativeUrlParamNamesåŸŸè¿›è¡Œèµ‹å€¼</span><br><span class="line">      </span><br><span class="line">     int parameterCount = parameterAnnotationsArray.length;</span><br><span class="line">     // è·å–å½“å‰æ–¹æ³•çš„å‚æ•°æ•°é‡</span><br><span class="line">      </span><br><span class="line">      parameterHandlers = new ParameterHandler&lt;?&gt;[parameterCount];</span><br><span class="line">      for (int p = 0; p &lt; parameterCount; p++) &#123;</span><br><span class="line">        Type parameterType = parameterTypes[p];</span><br><span class="line">        Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</span><br><span class="line">        // ä¸ºæ–¹æ³•ä¸­çš„æ¯ä¸ªå‚æ•°åˆ›å»ºä¸€ä¸ªParameterHandler&lt;?&gt;å¯¹è±¡å¹¶è§£ææ¯ä¸ªå‚æ•°ä½¿ç”¨çš„æ³¨è§£ç±»å‹</span><br><span class="line">        // è¯¥å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹å°±æ˜¯å¯¹æ–¹æ³•å‚æ•°ä¸­æ³¨è§£è¿›è¡Œè§£æ</span><br><span class="line">        // è¿™é‡Œçš„æ³¨è§£åŒ…æ‹¬ï¼šBodyã€PartMapã€Partã€FieldMapã€Fieldã€Headerã€QueryMapã€Queryã€Pathã€Url </span><br><span class="line">        parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</span><br><span class="line">      &#125; </span><br><span class="line">      return new ServiceMethod&lt;&gt;(this);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>å°ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>1 æ ¹æ®è¿”å›å€¼ç±»å‹å’Œæ–¹æ³•æ ‡æ³¨ä»Retrofitå¯¹è±¡çš„çš„ç½‘ç»œè¯·æ±‚é€‚é…å™¨å·¥å‚é›†åˆå’Œå†…å®¹è½¬æ¢å™¨å·¥å‚é›†åˆä¸­åˆ†åˆ«è·å–åˆ°è¯¥æ–¹æ³•å¯¹åº”çš„ç½‘ç»œè¯·æ±‚é€‚é…å™¨å’ŒResponseå†…å®¹è½¬æ¢å™¨ï¼›</li>
<li>2 æ ¹æ®æ–¹æ³•çš„æ ‡æ³¨å¯¹ServiceMethodçš„åŸŸè¿›è¡Œèµ‹å€¼</li>
<li>3 æœ€åä¸ºæ¯ä¸ªæ–¹æ³•çš„å‚æ•°çš„æ ‡æ³¨è¿›è¡Œè§£æï¼Œè·å¾—ä¸€ä¸ªParameterHandler&lt;?&gt;å¯¹è±¡<br>è¯¥å¯¹è±¡ä¿å­˜æœ‰ä¸€ä¸ªRequestå†…å®¹è½¬æ¢å™¨â€”â€”æ ¹æ®å‚æ•°çš„ç±»å‹ä»Retrofitçš„å†…å®¹è½¬æ¢å™¨å·¥å‚é›†åˆä¸­è·å–ä¸€ä¸ªRequestå†…å®¹è½¬æ¢å™¨æˆ–è€…ä¸€ä¸ªStringå†…å®¹è½¬æ¢å™¨ã€‚</li>
</ul>
<h3 id="æ‰§è¡Œç½‘ç»œè¯·æ±‚"><a href="#æ‰§è¡Œç½‘ç»œè¯·æ±‚" class="headerlink" title="æ‰§è¡Œç½‘ç»œè¯·æ±‚"></a>æ‰§è¡Œç½‘ç»œè¯·æ±‚</h3><p>OkHttpCallæä¾›äº†ä¸¤ç§ç½‘ç»œè¯·æ±‚æ–¹å¼:</p>
<ul>
<li>1 åŒæ­¥è¯·æ±‚ï¼šOkHttpCall.execute()</li>
<li>2 å¼‚æ­¥è¯·æ±‚ï¼šOkHttpCall.enqueue()<br>åˆ°è¿™å°±éƒ½æ˜¯okhttpçš„ä¸œè¥¿äº†</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/25/HTTPå­¦ä¹ æ€»ç»“/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/25/HTTPå­¦ä¹ æ€»ç»“/" itemprop="url">httpå­¦ä¹ æ€»ç»“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-02-25T00:00:00+08:00">
                2020-02-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/25/HTTPå­¦ä¹ æ€»ç»“/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/02/25/HTTPå­¦ä¹ æ€»ç»“/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="å…³äºhttp"><a href="#å…³äºhttp" class="headerlink" title="å…³äºhttp"></a>å…³äºhttp</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>HTTPæ˜¯ä¸€ç§ç”¨äºåœ¨é€šä¿¡åŒæ–¹(é€šå¸¸æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯)ä¼ è¾“æ•°æ®(åŒ…æ‹¬ä½†ä¸é™äºå›¾ç‰‡ã€æ–‡æœ¬ã€éŸ³é¢‘ç­‰)çš„å¯é çš„æ•°æ®ä¼ è¾“åè®®ï¼Œè€Œä¸”æ˜¯åŸºäºTCPçš„åº”ç”¨å±‚åè®®ï¼Œä»æ›´é«˜å±‚æ¬¡å°è£…äº†TCPçš„ä½¿ç”¨ç»†èŠ‚ï¼Œä½¿å¾—ç½‘ç»œæ“ä½œæ›´ä¸ºç®€å•ã€‚</p>
<h3 id="è¯·æ±‚æ–¹å¼"><a href="#è¯·æ±‚æ–¹å¼" class="headerlink" title="è¯·æ±‚æ–¹å¼"></a>è¯·æ±‚æ–¹å¼</h3><p><img src="https://s2.ax1x.com/2020/02/24/3G7ajS.png" alt="å›¾ç‰‡"><br>HTTPåè®®æä¾›äº†å‡ ç§è¯·æ±‚æ–¹å¼ï¼Œå¤§å®¶ç†ŸçŸ¥çš„è¯·æ±‚æ–¹å¼æœ‰8ç§GETã€POSTã€DELETEã€PUTã€HEADã€TRACEã€OPTIONSã€CONNECTï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯PUTï¼ˆå¢ï¼‰ã€DELETE(åˆ )ã€POSTï¼ˆæ”¹ï¼‰ã€GETï¼ˆæŸ¥ï¼‰ã€‚</p>
<ul>
<li>get è·å–èµ„æºï¼šå®¢æˆ·ç«¯é€šè¿‡URLè·å–æœåŠ¡ç«¯ä¸­çš„æŸä¸ªèµ„æºï¼Œè¯·æ±‚å‚æ•°æ”¾åœ¨URLä¸­ï¼Œç„¶åæœåŠ¡ç«¯è¿”å›å¯¹åº”èµ„æºç»™å®¢æˆ·ç«¯</li>
<li>post ä¼ è¾“å®ä½“ä¸»ä½“ï¼šPOSTè¯·æ±‚é€šå¸¸ä¼šç”¨æ¥æäº¤HTMLè¡¨å•ï¼ŒæŠŠæ•°æ®å¡«åœ¨è¡¨å•ä¸­ï¼Œä¼ ç»™æœåŠ¡å™¨ï¼Œç„¶åæœåŠ¡å™¨å¯¹è¿™äº›æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè™½ç„¶GETæ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥ä¼ è¾“ä¸»ä½“å®ä½“ï¼Œä½†æ˜¯ä¸€èˆ¬é‡‡ç”¨POSTæ–¹æ³•</li>
<li>put ä¼ è¾“æ–‡ä»¶ï¼šä¸GETç›¸åï¼ŒPUTå‘æœåŠ¡å™¨å†™å…¥æ•°æ®ï¼Œä¸€èˆ¬ç”¨æ¥ä¼ è¾“æ–‡ä»¶ï¼ŒæŠŠéœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ”¾åœ¨è¯·æ±‚æŠ¥æ–‡çš„ä¸»ä½“ä¸Šï¼Œç„¶åä¿å­˜åˆ°URLæŒ‡å®šçš„ä½ç½®</li>
<li>delete åˆ é™¤æ–‡ä»¶ï¼šä¸PUTç›¸åï¼ŒDELETEè¯·æ±‚æ±‚æœåŠ¡å™¨åˆ é™¤URLæ‰€æŒ‡å®šçš„èµ„æºï¼Œè¯·æ±‚å‚æ•°æ”¾åœ¨URLä¸­ï¼Œä½†æ˜¯æœåŠ¡ç«¯å¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸çŸ¥æƒ…ä¸‹æ’¤é”€æ­¤è¯·æ±‚</li>
<li>head è·å–æŠ¥æ–‡é¦–éƒ¨ï¼šHEADä¸GETç±»ä¼¼ï¼Œä½†æœåŠ¡å™¨åœ¨å“åº”ä¸­åªè¿”å›é¦–éƒ¨ä¸ä¼šè¿”å›ä¸»ä½“éƒ¨åˆ†ï¼ŒHEADæ˜¯ç”¨æ¥åœ¨ä¸è·å–èµ„æºçš„æƒ…å†µä¸‹è·å–èµ„æºçš„é¦–éƒ¨è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æŸ¥çœ‹å“åº”çš„çŠ¶æ€ç ï¼Œçœ‹çœ‹èµ„æºæ˜¯å¦è¢«ä¿®æ”¹ï¼Œå¯¹è±¡æ˜¯å¦å­˜åœ¨</li>
<li>trace è¿½è¸ªè·¯å¾„ï¼šå®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå¯èƒ½è¦ç©¿è¿‡é˜²ç«å¢™ï¼Œä»£ç†ï¼Œç½‘å…³ç­‰ï¼Œæ¯ä¸€ä¸ªä¸­é—´ç‚¹éƒ½ä¼šä¿®æ”¹HTTPåŸå§‹è¯·æ±‚æŠ¥æ–‡ï¼ŒTRACEå…è®¸è¯·æ±‚æœ€ç»ˆå‘é€ç»™æœåŠ¡ç«¯æ—¶ï¼Œçœ‹çœ‹å®ƒæœ€ç»ˆå˜æˆä»€ä¹ˆæ ·ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€ç 200 OKçš„å“åº”æŠ¥æ–‡ï¼ŒæŠ¥æ–‡ä¸»ä½“åŒ…å«äº†TARCEä¿¡æ¯</li>
<li>options è¯¢é—®æ”¯æŒçš„æ–¹æ³•ï¼šOPTIONSè¯¢é—®æœåŠ¡ç«¯æ”¯æŒçš„ç”¨æ¥æŸ¥è¯¢æŒ‡å®šURLèµ„æºçš„æ–¹æ³•ï¼Œè¿™å°±è®©å®¢æˆ·ç«¯ä¸ç”¨è®¿é—®é‚£äº›å®é™…çš„èµ„æºå°±èƒ½åˆ¤å®šè®¿é—®å„ç§èµ„æºçš„æœ€ä¼˜æ–¹æ³•</li>
<li>connect è¦æ±‚ä½¿ç”¨éš§é“åè®®è¿æ¥ä»£ç†ï¼šCONNECTè¦æ±‚åœ¨ä¸ä»£ç†æœåŠ¡å™¨é€šä¿¡æ—¶å»ºç«‹éš§é“ï¼Œå®ç°ç”¨éš§é“è¿›è¡ŒTCPé€šä¿¡ï¼Œéš§é“å°±æ˜¯ç»è¿‡åŠ å¯†çš„é€šä¿¡ä¿¡è·¯ï¼Œä¸€èˆ¬ä½¿ç”¨SSL/TLSåè®®æŠŠé€šä¿¡å†…å®¹åŠ å¯†åç»éš§é“ä¼ è¾“</li>
</ul>
<h3 id="æŠ¥æ–‡æ ¼å¼"><a href="#æŠ¥æ–‡æ ¼å¼" class="headerlink" title="æŠ¥æ–‡æ ¼å¼"></a>æŠ¥æ–‡æ ¼å¼</h3><p>ç”¨äºHTTPåè®®äº¤æ¢çš„ä¿¡æ¯ç§°ä¸ºHTTPæŠ¥æ–‡ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPæŠ¥æ–‡å«åšè¯·æ±‚æŠ¥æ–‡ï¼ŒæœåŠ¡ç«¯è¿”å›çš„HTTPæŠ¥æ–‡å«åšå“åº”æŠ¥æ–‡ï¼Œå®ƒä»¬éƒ½æ˜¯ç”±å¤šè¡Œæ•°æ®æ„æˆçš„å­—ç¬¦ä¸²æ–‡æœ¬<br><img src="https://s2.ax1x.com/2020/02/24/3GqajK.png" alt="æ ¼å¼å¦‚å›¾"><br>å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»</p>
<h4 id="è¯·æ±‚æŠ¥æ–‡"><a href="#è¯·æ±‚æŠ¥æ–‡" class="headerlink" title="è¯·æ±‚æŠ¥æ–‡"></a>è¯·æ±‚æŠ¥æ–‡</h4><p>ä¸€ä¸ªHTTPçš„è¯·æ±‚æŠ¥æ–‡é€šå¸¸ç”±è¯·æ±‚è¡Œï¼Œè¯·æ±‚é¦–éƒ¨ï¼Œç©ºè¡Œ(CR + LF)ï¼Œè¯·æ±‚ä¸»ä½“4ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå¦‚å›¾ï¼š<br><img src="https://s2.ax1x.com/2020/02/24/3GXN3n.png" alt="å›¾ç‰‡"><br>ä¸‹é¢åˆ†åˆ«ä»¥getè¯·æ±‚å’Œpostè¯·æ±‚ä¸ºä¾‹</p>
<h5 id="GETçš„è¯·æ±‚æŠ¥æ–‡"><a href="#GETçš„è¯·æ±‚æŠ¥æ–‡" class="headerlink" title="GETçš„è¯·æ±‚æŠ¥æ–‡"></a>GETçš„è¯·æ±‚æŠ¥æ–‡</h5><p>å¯¹äºGETæ–¹æ³•æ¥è¯´ï¼Œå®ƒæ‰€æœ‰çš„è¯·æ±‚å‚æ•°éƒ½æ˜¯æ‹¼æ¥åœ¨URLæœ€åï¼Œç¬¬ä¸€ä¸ªå‚æ•°å‰é€šè¿‡â€?â€è¿æ¥ï¼Œç„¶åè¯·æ±‚å‚æ•°æŒ‰ç…§â€key=valueâ€æ ¼å¼è¿›è¡Œè¿½åŠ ï¼Œæ¯ä¸ªè¯·æ±‚å‚æ•°ä¹‹é—´é€šè¿‡â€&amp;â€è¿æ¥ï¼Œå¦‚ ï¼š<br><a href="http://www.myhost.com/text/?id=1&amp;â€¦" target="_blank" rel="noopener">www.myhost.com/text/?id=1&amp;â€¦</a><br>è¿™ä¸ªURLå¯¹äºGETè¯·æ±‚è¡¨ç¤ºè·å– <a href="http://www.myhost.com/text/" target="_blank" rel="noopener">www.myhost.com/text/</a> ä½ç½®ä¸‹ç”¨æˆ·idä¸º1ï¼Œåä¸ºrainçš„æ–‡æœ¬ï¼Œç›¸åº”çš„è¯·æ±‚æŠ¥æ–‡æ ¼å¼å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /text/?id=1&amp;name=rain HTTP/1.1</span><br><span class="line">Host: www.myhost.com</span><br><span class="line">Cache-Control: no-cache</span><br></pre></td></tr></table></figure></p>
<p>ä»ä¸Šé¢çš„HTTPè¯·æ±‚æŠ¥æ–‡æ ¼å¼çŸ¥ï¼Œç¬¬ä¸€è¡Œä¸ºè¯·æ±‚è¡Œï¼Œè¡¨æ˜è¯·æ±‚æ–¹å¼ä¸ºGETï¼Œå­è·¯å¾„ä¸º /text/?id=1&amp;name=rainï¼ŒHTTPç‰ˆæœ¬ä¸º1.1ï¼Œåä¸¤è¡Œä¸ºè¯·æ±‚é¦–éƒ¨ï¼ŒHostä¸ºä¸»æœºåœ°å€ï¼ŒCache-Controlä¸ºno-cacheï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ä¸æ¥å—æœåŠ¡ç«¯ç¼“å­˜è¿‡çš„èµ„æºï¼Œè€ŒGETçš„è¯·æ±‚å‚æ•°éƒ½åœ¨URLä¸­ï¼Œæ‰€ä»¥è¯·æ±‚ä¸»ä½“ä¸ºç©ºã€‚</p>
<h5 id="POSTçš„è¯·æ±‚æŠ¥æ–‡"><a href="#POSTçš„è¯·æ±‚æŠ¥æ–‡" class="headerlink" title="POSTçš„è¯·æ±‚æŠ¥æ–‡"></a>POSTçš„è¯·æ±‚æŠ¥æ–‡</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /local/ HTTP/1.1</span><br><span class="line">Host: www.myhost.com</span><br><span class="line">Accept-Encodingï¼šgzip</span><br><span class="line">Content-Length: 222222</span><br><span class="line">Content-Type: multipart/from-dataï¼›boundary=dRGP2cPPTxE6WRTssnh4jC7HJLcSde</span><br><span class="line">Connectionï¼šKeep-Alive</span><br><span class="line"></span><br><span class="line">--dRGP2cPPTxE6WRTssnh4jC7HJLcSde</span><br><span class="line">Content-Dispositionï¼šfrom-dataï¼›name=â€œusernameâ€  //name = username</span><br><span class="line">Content-Typeï¼štext/plainï¼šcharset=UTF-8</span><br><span class="line">Content-Transfer-Encoding: 8bit</span><br><span class="line"></span><br><span class="line">rain										//value = rain</span><br><span class="line">--dRGP2cPPTxE6WRTssnh4jC7HJLcSde</span><br><span class="line">Content-Diaposition:from-data:name=&quot;image&quot;      //name = image</span><br><span class="line">filename=&quot;/storage/emulated/0/image/1234.png&quot;</span><br><span class="line">Content-Type:application/octet-stream</span><br><span class="line">Content-Transfer-Encoding:binary</span><br><span class="line"></span><br><span class="line">//...çœç•¥äºŒè¿›åˆ¶æ•°æ®					        //value = äºŒè¿›åˆ¶æ•°æ®</span><br><span class="line">--dRGP2cPPTxE6WRTssnh4jC7HJLcSde--</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°çš„è¯·æ±‚æŠ¥æ–‡çš„å«ä¹‰æ˜¯å‘  <a href="http://www.myhost.com/local/" target="_blank" rel="noopener">www.myhost.com/local/</a>  è¿™ä¸ªåœ°å€å‘é€ä¸€ä¸ªPOSTè¯·æ±‚ï¼Œæ¥å—çš„å†…å®¹ç¼–ç æ–¹å¼ä¸ºgzipï¼Œè¯·æ±‚çš„æ•°æ®é•¿åº¦ä¸º222222å­—èŠ‚ï¼Œè¯·æ±‚çš„æ•°æ®æ ¼å¼ä¸º multipart/from-dataï¼ˆè¡¨å•ï¼‰ï¼ŒæŠ¥æ–‡çš„boundaryå€¼ä¸ºdRGP2cPPTxE6WRTssnh4jC7HJLcSdeï¼ŒKeep-Aliveä¸ºå¼€å¯é•¿è¿æ¥ï¼Œç©ºè¡Œä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¯·æ±‚æŠ¥æ–‡çš„ä¸»ä½“ï¼Œä¸»ä½“æœ‰ä¸¤ä¸ªè¯·æ±‚å‚æ•°ï¼š<br>ä¸€ä¸ªæ˜¯åä¸ºusernameï¼Œå€¼ä¸ºrainçš„æ–‡æœ¬ï¼›<br>ä¸€ä¸ªæ˜¯åä¸ºimageï¼Œå€¼ä¸ºäºŒè¿›åˆ¶æ•°æ®çš„å›¾ç‰‡.</p>
<h4 id="å“åº”æŠ¥æ–‡"><a href="#å“åº”æŠ¥æ–‡" class="headerlink" title="å“åº”æŠ¥æ–‡"></a>å“åº”æŠ¥æ–‡</h4><p>ä¸€ä¸ªHTTPçš„å“åº”æŠ¥æ–‡é€šå¸¸ç”±çŠ¶æ€è¡Œã€å“åº”é¦–éƒ¨ã€ç©ºè¡Œ(CR + LF)ã€å“åº”ä¸»ä½“ç»„æˆ<br><img src="https://s2.ax1x.com/2020/02/24/3Gx9cn.png" alt="æ ¼å¼å¦‚å›¾"><br>æ¯”å¦‚è¿™æ˜¯ä¸€ä¸ªGETè¯·æ±‚çš„è¿”å›çš„å“åº”æŠ¥æ–‡æ ¼å¼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP1.1 200 OK</span><br><span class="line">Data:Sat, 30, Dec 2006 23:23:00 GMT</span><br><span class="line">Content-Type:text/htmlï¼›charset=UTF-8</span><br><span class="line">Content-Length:852</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;zh-CN&quot;&gt;</span><br><span class="line">	//...çœç•¥æ–‡æ¡£å†…å®¹</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢HTTPå“åº”æŠ¥æ–‡è¡¨ç¤ºï¼ŒHTTPåè®®ç‰ˆæœ¬ä¸º1.1ï¼Œå“åº”çŠ¶æ€ç ä¸º200ï¼Œè¡¨ç¤ºè¯·æ±‚æˆåŠŸï¼Œè¿”å›æ•°æ®çš„ç±»å‹ä¸ºtext/htmlï¼ˆhtmlï¼‰, ç¼–ç ä¸ºUTF-8ï¼Œè¿”å›æ•°æ®çš„å†…å®¹é•¿åº¦ä¸º852å­—èŠ‚ï¼Œç©ºè¡Œä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿”å›çš„æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªhtmlæ–‡æ¡£</p>
<h3 id="çŠ¶æ€ç "><a href="#çŠ¶æ€ç " class="headerlink" title="çŠ¶æ€ç "></a>çŠ¶æ€ç </h3><p>çŠ¶æ€ç çš„èŒè´£æ˜¯å½“å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œæè¿°æœåŠ¡ç«¯è¿”å›çš„è¯·æ±‚ç»“æœï¼Œå€ŸåŠ©çŠ¶æ€ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—çŸ¥æœåŠ¡ç«¯æ˜¯æ­£å¸¸å¤„ç†äº†è¯·æ±‚ï¼Œè¿˜æ˜¯å‡ºç°äº†é”™è¯¯ï¼Œä¸‹é¢æ˜¯å¼€å‘ä¸­ç»å¸¸é‡è§çš„çŠ¶æ€ç ï¼š</p>
<h4 id="2XXæˆåŠŸ"><a href="#2XXæˆåŠŸ" class="headerlink" title="2XXæˆåŠŸ"></a>2XXæˆåŠŸ</h4><p>2XXçš„å“åº”ç»“æœè¡¨ç¤ºè¯·æ±‚è¢«æ­£å¸¸å¤„ç†äº†.</p>
<ul>
<li>200 OKï¼šè¯·æ±‚æ²¡æœ‰é—®é¢˜ï¼Œå®ä½“çš„ä¸»ä½“éƒ¨åˆ†åŒ…å«äº†æ‰€è¯·æ±‚çš„èµ„æº</li>
<li>204 No Contentï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡ç«¯æ¥æ”¶çš„è¯·æ±‚å·²æˆåŠŸå¤„ç†ï¼Œä½†æ˜¯åœ¨è¿”å›çš„å“åº”æŠ¥æ–‡ä¸­ä¸åŒ…å«ä¸»ä½“éƒ¨åˆ†ï¼Œè¿™è¯´æ˜è¯·æ±‚å¤„ç†æˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•èµ„æºè¿”å›ã€‚æ¯”å¦‚å½“æµè§ˆå™¨å‘å‡ºçš„è¯·æ±‚å¤„ç†åï¼Œè¿”å›204å“åº”ï¼Œé‚£ä¹ˆæµè§ˆå™¨æ˜¾ç¤ºçš„é¡µé¢å°†ä¸ä¼šå‘ç”Ÿä»»ä½•æ›´æ–°ï¼›</li>
<li>206 Partial Content: è¯¥çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è¿›è¡Œäº†èŒƒå›´è¯·æ±‚ï¼Œè€ŒæœåŠ¡ç«¯æˆåŠŸè¿”å›äº†è¿™ä¸€éƒ¨åˆ†èŒƒå›´çš„èµ„æºï¼Œå³å“åº”æŠ¥æ–‡çš„ä¸»ä½“éƒ¨åˆ†ä¸­ä¼šåŒ…å«ç”±Content-RangeæŒ‡å®šèŒƒå›´çš„å†…å®¹ã€‚</li>
</ul>
<h4 id="3XXé‡å®šå‘"><a href="#3XXé‡å®šå‘" class="headerlink" title="3XXé‡å®šå‘"></a>3XXé‡å®šå‘</h4><p>é‡å®šå‘çŠ¶æ€ç è¦ä¹ˆå‘ŠçŸ¥å®¢æˆ·ç«¯ä½¿ç”¨æ›¿ä»£ä½ç½®æ¥è®¿é—®ä»–ä»¬æ‰€æ„Ÿå…´è¶£çš„èµ„æºï¼Œè¦ä¹ˆå°±æä¾›ä¸€ä¸ªæ›¿ä»£çš„å“åº”è€Œä¸æ˜¯èµ„æºçš„å†…å®¹ã€‚å¦‚æœèµ„æºå·²ç»è¢«ç§»èµ°ï¼Œå¯å‘é€ä¸€ä¸ªé‡å®šå‘çŠ¶æ€ç å’Œä¸€ä¸ªå¯é€‰çš„Locationé¦–éƒ¨æ¥å‘ŠçŸ¥å®¢æˆ·ç«¯èµ„æºå·²ç»è¢«ç§»èµ°ï¼Œä»¥åŠç°åœ¨å¯ä»¥åœ¨å“ªé‡Œæ‰¾åˆ°å®ƒã€‚æµè§ˆå™¨å°±å¯ä»¥åœ¨ä¸å½±å“ç”¨æˆ·æµè§ˆä½“éªŒçš„æƒ…å†µä¸‹é€æ˜åœ°åœ¨æ–°çš„ä½ç½®æ‰¾åˆ°æ‰€éœ€èµ„æºäº†ã€‚</p>
<ul>
<li>301 Moved Permanentlyï¼šæ°¸ä¹…æ€§é‡å®šå‘ï¼Œè¯¥çŠ¶æ€ç è¡¨ç¤ºè¯·æ±‚çš„èµ„æºå·²è¢«åˆ†é…äº†æ–°çš„URLï¼Œä»¥åéƒ½åº”ä½¿ç”¨æ–°çš„URLæ¥è®¿é—®è¯¥èµ„æºï¼Œè¿™æ—¶å“åº”æŠ¥æ–‡é¦–éƒ¨çš„Locationå­—æ®µä¼šæç¤ºæ–°çš„URLã€‚ä¾‹å¦‚ä½ ä½¿ç”¨è¿™ä¸ªæœ€åå¿˜è®°åŠ æ–œæ  / çš„åœ°å€ <a href="http://www.myhost.com" target="_blank" rel="noopener">www.myhost.com</a> æ¥è®¿é—®æœåŠ¡ç«¯ï¼Œå°±ä¼šè¿”å›301çŠ¶æ€ç ï¼Œæç¤ºä½ ä½¿ç”¨æ­£ç¡®çš„åœ°å€è®¿é—®ï¼Œä¸è¿‡è¿™äº›é‡å®šå‘çš„æ“ä½œæµè§ˆå™¨åœ¨èƒŒåå·²ç»æ›¿æˆ‘ä»¬å¤„ç†äº†ï¼Œæ‰€ä»¥ç”¨æˆ·æ˜¯æ— æ³•æ„ŸçŸ¥çš„ï¼›</li>
<li>302 Foundï¼šä¸´æ—¶é‡å®šå‘ï¼Œè¯¥çŠ¶æ€ç è¡¨ç¤ºè¯·æ±‚çš„èµ„æºæš‚æ—¶è¢«åˆ†é…äº†æ–°çš„URLï¼Œæœ¬æ¬¡åº”ä½¿ç”¨æ–°çš„URLæ¥è®¿é—®è¯¥èµ„æºï¼Œ302ä»£è¡¨èµ„æºä¸æ˜¯è¢«æ°¸ä¹…ç§»åŠ¨ï¼Œè€Œæ˜¯ä¸´æ—¶ç§»åŠ¨ï¼Œå³æœ¬æ¬¡ä¼šé‡å®šå‘åˆ°åœ°å€aï¼Œä¸‹ä¸€æ¬¡å¯èƒ½ä¼šé‡å®šå‘åˆ°åœ°å€bæˆ–è€…ä¸å˜ï¼Œæ‰€ä»¥å“åº”æŠ¥æ–‡é¦–éƒ¨çš„Locationå­—æ®µæç¤ºçš„æ–°URLå¹¶ä¸æ˜¯æ°¸ä¹…æ€§çš„ï¼Œè€Œæ˜¯ä¸´æ—¶æ€§çš„ï¼›</li>
<li>303 See Otherï¼šä¸´æ—¶é‡å®šå‘ï¼Œè¯¥çŠ¶æ€ç è¡¨ç¤ºè¯·æ±‚çš„èµ„æºæš‚æ—¶è¢«åˆ†é…äº†æ–°çš„URLï¼Œæœ¬æ¬¡åº”ä½¿ç”¨æ–°çš„URLé€šè¿‡GETæ–¹æ³•æ¥è®¿é—®è¯¥èµ„æºï¼Œ303å’Œ302åŠŸèƒ½ç›¸ä¼¼ï¼Œä½†æ˜¯303æ˜ç¡®è¡¨ç¤ºå®¢æˆ·ç«¯é‡å®šå‘æ—¶åº”é‡‡ç”¨GETæ–¹æ³•è·å–èµ„æºï¼Œè€Œ302å°±æ²¡æœ‰è¿™ä¸ªè¦æ±‚ã€‚ï¼ˆä½†æ˜¯åœ¨ç°å®ä¸­ï¼Œå¤§éƒ¨åˆ†æµè§ˆå™¨éƒ½æ²¡æœ‰éµå¾ªè§„èŒƒï¼Œä¸ç®¡æ˜¯301ã€302è¿˜æ˜¯303ï¼Œéƒ½ä¼šæŠŠPOSTæ”¹æˆGETï¼Œç„¶åé‡æ–°è·å–èµ„æºï¼‰ï¼›</li>
<li>304 Not Modifiedï¼š304è™½ç„¶è¢«åˆ’åˆ†åœ¨3XXä¸­ï¼Œä½†æ˜¯å®ƒå’Œé‡å®šå‘æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè¯¥çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è®¿é—®çš„èµ„æºå­˜åœ¨ï¼Œä½†æ˜¯æœªç¬¦åˆè¯·æ±‚çš„é™„å¸¦æ¡ä»¶ï¼Œä¸å…è¿”å›ï¼Œè¿™æ—¶è¿”å›çš„304å“åº”æŠ¥æ–‡ä¸åŒ…å«ä¸»ä½“éƒ¨åˆ†ï¼Œè¯·æ±‚çš„é™„å¸¦æ¡ä»¶æ˜¯æŒ‡è¯·æ±‚æŠ¥æ–‡ä¸­åŒ…å«If-Matchï¼ŒIf-Modified-Sinceï¼ŒIf-None-Matchï¼ŒIf-Rangeï¼ŒIf-Unmodified-Sinceä¸­ä»»ä¸€é¦–éƒ¨ã€‚ä¾‹å¦‚å®¢æˆ·ç«¯æƒ³è¦æ£€æŸ¥æœ¬åœ°èµ„æºç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œå°±åœ¨GETè¯·æ±‚ä¸­é™„å¸¦If-Modified-Sinceæ¡ä»¶ï¼ŒIf-Modified-Sinceçš„å€¼æ˜¯æœ¬åœ°èµ„æºçš„Last-Modified(ä¸Šä¸€æ¬¡ä¿®æ”¹æ—¶é—´)çš„å€¼ï¼ŒæœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚åï¼Œå°±ä¼šæ£€æŸ¥èµ„æºåœ¨æœåŠ¡ç«¯çš„ä¸Šä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´æ˜¯å¦æ¯”If-Modified-Sinceçš„å€¼æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜èµ„æºæ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œè¿”å›304å“åº”æŠ¥æ–‡ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚</li>
</ul>
<h4 id="4XXå®¢æˆ·ç«¯é”™è¯¯"><a href="#4XXå®¢æˆ·ç«¯é”™è¯¯" class="headerlink" title="4XXå®¢æˆ·ç«¯é”™è¯¯"></a>4XXå®¢æˆ·ç«¯é”™è¯¯</h4><p>4XXçš„å“åº”ç»“æœè¡¨ç¤ºå®¢æˆ·ç«¯å‘ç”Ÿé”™è¯¯çš„åŸå› æ‰€åœ¨.</p>
<ul>
<li>400 Bad Requestï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯çš„è¯·æ±‚æŠ¥æ–‡ä¸­æœ‰è¯­æ³•é”™è¯¯ï¼Œä¸èƒ½è¢«æœåŠ¡ç«¯ç†è§£ï¼Œå½“å‘ç”Ÿè¯¥é”™è¯¯åéœ€è¦ä¿®æ”¹è¯·æ±‚å†…å®¹åå†æ¬¡å‘é€ï¼›</li>
<li>401 Unauthorizedï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºå‘é€çš„è¯·æ±‚éœ€è¦æœ‰é€šè¿‡HTTPè®¤è¯çš„è®¤è¯ä¿¡æ¯ï¼Œ401çš„å“åº”æŠ¥æ–‡ä¼šåŒ…å«ä¸€ä¸ªè¢«è¯·æ±‚èµ„æºçš„WWW-Authenticateé¦–éƒ¨ç”¨æ¥è´¨è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå½“æµè§ˆå™¨åˆæ¬¡æ¥æ”¶åˆ°401å“åº”ï¼Œä¼šå¼¹å‡ºè®¤è¯çª—å£ï¼Œå½“æµè§ˆå™¨ç¬¬äºŒæ¬¡æ”¶åˆ°401å“åº”ï¼Œè¡¨ç¤ºè®¤è¯å¤±è´¥ï¼›</li>
<li>403 Forbiddenï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡ç«¯æ”¶åˆ°äº†è¯·æ±‚ï¼Œä½†æ˜¯æ‹’ç»æä¾›æœåŠ¡ï¼ŒæœåŠ¡ç«¯ä¸ä¼šç»™å‡ºæ‹’ç»çš„è¯¦ç»†ç†ç”±ï¼Œä¾‹å¦‚æ²¡æœ‰æ–‡ä»¶çš„è®¿é—®æƒé™ç­‰éƒ½ä¼šè¿”å›404å“åº”ï¼›</li>
<li>404 Not Foundï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºè¯·æ±‚èµ„æºåœ¨æœåŠ¡ç«¯ä¸Šä¸å­˜åœ¨ï¼Œæˆ–è€…æœåŠ¡ç«¯æ‹’ç»è¯·æ±‚ä½†ä¸æƒ³è¯´æ˜ç†ç”±ä¹Ÿä¼šè¿”å›404ï¼›</li>
</ul>
<h4 id="5XXæœåŠ¡ç«¯é”™è¯¯"><a href="#5XXæœåŠ¡ç«¯é”™è¯¯" class="headerlink" title="5XXæœåŠ¡ç«¯é”™è¯¯"></a>5XXæœåŠ¡ç«¯é”™è¯¯</h4><p>5XXçš„å“åº”ç»“æœè¡¨ç¤ºæœåŠ¡ç«¯å‘é€é”™è¯¯çš„åŸå› æ‰€åœ¨.</p>
<ul>
<li>500 Internal Server Errorï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡ç«¯æ‰§è¡Œè¯·æ±‚æ—¶å‘ç”Ÿäº†ä¸å¯é¢„ä¼°çš„é”™è¯¯ï¼Œå®ƒè¡¨æ˜æœåŠ¡ç«¯Webåº”ç”¨å­˜åœ¨bugæˆ–å…¶ä»–æ•…éšœï¼›</li>
<li>503 Server Unavailableï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡ç«¯å½“å‰ä¸èƒ½å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä¸€æ®µæ—¶é—´åå¯èƒ½æ¢å¤æ­£å¸¸ï¼Œå®ƒè¡¨æ˜æœåŠ¡ç«¯æš‚æ—¶å¤„äºè¶…è´Ÿè½½æˆ–åœæœºç»´æŠ¤çŠ¶æ€ï¼Œå¦‚æœæœåŠ¡ç«¯å¾—çŸ¥æ•…éšœæ¢å¤æ—¶é—´ï¼Œå®ƒä¼šåœ¨å“åº”æŠ¥æ–‡çš„Retry-Afteré¦–éƒ¨å­—æ®µå†™å…¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
</ul>
<h3 id="Cookieä¸Session"><a href="#Cookieä¸Session" class="headerlink" title="Cookieä¸Session"></a>Cookieä¸Session</h3><h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><p>Cookieæ˜¯ç”¨æ¥ç®¡ç†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„çŠ¶æ€ï¼Œå®ƒæ˜¯æœåŠ¡å™¨å‘é€åˆ°å®¢æˆ·ç«¯å¹¶ä¿å­˜åœ¨æœ¬åœ°çš„å°å‹æ–‡æœ¬æ–‡ä»¶ï¼Œå…¶å†…å®¹ä¸ºä¸€ç³»åˆ—çš„é”®å€¼å¯¹ï¼ŒCookieå¹¶ä¸å±äºHTTP/1.xçš„è§„èŒƒï¼Œä½†æ˜¯ç”±äºHTTPçš„æ— çŠ¶æ€ç‰¹æ€§ï¼ŒCookieè¢«å¹¿æ³›åº”ç”¨äºå„å¤§Webç½‘ç«™çš„çŠ¶æ€ç®¡ç†åŠç”¨æˆ·è¯†åˆ«ã€‚<br>Cookieçš„å·¥ä½œè¿‡ç¨‹ä¸»è¦ä½¿ç”¨åˆ°äº†Set-Cookieå’ŒCookieè¿™ä¸¤ä¸ªé¦–éƒ¨ï¼ŒSet-Cookieé¦–éƒ¨å­˜åœ¨äºå“åº”æŠ¥æ–‡ä¸­ï¼ŒSet-Cookieé¦–éƒ¨åŒ…å«æœåŠ¡ç«¯è¿”å›ç»™å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†ä½¿ç”¨çš„Cookieä¿¡æ¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°å“åº”åä¼šä»Set-Cookieé¦–éƒ¨ä¸­å–å‡ºCookieä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°ï¼›Cookieé¦–éƒ¨å­˜åœ¨äºè¯·æ±‚æŠ¥æ–‡ä¸­ï¼ŒCookieé¦–éƒ¨åŒ…å«å®¢æˆ·ç«¯ä»æœåŠ¡ç«¯æ¥æ”¶åˆ°çš„Cookieä¿¡æ¯ï¼Œæ¯æ¬¡å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šåœ¨è¯·æ±‚æŠ¥æ–‡çš„Cookieé¦–éƒ¨ä¸­æºå¸¦Cookieä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚</p>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p>Cookieéœ€è¦å’ŒæœåŠ¡ç«¯çš„Sessioné…åˆä½¿ç”¨ï¼ŒCookieæ˜¯å­˜å‚¨åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œè€ŒSessionæ˜¯å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ä¸­ï¼ŒSessionæ˜¯æœåŠ¡ç«¯ä¿å­˜ç”¨æˆ·çŠ¶æ€çš„æ–¹å¼ï¼Œå®ƒä»¬çš„å·¥ä½œè¿‡ç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<ul>
<li>1 å½“ç”¨æˆ·ç™»é™†ç½‘ç«™æ—¶ï¼Œå¡«å…¥è´¦å·ã€å¯†ç ç­‰ä¿¡æ¯ï¼Œç„¶åæäº¤è¡¨å•ï¼Œè¿™äº›ä¿¡æ¯ä¼šè¢«æ”¾å…¥HTTPçš„è¯·æ±‚æŠ¥æ–‡ï¼Œç„¶åå‘é€ç»™æœåŠ¡ç«¯ï¼›</li>
<li>2 æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åï¼ŒéªŒè¯è¯¥ç”¨æˆ·åå’Œå¯†ç ï¼Œå¦‚æœæ­£ç¡®ï¼Œåˆ™ä¸ºè¯¥ç”¨æˆ·åˆ›å»ºä¸€ä¸ªSessionå¯¹è±¡ï¼ŒSessionå¯¹è±¡ä¸­ä¿å­˜äº†ç”¨æˆ·çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶ç”ŸæˆSessionå¯¹è±¡çš„å”¯ä¸€IDï¼Œç§°ä¸ºSession IDï¼Œç„¶åæŠŠSessionå¯¹è±¡å­˜å‚¨åˆ°å†…å­˜æˆ–æ•°æ®åº“ä¸­ï¼Œæ ¹æ®Session IDæ ¹æ®ä»å†…å­˜æˆ–æ•°æ®åº“è·å–åˆ°Sessionå¯¹è±¡ï¼›</li>
<li>3 æ¥ç€æœåŠ¡ç«¯æŠŠSession IDçš„å€¼ä»¥name=valueçš„å½¢å¼æ”¾å…¥å“åº”æŠ¥æ–‡çš„Set-Cookieé¦–éƒ¨ä¸­ï¼Œå…¶ä¸­nameä¸ºSession IDçš„åå­—ï¼Œvalueå°±æ˜¯Session IDçš„å€¼ï¼Œname=valueå½¢å¼çš„Session IDå°±ç§°ä¸ºCookieï¼ŒSet-Cookieé¦–éƒ¨é™¤äº†Session IDä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–ä¿¡æ¯ï¼Œå¦‚Cookieçš„æœ‰æ•ˆæœŸã€Cookieçš„åŸŸåèŒƒå›´ç­‰ï¼Œç„¶åæŠŠè¿™ä¸ªå“åº”æŠ¥æ–‡å‘é€ç»™å®¢æˆ·ç«¯ï¼›</li>
<li>4 å®¢æˆ·ç«¯æ”¶åˆ°å“åº”æŠ¥æ–‡ä¹‹åä»Set-Cookieé¦–éƒ¨ä¸­å–å‡ºæ‰€æœ‰Cookieä¿¡æ¯ï¼Œç„¶åæŠŠå®ƒä¿å­˜åˆ°æœ¬åœ°ï¼Œå®¢æˆ·ç«¯æœ‰æ—¶å€™ä¼šæ”¶åˆ°ä¸æ­¢ä¸€ä¸ªSet-Cookieé¦–éƒ¨ï¼Œå¦‚æœæœ‰å¤šä¸ªï¼Œæ¯ä¸ªSet-Cookieé¦–éƒ¨ä¸­çš„Cookieä¿¡æ¯éƒ½è¦ä¿å­˜ï¼›</li>
<li>5 å®¢æˆ·ç«¯ä¹‹åå¯¹åŒä¸€ä¸ªæœåŠ¡ç«¯è¿›è¡Œè¯·æ±‚æ—¶éƒ½ä¼šä»æœ¬åœ°å–å‡ºCookieä¿¡æ¯ï¼Œè¿™æ—¶å¯ä»¥æ ¡éªŒCookieçš„æœ‰æ•ˆæœŸã€è·¯å¾„ã€åŸŸåç­‰ä¿¡æ¯ï¼Œç„¶åå–å‡ºå…¶ä¸­çš„Cookieå€¼æ”¾å…¥è¯·æ±‚æŠ¥æ–‡çš„Cookieé¦–éƒ¨å­—æ®µï¼Œå¦‚æœæœ‰å¤šä¸ªCookieå€¼ï¼ŒCookieé¦–éƒ¨ä¸­å°±ç”¨ ; åˆ†éš”ï¼Œç„¶åæŠŠè¿™ä¸ªè¯·æ±‚æŠ¥æ–‡å‘é€ç»™æœåŠ¡ç«¯ï¼›</li>
<li>6 æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œä»Cookieé¦–éƒ¨ä¸­å–å‡ºCookieï¼Œä»Cookieä¸­å–å‡ºSession IDï¼Œç„¶åç”¨Session IDä»å†…å­˜æˆ–æ•°æ®åº“å–å‡ºç”¨æˆ·ä¿¡æ¯ï¼Œæ¢å¤ç”¨æˆ·ä¹‹å‰çš„æ“ä½œçŠ¶æ€ã€‚</li>
</ul>
<p>å…³äºCookieä¸Sessionå»ºè®®ï¼š<a href="https://zhuanlan.zhihu.com/p/27669892" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/27669892</a><br>æˆ–è€…ã€Šå›¾è§£httpã€‹</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/24/TCP,UDPæ€»ç»“/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/24/TCP,UDPæ€»ç»“/" itemprop="url">TCP,UDPçŸ¥è¯†æ€»ç»“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-02-24T00:00:00+08:00">
                2020-02-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/24/TCP,UDPæ€»ç»“/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/02/24/TCP,UDPæ€»ç»“/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="TCP-UDPçš„å¯¹æ¯”"><a href="#TCP-UDPçš„å¯¹æ¯”" class="headerlink" title="TCP,UDPçš„å¯¹æ¯”"></a>TCP,UDPçš„å¯¹æ¯”</h2><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><h4 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h4><p>TCPï¼ˆTransmission Control Protocolï¼Œä¼ è¾“æ§åˆ¶åè®®ï¼‰ï¼Œæ˜¯ä¸€ç§é¢å‘è¿æ¥çš„ï¼ŒåŸºäºçª—å£æ»‘åŠ¨çš„å¯é ä¼ è¾“åè®®ï¼Œæä¾›å¯é ï¼ˆæ— å·®é”™ã€ä¸ä¸¢å¤±ã€ä¸é‡å¤ã€æŒ‰é¡ºåºï¼‰çš„å­—èŠ‚æµæ•°æ®ä¼ è¾“æœåŠ¡ã€‚åœ¨ä¼ è¾“æ•ˆç‡å’Œå¯é æ€§ä¹‹é—´é€‰æ‹©äº†åè€…ï¼Œæ‰€ä»¥æœ‰å¼€é”€å¤§ã€ä¼ è¾“é€Ÿåº¦æ…¢çš„ç¼ºç‚¹ã€‚</p>
<h4 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h4><p>UDPï¼ˆUser Datagram Protocolï¼Œç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼‰ï¼Œæ˜¯ä¸€ç§æ— è¿æ¥çš„éå¯é ä¼ è¾“å±‚åè®®ã€‚UDP ä¸æä¾›æ•°æ®åŒ…åˆ†ç»„ã€ç»„è£…ï¼Œä¸èƒ½å¯¹æ•°æ®æ®µè¿›è¡Œæ’åºï¼Œæ‰€ä»¥ UDP æ•°æ®æ®µçš„é¦–éƒ¨éå¸¸ç®€å•ã€‚æ¢å¥è¯è¯´ï¼Œå½“æ•°æ®æ®µå‘é€å‡ºå»ä¹‹åï¼Œå‘é€æ–¹æ˜¯æ— æ³•å¾—çŸ¥å…¶æ˜¯å¦å®Œæ•´ä¸”å®‰å…¨çš„åˆ°è¾¾äº†æ¥æ”¶æ–¹çš„ã€‚è¿™æ ·çš„ä¼ è¾“æœºåˆ¶å†³å®šäº†å®ƒçš„æœ€å¤§ä¼˜ç‚¹å°±æ˜¯å¿«ï¼ŒåŒæ—¶ä¹Ÿå†³å®šäº†å®ƒæœ€å¤§çš„ç¼ºç‚¹ä¸å¯é ã€ä¸ç¨³å®šã€‚</p>
<h3 id="ä¸¤è€…å¯¹æ¯”"><a href="#ä¸¤è€…å¯¹æ¯”" class="headerlink" title="ä¸¤è€…å¯¹æ¯”"></a>ä¸¤è€…å¯¹æ¯”</h3><h4 id="TCP-1"><a href="#TCP-1" class="headerlink" title="TCP:"></a>TCP:</h4><ul>
<li>1 é¢å‘è¿æ¥ï¼šéœ€è¦é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ã€‚</li>
<li>2 ç‚¹å¯¹ç‚¹ï¼šä¸€æ¡ TCP è¿æ¥åªèƒ½è¿æ¥ä¸¤ä¸ªç«¯ç‚¹ï¼Œä¸€å¯¹ä¸€é€šä¿¡ã€‚</li>
<li>3 å­—èŠ‚æµä¼ è¾“ï¼šTCP ä¼šå°†æ•°æ®å½“ä½œå­—èŠ‚æµè¿›è¡Œå¤„ç†ï¼Œä¸å°è¯•ç†è§£æ‰€ä¼ è¾“çš„æ•°æ®å«ä¹‰ï¼Œä»…æŠŠæ•°æ®çœ‹ä½œä¸€è¿ä¸²çš„å­—èŠ‚åºåˆ—ã€‚</li>
<li>4 å¯é ä¼ è¾“ï¼šä½¿ç”¨çª—å£æ»‘åŠ¨çš„æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶</li>
<li>5 é¦–éƒ¨å¼€é”€å¤§ï¼šæœ€å°‘20å­—èŠ‚ï¼Œæœ€å¤§60å­—èŠ‚</li>
</ul>
<h4 id="UDP-1"><a href="#UDP-1" class="headerlink" title="UDP:"></a>UDP:</h4><ul>
<li>1 æ— è¿æ¥</li>
<li>2 æ”¯æŒå•ä¼ ï¼Œå¤šä¼ ï¼Œå¹¿æ’­ï¼ˆä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šï¼Œå¤šå¯¹ä¸€ï¼Œå¤šå¯¹å¤šï¼‰</li>
<li>3 å¯¹åº”ç”¨å±‚äº¤ä»˜çš„æŠ¥æ–‡ç›´æ¥æ‰“åŒ…ï¼šä¸æä¾›æ•°æ®åŒ…åˆ†ç»„ã€ç»„è£…ï¼Œä¸èƒ½å¯¹æ•°æ®æ®µè¿›è¡Œæ’åº</li>
<li>4 ä¸å¯é ï¼šå°½æœ€å¤§åŠªåŠ›äº¤ä»˜ï¼Œä¸ä½¿ç”¨æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶</li>
<li>5 é¦–éƒ¨å¼€é”€å°ï¼šä»…8ä¸ªå­—èŠ‚</li>
</ul>
<h2 id="TCP-2"><a href="#TCP-2" class="headerlink" title="TCP"></a>TCP</h2><h3 id="ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸‰æ¬¡æ¡æ‰‹</h3><p>TCP æä¾›é¢å‘æœ‰è¿æ¥çš„é€šä¿¡ä¼ è¾“ã€‚é¢å‘æœ‰è¿æ¥æ˜¯æŒ‡åœ¨æ•°æ®é€šä¿¡å¼€å§‹ä¹‹å‰å…ˆåšå¥½ä¸¤ç«¯ä¹‹é—´çš„å‡†å¤‡å·¥ä½œã€‚æ‰€è°“ä¸‰æ¬¡æ¡æ‰‹æ˜¯æŒ‡å»ºç«‹ä¸€ä¸ª TCP è¿æ¥æ—¶éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ€»å…±å‘é€ä¸‰ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„å»ºç«‹ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æ‰§è¡Œconnectæ¥è§¦å‘ã€‚<br><img src="https://s2.ax1x.com/2020/02/23/31cCgP.jpg" alt="å›¾ç‰‡"></p>
<ul>
<li>1 ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å°†æ ‡å¿—ä½SYNç½®ä¸º1ï¼ˆSYNä¸º1æ—¶ä¸èƒ½æºå¸¦æ•°æ®ï¼‰ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=xï¼Œä½œä¸ºTCPå®¢æˆ·è¿›ç¨‹çš„åˆå§‹åºå·ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯è¿›å…¥SYN_SENTåŒæ­¥å·²å‘é€çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯ç¡®è®¤ã€‚</li>
<li>2 ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN=1çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨ç«¯å°†æ ‡å¿—ä½SYNå’ŒACKéƒ½ç½®ä¸º1ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªTCPç¡®è®¤è¯·æ±‚æŠ¥æ–‡ï¼Œack=x+1,è¡¨æ˜å¯¹å®¢æˆ·è¿›ç¨‹åˆå§‹åºå·çš„ç¡®è®¤ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=yä½œä¸ºæœåŠ¡å™¨è¿›ç¨‹çš„åˆå§‹åºå·ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™å®¢æˆ·ç«¯ä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯è¿›å…¥SYN_RCVDåŒæ­¥å·²æ¥æ”¶çŠ¶æ€ã€‚</li>
<li>3 ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°ç¡®è®¤åï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºx+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKç½®ä¸º1ï¼Œack=y+1ï¼Œseq=x+1å¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯æ£€æŸ¥ackæ˜¯å¦ä¸ºy+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è¿›å…¥ESTABLISHEDè¿æ¥å·²å»ºç«‹çŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œéšåå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†ã€‚</li>
</ul>
<h3 id="å››æ¬¡æŒ¥æ‰‹"><a href="#å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="å››æ¬¡æŒ¥æ‰‹"></a>å››æ¬¡æŒ¥æ‰‹</h3><p>å››æ¬¡æŒ¥æ‰‹å³ç»ˆæ­¢TCPè¿æ¥ï¼Œå°±æ˜¯æŒ‡æ–­å¼€ä¸€ä¸ªTCPè¿æ¥æ—¶ï¼Œéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ€»å…±å‘é€4ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„æ–­å¼€ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ä»»ä¸€æ–¹æ‰§è¡Œcloseæ¥è§¦å‘ã€‚<br>ç”±äºTCPè¿æ¥æ˜¯å…¨åŒå·¥çš„ï¼Œå› æ­¤ï¼Œæ¯ä¸ªæ–¹å‘éƒ½å¿…é¡»è¦å•ç‹¬è¿›è¡Œå…³é—­ï¼Œè¿™ä¸€åŸåˆ™æ˜¯å½“ä¸€æ–¹å®Œæˆæ•°æ®å‘é€ä»»åŠ¡åï¼Œå‘é€ä¸€ä¸ªFINæ¥ç»ˆæ­¢è¿™ä¸€æ–¹å‘çš„è¿æ¥ï¼Œæ”¶åˆ°ä¸€ä¸ªFINåªæ˜¯æ„å‘³ç€è¿™ä¸€æ–¹å‘ä¸Šæ²¡æœ‰æ•°æ®æµåŠ¨äº†ï¼Œå³ä¸ä¼šå†æ”¶åˆ°æ•°æ®äº†ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªTCPè¿æ¥ä¸Šä»ç„¶èƒ½å¤Ÿå‘é€æ•°æ®ï¼Œç›´åˆ°è¿™ä¸€æ–¹å‘ä¹Ÿå‘é€äº†FINã€‚é¦–å…ˆè¿›è¡Œå…³é—­çš„ä¸€æ–¹å°†æ‰§è¡Œä¸»åŠ¨å…³é—­ï¼Œè€Œå¦ä¸€æ–¹åˆ™æ‰§è¡Œè¢«åŠ¨å…³é—­ã€‚<br><img src="https://s2.ax1x.com/2020/02/23/33uXLD.png" alt="å›¾ç‰‡"></p>
<ul>
<li>1 ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªFIN=1ï¼ŒACK=1ï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ç«¯çš„æ•°æ®ä¼ é€,seq=uï¼Œuä¸ºä¹‹å‰å®¢æˆ·ç«¯ä¼ é€çš„æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚åºå·åŠ 1ï¼Œack=v,vä¸ºä¹‹å‰å®¢æˆ·ç«¯æ”¶åˆ°çš„æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚åºå·åŠ 1ï¼Œå®¢æˆ·ç«¯è¿›å…¥FIN_WAIT_1ç»ˆæ­¢ç­‰å¾…1çŠ¶æ€ã€‚æ„æ€æ˜¯è¯´â€æˆ‘å®¢æˆ·ç«¯æ²¡æœ‰æ•°æ®è¦å‘ç»™ä½ äº†â€ï¼Œä½†æ˜¯å¦‚æœä½ æœåŠ¡å™¨ç«¯è¿˜æœ‰æ•°æ®æ²¡æœ‰å‘é€å®Œæˆï¼Œåˆ™ä¸å¿…æ€¥ç€å…³é—­è¿æ¥ï¼Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®ã€‚</li>
<li>2 ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°FINåè¿›å…¥CLOSE-WAITå…³é—­ç­‰å¾…çŠ¶æ€ï¼ŒACK=1,seq=v,vè¡¨æ˜ä¹‹å‰æœåŠ¡å™¨ä¼ é€çš„æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚åºå·åŠ 1ï¼Œack=u+1(å¯¹æ”¶åˆ°å®¢æˆ·ç«¯æŠ¥æ–‡çš„ç¡®è®¤)ï¼Œå¯¹å®¢æˆ·ç«¯ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œä½ çš„è¯·æ±‚æˆ‘æ”¶åˆ°äº†ï¼Œä½†æ˜¯æˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¯·ç»§ç»­ä½ ç­‰æˆ‘çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±è¿›å…¥FIN_WAIT_2 ç»ˆæ­¢ç­‰å¾…2çŠ¶æ€ï¼Œç»§ç»­ç­‰å¾…æœåŠ¡å™¨ç«¯çš„FINæŠ¥æ–‡ã€‚</li>
<li>3 ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šå½“æœåŠ¡å™¨ç«¯ç¡®å®šæ•°æ®å·²å‘é€å®Œæˆï¼Œåˆ™å‘å®¢æˆ·ç«¯å‘é€FIN=1ï¼ŒACK=1,seq=w(åŠå…³é—­çŠ¶æ€ä¸‹å¯èƒ½åˆå‘é€äº†æ•°æ®),ack=u+1ï¼ˆå¯¹æ”¶åˆ°å®¢æˆ·ç«¯æŠ¥æ–‡çš„é‡å¤ç¡®è®¤ï¼‰æŠ¥æ–‡ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå¥½äº†ï¼Œæˆ‘è¿™è¾¹æ•°æ®å‘å®Œäº†ï¼Œå‡†å¤‡å¥½å…³é—­è¿æ¥äº†ã€‚æœåŠ¡å™¨ç«¯è¿›å…¥LAST_ACKæœ€åç¡®è®¤çŠ¶æ€ã€‚</li>
<li>4 ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æŠ¥æ–‡åï¼Œå°±çŸ¥é“å¯ä»¥å…³é—­è¿æ¥äº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯ä¸ç›¸ä¿¡ç½‘ç»œï¼Œæ€•æœåŠ¡å™¨ç«¯ä¸çŸ¥é“è¦å…³é—­ï¼Œæ‰€ä»¥å‘é€ACK=1,seq=u+1,ack=w+1åè¿›å…¥TIME_WAITæ—¶é—´ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœæœåŠ¡ç«¯æ²¡æœ‰æ”¶åˆ°ACKåˆ™å¯ä»¥é‡ä¼ ã€‚æœåŠ¡å™¨ç«¯æ”¶åˆ°ACKåï¼Œå°±çŸ¥é“å¯ä»¥æ–­å¼€è¿æ¥äº†ã€‚å®¢æˆ·ç«¯ç­‰å¾…äº†2MSLåä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œåˆ™è¯æ˜æœåŠ¡å™¨ç«¯å·²æ­£å¸¸å…³é—­ï¼Œé‚£å¥½ï¼Œæˆ‘å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚æœ€ç»ˆå®Œæˆäº†å››æ¬¡æ¡æ‰‹ã€‚</li>
</ul>
<p>æœ¬æ–‡å‚è€ƒï¼š<a href="https://www.youtube.com/watch?v=p799RP-YFY8" target="_blank" rel="noopener">https://www.youtube.com/watch?v=p799RP-YFY8</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/22/ç½‘ç»œæ¨¡å‹çŸ¥å¤šå°‘/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/22/ç½‘ç»œæ¨¡å‹çŸ¥å¤šå°‘/" itemprop="url">ç½‘ç»œæ¨¡å‹çŸ¥è¯†æ€»ç»“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-02-22T00:00:00+08:00">
                2020-02-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/22/ç½‘ç»œæ¨¡å‹çŸ¥å¤šå°‘/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/02/22/ç½‘ç»œæ¨¡å‹çŸ¥å¤šå°‘/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="èƒŒæ™¯ä»¥åŠå¤™æ„¿"><a href="#èƒŒæ™¯ä»¥åŠå¤™æ„¿" class="headerlink" title="èƒŒæ™¯ä»¥åŠå¤™æ„¿"></a>èƒŒæ™¯ä»¥åŠå¤™æ„¿</h2><p>éƒ½å¿«è¿˜ç»™è€å¸ˆäº†ï¼Œå¾€å›æ¡ä¸€æ¡</p>
<h2 id="osiç½‘ç»œæ¨¡å‹"><a href="#osiç½‘ç»œæ¨¡å‹" class="headerlink" title="osiç½‘ç»œæ¨¡å‹"></a>osiç½‘ç»œæ¨¡å‹</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>å³å¼€æ”¾å¼ç³»ç»Ÿäº’è”ã€‚ ä¸€èˆ¬éƒ½å«OSIå‚è€ƒæ¨¡å‹ï¼Œæ˜¯å›½é™…æ ‡å‡†åŒ–ç»„ç»‡ä¸ºäº†æ™®åŠç½‘ç»œåº”ç”¨è€Œæ¨å‡ºçš„ï¼Œå«ä¹‰å°±æ˜¯æ¨èæ‰€æœ‰å…¬å¸ä½¿ç”¨è¿™ä¸ªè§„èŒƒæ¥æ§åˆ¶ç½‘ç»œã€‚è¿™æ ·æ‰€æœ‰å…¬å¸éƒ½æœ‰ç›¸åŒçš„è§„èŒƒï¼Œå°±èƒ½äº’è”äº†</p>
<h3 id="OSIä¸ƒå±‚æ¨¡å‹"><a href="#OSIä¸ƒå±‚æ¨¡å‹" class="headerlink" title="OSIä¸ƒå±‚æ¨¡å‹"></a>OSIä¸ƒå±‚æ¨¡å‹</h3><p>ç”±ä¸‹åˆ°ä¸Šåˆ†ä¸ºç‰©ç†å±‚ï¼Œæ•°æ®é“¾è·¯å±‚ï¼Œç½‘ç»œå±‚ï¼Œä¼ è¾“å±‚ï¼Œä¼šè¯å±‚ï¼Œè¡¨ç¤ºå±‚ï¼Œåº”ç”¨å±‚ã€‚</p>
<p><img src="https://s2.ax1x.com/2020/02/22/3MOsot.md.jpg" alt="å›¾ç‰‡"></p>
<h4 id="å„å±‚åŠŸèƒ½å®šä¹‰æ¦‚è¿°"><a href="#å„å±‚åŠŸèƒ½å®šä¹‰æ¦‚è¿°" class="headerlink" title="å„å±‚åŠŸèƒ½å®šä¹‰æ¦‚è¿°"></a>å„å±‚åŠŸèƒ½å®šä¹‰æ¦‚è¿°</h4><h5 id="åº”ç”¨å±‚"><a href="#åº”ç”¨å±‚" class="headerlink" title="åº”ç”¨å±‚"></a>åº”ç”¨å±‚</h5><p>OSIå‚è€ƒæ¨¡å‹ä¸­æœ€é è¿‘ç”¨æˆ·çš„ä¸€å±‚ï¼Œæ˜¯ä¸ºè®¡ç®—æœºç”¨æˆ·æä¾›åº”ç”¨æ¥å£ï¼Œä¹Ÿä¸ºç”¨æˆ·ç›´æ¥æä¾›å„ç§ç½‘ç»œæœåŠ¡ã€‚æˆ‘ä»¬å¸¸è§åº”ç”¨å±‚çš„ç½‘ç»œæœåŠ¡åè®®æœ‰ï¼šHTTPï¼ŒHTTPSï¼ŒFTPï¼ŒPOP3ã€SMTPç­‰ã€‚</p>
<p>ä¸¾ä¾‹ï¼šæŸä¸œä¸Šï¼Œå–å®¶å’Œä¹°å®¶éƒ½æ˜¯æˆ‘ä»¬æ‰€è¿°çš„ç”¨æˆ·ï¼Œä»–ä»¬çš„çº¿ä¸Šä¹°å–è¡Œä¸ºï¼Œé€€è´§é€€æ¬¾ç­‰éƒ½æ˜¯åº”ç”¨å±‚æä¾›çš„ç½‘ç»œæœåŠ¡</p>
<h5 id="è¡¨ç¤ºå±‚"><a href="#è¡¨ç¤ºå±‚" class="headerlink" title="è¡¨ç¤ºå±‚"></a>è¡¨ç¤ºå±‚</h5><p>è¡¨ç¤ºå±‚æä¾›å„ç§ç”¨äºåº”ç”¨å±‚æ•°æ®çš„ç¼–ç å’Œè½¬æ¢åŠŸèƒ½,ç¡®ä¿ä¸€ä¸ªç³»ç»Ÿçš„åº”ç”¨å±‚å‘é€çš„æ•°æ®èƒ½è¢«å¦ä¸€ä¸ªç³»ç»Ÿçš„åº”ç”¨å±‚è¯†åˆ«ã€‚å¦‚æœå¿…è¦ï¼Œè¯¥å±‚å¯æä¾›ä¸€ç§æ ‡å‡†è¡¨ç¤ºå½¢å¼ï¼Œç”¨äºå°†è®¡ç®—æœºå†…éƒ¨çš„å¤šç§æ•°æ®æ ¼å¼è½¬æ¢æˆé€šä¿¡ä¸­é‡‡ç”¨çš„æ ‡å‡†è¡¨ç¤ºå½¢å¼ã€‚æ•°æ®å‹ç¼©å’ŒåŠ å¯†ä¹Ÿæ˜¯è¡¨ç¤ºå±‚å¯æä¾›çš„è½¬æ¢åŠŸèƒ½ä¹‹ä¸€ã€‚</p>
<p>ä¸¾ä¾‹ï¼šç”±äºå–å®¶Aå’Œä¹°å®¶Bæ˜¯ä¸åŒå›½å®¶çš„ï¼Œä»–ä»¬ä¹‹é—´çš„å•†å®šç»Ÿä¸€ç”¨è‹±è¯­ä½œä¸ºäº¤æµçš„è¯­è¨€ï¼Œæ‰€ä»¥æ­¤æ—¶è¡¨ç¤ºå±‚ï¼Œå°±æ˜¯å°†åº”ç”¨å±‚çš„ä¼ é€’ä¿¡æ¯è½¬ç¿»è¯‘æˆè‹±è¯­ã€‚åŒæ—¶ä¸ºäº†é˜²æ­¢ä¿¡æ¯è¢«äººæˆªè·ï¼ŒAçš„äººä¹Ÿä¼šå¯¹è¿™ä»½ä¿¡æ¯å•åšä¸€äº›åŠ å¯†çš„å¤„ç†ã€‚è¿™å°±æ˜¯è¡¨ç¤ºçš„ä½œç”¨ï¼Œå°†åº”ç”¨å±‚çš„æ•°æ®è½¬æ¢ç¿»è¯‘ç­‰ã€‚</p>
<h5 id="ä¼šè¯å±‚"><a href="#ä¼šè¯å±‚" class="headerlink" title="ä¼šè¯å±‚"></a>ä¼šè¯å±‚</h5><p>ä¼šè¯å±‚å°±æ˜¯è´Ÿè´£å»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢è¡¨ç¤ºå±‚å®ä½“ä¹‹é—´çš„é€šä¿¡ä¼šè¯ã€‚è¯¥å±‚çš„é€šä¿¡ç”±ä¸åŒè®¾å¤‡ä¸­çš„åº”ç”¨ç¨‹åºä¹‹é—´çš„æœåŠ¡è¯·æ±‚å’Œå“åº”ç»„æˆï¼Œã€‚      </p>
<p>ä¸¾ä¾‹ï¼šBè·ŸAèŠå®Œï¼Œè¿˜æƒ³è´§æ¯”ä¸‰å®¶ï¼Œå°±å»æ‰¾å…¶ä»–å–å®¶èŠï¼Œä¼šè¯å±‚æŒæ¡ç€å…¶ä»–å–å®¶çš„ä¿¡æ¯ï¼Œè´Ÿè´£å»ºç«‹é€šè¯å¹¶è®°å½•é€šè¯ï¼Œé¦–å…ˆè¦æ‰¾åˆ°å…¶ä»–å–å®¶çš„åœ°å€ä¿¡æ¯ï¼Œç„¶åå°†æ•´ä»½èµ„æ–™æ”¾è¿›ä¿¡å°ï¼Œå¹¶å†™ä¸Šåœ°å€å’Œè”ç³»æ–¹å¼ã€‚å‡†å¤‡å°†èµ„æ–™å¯„å‡ºã€‚ç­‰åˆ°ç¡®å®šå…¬å¸Bæ¥æ”¶åˆ°æ­¤ä»½æŠ¥ä»·å•åï¼Œæ­¤æ¬¡ä¼šè¯å°±ç®—ç»“æŸäº†ï¼Œéšåç»ˆæ­¢é€šè¯ã€‚</p>
<h5 id="ä¼ è¾“å±‚"><a href="#ä¼ è¾“å±‚" class="headerlink" title="ä¼ è¾“å±‚"></a>ä¼ è¾“å±‚</h5><p>ä¼ è¾“å±‚å»ºç«‹äº†ä¸»æœºç«¯åˆ°ç«¯çš„é“¾æ¥ï¼Œä¼ è¾“å±‚çš„ä½œç”¨æ˜¯ä¸ºä¸Šå±‚åè®®æä¾›ç«¯åˆ°ç«¯çš„å¯é å’Œé€æ˜çš„æ•°æ®ä¼ è¾“æœåŠ¡ï¼ŒåŒ…æ‹¬å¤„ç†å·®é”™æ§åˆ¶å’Œæµé‡æ§åˆ¶ç­‰é—®é¢˜ã€‚è¯¥å±‚å‘é«˜å±‚å±è”½äº†ä¸‹å±‚æ•°æ®é€šä¿¡çš„ç»†èŠ‚ï¼Œä½¿é«˜å±‚ç”¨æˆ·çœ‹åˆ°çš„åªæ˜¯åœ¨ä¸¤ä¸ªä¼ è¾“å®ä½“é—´çš„ä¸€æ¡ä¸»æœºåˆ°ä¸»æœºçš„ã€å¯ç”±ç”¨æˆ·æ§åˆ¶å’Œè®¾å®šçš„ã€å¯é çš„æ•°æ®é€šè·¯ã€‚æˆ‘ä»¬é€šå¸¸è¯´çš„ï¼ŒTCP UDPå°±æ˜¯åœ¨è¿™ä¸€å±‚ã€‚ç«¯å£å·æ—¢æ˜¯è¿™é‡Œçš„â€œç«¯â€ã€‚</p>
<p>ä¸¾ä¾‹ï¼šä¼ è¾“å±‚å°±ç›¸å½“äºè´Ÿè´£å¿«é€’é‚®ä»¶æ”¶å‘çš„äººï¼Œä»–ä»¬è´Ÿè´£å°†ä¸Šä¸€å±‚çš„è¦å¯„å‡ºçš„èµ„æ–™æŠ•é€’åˆ°å¿«é€’å…¬å¸æˆ–é‚®å±€ã€‚</p>
<h5 id="ç½‘ç»œå±‚"><a href="#ç½‘ç»œå±‚" class="headerlink" title="ç½‘ç»œå±‚"></a>ç½‘ç»œå±‚</h5><p>æœ¬å±‚é€šè¿‡IPå¯»å€æ¥å»ºç«‹ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥ï¼Œä¸ºæºç«¯çš„è¿è¾“å±‚é€æ¥çš„åˆ†ç»„ï¼Œé€‰æ‹©åˆé€‚çš„è·¯ç”±å’Œäº¤æ¢èŠ‚ç‚¹ï¼Œæ­£ç¡®æ— è¯¯åœ°æŒ‰ç…§åœ°å€ä¼ é€ç»™ç›®çš„ç«¯çš„è¿è¾“å±‚ã€‚å°±æ˜¯é€šå¸¸è¯´çš„IPå±‚ã€‚è¿™ä¸€å±‚å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„IPåè®®å±‚ã€‚IPåè®®æ˜¯Internetçš„åŸºç¡€ã€‚</p>
<p>ä¸¾ä¾‹ï¼šç½‘ç»œå±‚å°±ç›¸å½“äºå¿«é€’å…¬å¸åºå¤§çš„å¿«é€’ç½‘ç»œï¼Œå…¨å›½ä¸åŒçš„é›†æ•£ä¸­å¿ƒï¼Œæ¯”å¦‚è¯´ï¼Œä»æ·±åœ³å‘å¾€åŒ—äº¬çš„é¡ºä¸°å¿«é€’ï¼ˆé™†è¿ä¸ºä¾‹å•Šï¼Œç©ºè¿å¥½åƒç›´æ¥å°±é£åˆ°åŒ—äº¬äº†ï¼‰ï¼Œé¦–å…ˆè¦åˆ°é¡ºä¸°çš„æ·±åœ³é›†æ•£ä¸­å¿ƒï¼Œä»æ·±åœ³é›†æ•£ä¸­å¿ƒå†é€åˆ°æ­¦æ±‰é›†æ•£ä¸­å¿ƒï¼Œä»æ­¦æ±‰é›†æ•£ä¸­å¿ƒå†å¯„åˆ°åŒ—äº¬é¡ºä¹‰é›†æ•£ä¸­å¿ƒã€‚è¿™ä¸ªæ¯ä¸ªé›†æ•£ä¸­å¿ƒï¼Œå°±ç›¸å½“äºç½‘ç»œä¸­çš„ä¸€ä¸ªIPèŠ‚ç‚¹ã€‚</p>
<h5 id="æ•°æ®é“¾è·¯å±‚"><a href="#æ•°æ®é“¾è·¯å±‚" class="headerlink" title="æ•°æ®é“¾è·¯å±‚"></a>æ•°æ®é“¾è·¯å±‚</h5><p>å°†æ¯”ç‰¹ç»„åˆæˆå­—èŠ‚,å†å°†å­—èŠ‚ç»„åˆæˆå¸§,ä½¿ç”¨é“¾è·¯å±‚åœ°å€ (ä»¥å¤ªç½‘ä½¿ç”¨MACåœ°å€)æ¥è®¿é—®ä»‹è´¨,å¹¶è¿›è¡Œå·®é”™æ£€æµ‹ã€‚<br>æ•°æ®é“¾è·¯å±‚åˆåˆ†ä¸º2ä¸ªå­å±‚ï¼šé€»è¾‘é“¾è·¯æ§åˆ¶å­å±‚ï¼ˆLLCï¼‰å’Œåª’ä½“è®¿é—®æ§åˆ¶å­å±‚ï¼ˆMACï¼‰ã€‚<br>MACå­å±‚å¤„ç†CSMA/CDç®—æ³•ã€æ•°æ®å‡ºé”™æ ¡éªŒã€æˆå¸§ç­‰ï¼›LLCå­å±‚å®šä¹‰äº†ä¸€äº›å­—æ®µä½¿ä¸Šæ¬¡åè®®èƒ½å…±äº«æ•°æ®é“¾è·¯å±‚ã€‚ åœ¨å®é™…ä½¿ç”¨ä¸­ï¼ŒLLCå­å±‚å¹¶éå¿…éœ€çš„ã€‚</p>
<h5 id="ç‰©ç†å±‚"><a href="#ç‰©ç†å±‚" class="headerlink" title="ç‰©ç†å±‚"></a>ç‰©ç†å±‚</h5><p>å®é™…æœ€ç»ˆä¿¡å·çš„ä¼ è¾“æ˜¯é€šè¿‡ç‰©ç†å±‚å®ç°çš„ã€‚é€šè¿‡ç‰©ç†ä»‹è´¨ä¼ è¾“æ¯”ç‰¹æµã€‚è§„å®šäº†ç”µå¹³ã€é€Ÿåº¦å’Œç”µç¼†é’ˆè„šã€‚å¸¸ç”¨è®¾å¤‡æœ‰ï¼ˆå„ç§ç‰©ç†è®¾å¤‡ï¼‰é›†çº¿å™¨ã€ä¸­ç»§å™¨ã€è°ƒåˆ¶è§£è°ƒå™¨ã€ç½‘çº¿ã€åŒç»çº¿ã€åŒè½´ç”µç¼†ã€‚è¿™äº›éƒ½æ˜¯ç‰©ç†å±‚çš„ä¼ è¾“ä»‹è´¨ã€‚</p>
<h2 id="TCP-IPç½‘ç»œæ¨¡å‹"><a href="#TCP-IPç½‘ç»œæ¨¡å‹" class="headerlink" title="TCP/IPç½‘ç»œæ¨¡å‹"></a>TCP/IPç½‘ç»œæ¨¡å‹</h2><h3 id="æ¦‚è¿°-1"><a href="#æ¦‚è¿°-1" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>å¦‚æœè¯´OSIç½‘ç»œæ¨¡å‹æ˜¯ä¸€ç§ç†æƒ³åŒ–çš„æ ‡å‡†ï¼Œé‚£ä¹ˆTCP/IPå°±æ˜¯ä¸€ç§æˆåŠŸçš„å…·ä½“å®ç°ï¼Œå®ƒçš„åˆ†å±‚ï¼šç‰©ç†å±‚ï¼Œæ•°æ®é“¾è·¯å±‚ï¼Œç½‘ç»œå±‚ï¼Œä¼ è¾“å±‚ï¼Œåº”ç”¨å±‚<br>ä¸OSIå¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š<br><img src="https://s2.ax1x.com/2020/02/22/3Q28kd.md.jpg" alt="å›¾ç‰‡"></p>
<h3 id="æ•°æ®å¤„ç†æµç¨‹"><a href="#æ•°æ®å¤„ç†æµç¨‹" class="headerlink" title="æ•°æ®å¤„ç†æµç¨‹"></a>æ•°æ®å¤„ç†æµç¨‹</h3><p>ä¸‹å›¾ä»¥ç”¨æˆ· a å‘ç”¨æˆ· b å‘é€é‚®ä»¶ä¸ºä¾‹å­ï¼š<br><img src="https://s2.ax1x.com/2020/02/23/31mTbj.png" alt="å›¾ç‰‡"></p>
<ul>
<li>1 â‘  åº”ç”¨ç¨‹åºå¤„ç†<br>é¦–å…ˆåº”ç”¨ç¨‹åºä¼šè¿›è¡Œç¼–ç å¤„ç†ï¼Œè¿™äº›ç¼–ç ç›¸å½“äº OSI çš„è¡¨ç¤ºå±‚åŠŸèƒ½ï¼›<br>ç¼–ç è½¬åŒ–åï¼Œé‚®ä»¶ä¸ä¸€å®šé©¬ä¸Šè¢«å‘é€å‡ºå»ï¼Œè¿™ç§ä½•æ—¶å»ºç«‹é€šä¿¡è¿æ¥ä½•æ—¶å‘é€æ•°æ®çš„ç®¡ç†åŠŸèƒ½ï¼Œç›¸å½“äº OSI çš„ä¼šè¯å±‚åŠŸèƒ½ã€‚</li>
<li>2 â‘¡ TCP æ¨¡å—çš„å¤„ç†<br>TCP æ ¹æ®åº”ç”¨çš„æŒ‡ç¤ºï¼Œè´Ÿè´£å»ºç«‹è¿æ¥ã€å‘é€æ•°æ®ä»¥åŠæ–­å¼€è¿æ¥ã€‚TCP æä¾›å°†åº”ç”¨å±‚å‘æ¥çš„æ•°æ®é¡ºåˆ©å‘é€è‡³å¯¹ç«¯çš„å¯é ä¼ è¾“ã€‚ä¸ºäº†å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œéœ€è¦åœ¨åº”ç”¨å±‚æ•°æ®çš„å‰ç«¯é™„åŠ ä¸€ä¸ª TCP é¦–éƒ¨ã€‚</li>
<li>3 â‘¢ IP æ¨¡å—çš„å¤„ç†<br>IP å°† TCP ä¼ è¿‡æ¥çš„ TCP é¦–éƒ¨å’Œ TCP æ•°æ®åˆèµ·æ¥å½“åšè‡ªå·±çš„æ•°æ®ï¼Œå¹¶åœ¨ TCP é¦–éƒ¨çš„å‰ç«¯åŠ ä¸Šè‡ªå·±çš„ IP é¦–éƒ¨ã€‚IP åŒ…ç”Ÿæˆåï¼Œå‚è€ƒè·¯ç”±æ§åˆ¶è¡¨å†³å®šæ¥å—æ­¤ IP åŒ…çš„è·¯ç”±æˆ–ä¸»æœºã€‚</li>
<li>4 â‘£ ç½‘ç»œæ¥å£ï¼ˆä»¥å¤ªç½‘é©±åŠ¨ï¼‰çš„å¤„ç†<br>ä» IP ä¼ è¿‡æ¥çš„ IP åŒ…å¯¹äºä»¥å¤ªç½‘æ¥è¯´å°±æ˜¯æ•°æ®ã€‚ç»™è¿™äº›æ•°æ®é™„åŠ ä¸Šä»¥å¤ªç½‘é¦–éƒ¨å¹¶è¿›è¡Œå‘é€å¤„ç†ï¼Œç”Ÿæˆçš„ä»¥å¤ªç½‘æ•°æ®åŒ…å°†é€šè¿‡ç‰©ç†å±‚ä¼ è¾“ç»™æ¥æ”¶ç«¯ã€‚</li>
<li>5 â‘¤ ç½‘ç»œæ¥å£ï¼ˆä»¥å¤ªç½‘é©±åŠ¨ï¼‰çš„å¤„ç†ä¸»æœºæ”¶åˆ°ä»¥å¤ªç½‘åŒ…åï¼Œé¦–å…ˆä»ä»¥å¤ªç½‘åŒ…é¦–éƒ¨æ‰¾åˆ° MAC åœ°å€åˆ¤æ–­æ˜¯å¦ä¸ºå‘é€ç»™è‡ªå·±çš„åŒ…ï¼Œè‹¥ä¸æ˜¯åˆ™ä¸¢å¼ƒæ•°æ®ã€‚å¦‚æœæ˜¯å‘é€ç»™è‡ªå·±çš„åŒ…ï¼Œåˆ™ä»ä»¥å¤ªç½‘åŒ…é¦–éƒ¨ä¸­çš„ç±»å‹ç¡®å®šæ•°æ®ç±»å‹ï¼Œå†ä¼ ç»™ç›¸åº”çš„æ¨¡å—ï¼Œå¦‚ IPã€ARP ç­‰ã€‚è¿™é‡Œçš„ä¾‹å­åˆ™æ˜¯ IP ã€‚</li>
<li>6 â‘¥ IP æ¨¡å—çš„å¤„ç†IP æ¨¡å—æ¥æ”¶åˆ° æ•°æ®åä¹Ÿåšç±»ä¼¼çš„å¤„ç†ã€‚ä»åŒ…é¦–éƒ¨ä¸­åˆ¤æ–­æ­¤ IP åœ°å€æ˜¯å¦ä¸è‡ªå·±çš„ IP åœ°å€åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™æ ¹æ®é¦–éƒ¨çš„åè®®ç±»å‹å°†æ•°æ®å‘é€ç»™å¯¹åº”çš„æ¨¡å—ï¼Œå¦‚ TCPã€UDPã€‚è¿™é‡Œçš„ä¾‹å­åˆ™æ˜¯ TCPã€‚å¦å¤–å—ï¼Œå¯¹äºæœ‰è·¯ç”±å™¨çš„æƒ…å†µï¼Œæ¥æ”¶ç«¯åœ°å€å¾€å¾€ä¸æ˜¯è‡ªå·±çš„åœ°å€ï¼Œæ­¤æ—¶ï¼Œéœ€è¦å€ŸåŠ©è·¯ç”±æ§åˆ¶è¡¨ï¼Œåœ¨è°ƒæŸ¥åº”è¯¥é€å¾€çš„ä¸»æœºæˆ–è·¯ç”±å™¨ä¹‹åå†è¿›è¡Œè½¬å‘æ•°æ®ã€‚</li>
<li>7 â‘¦ TCP æ¨¡å—çš„å¤„ç†<br>åœ¨ TCP æ¨¡å—ä¸­ï¼Œé¦–å…ˆä¼šè®¡ç®—ä¸€ä¸‹æ ¡éªŒå’Œï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦è¢«ç ´åã€‚ç„¶åæ£€æŸ¥æ˜¯å¦åœ¨æŒ‰ç…§åºå·æ¥æ”¶æ•°æ®ã€‚æœ€åæ£€æŸ¥ç«¯å£å·ï¼Œç¡®å®šå…·ä½“çš„åº”ç”¨ç¨‹åºã€‚æ•°æ®è¢«å®Œæ•´åœ°æ¥æ”¶ä»¥åï¼Œä¼šä¼ ç»™ç”±ç«¯å£å·è¯†åˆ«çš„åº”ç”¨ç¨‹åºã€‚</li>
<li>8 â‘§ åº”ç”¨ç¨‹åºçš„å¤„ç†<br>æ¥æ”¶ç«¯åº”ç”¨ç¨‹åºä¼šç›´æ¥æ¥æ”¶å‘é€ç«¯å‘é€çš„æ•°æ®ã€‚é€šè¿‡è§£ææ•°æ®ï¼Œå±•ç¤ºç›¸åº”çš„å†…å®¹ã€‚</li>
</ul>
<p>æ³¨ï¼šå¸¸å¸¸è¯´çš„tcp,udpå°±æ˜¯ä¼ è¾“å±‚çš„åè®®ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/30/é›¶é›¶æ•£æ•£/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/30/é›¶é›¶æ•£æ•£/" itemprop="url">é›¶é›¶æ•£æ•£</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-12-30T00:00:00+08:00">
                2019-12-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/30/é›¶é›¶æ•£æ•£/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/12/30/é›¶é›¶æ•£æ•£/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="LeakCanaryæ˜¯å¦‚ä½•æ£€æµ‹åˆ°å†…å­˜æ³„æ¼çš„ï¼Ÿ"><a href="#LeakCanaryæ˜¯å¦‚ä½•æ£€æµ‹åˆ°å†…å­˜æ³„æ¼çš„ï¼Ÿ" class="headerlink" title="LeakCanaryæ˜¯å¦‚ä½•æ£€æµ‹åˆ°å†…å­˜æ³„æ¼çš„ï¼Ÿ"></a>LeakCanaryæ˜¯å¦‚ä½•æ£€æµ‹åˆ°å†…å­˜æ³„æ¼çš„ï¼Ÿ</h2><p>LeakCanayçš„å…¥å£æ˜¯åœ¨applicationçš„onCreate()æ–¹æ³•ä¸­å£°æ˜çš„ï¼Œå…¶å®ç”¨çš„å°±æ˜¯Applicationçš„ActivityLifecycleCallbackså›è°ƒæ¥å£ç›‘å¬æ‰€æœ‰activityçš„onDestory()çš„ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•è¿›è¡ŒRefWatcher.watchå¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œç›‘æ§ã€‚å…·ä½“æ˜¯è¿™æ ·åšçš„ï¼ŒæŠŠactivityå¯¹è±¡å°è£…æˆå¸¦keyå€¼å’Œå¸¦å¼•ç”¨é˜Ÿåˆ—(ReferenceQueue)çš„KeyedWeakReferenceå¯¹è±¡ï¼Œç„¶åGCçœ‹å¼±å¼•ç”¨å¯¹è±¡æœ‰æ²¡æœ‰å›æ”¶ï¼Œæ²¡æœ‰å›æ”¶çš„è¯å°±æ€€ç–‘æ˜¯æ³„æ¼äº†ï¼Œéœ€è¦äºŒæ¬¡ç¡®è®¤ã€‚ç„¶åç”ŸæˆHPROFæ–‡ä»¶ï¼Œåˆ†æè¿™ä¸ªå¿«ç…§æ–‡ä»¶æœ‰æ²¡æœ‰å­˜åœ¨å¸¦è¿™ä¸ªkeyå€¼çš„æ³„æ¼å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆæ²¡æœ‰æ³„æ¼ï¼Œå¦åˆ™æ‰¾å‡ºæœ€çŸ­è·¯å¾„ï¼Œæ‰“å°ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªæ³„æ¼å¯¹è±¡äº†ã€‚</p>
<h2 id="å¦‚ä½•åˆ¤æ–­appåœ¨å‰å°è¿˜æ˜¯åå°"><a href="#å¦‚ä½•åˆ¤æ–­appåœ¨å‰å°è¿˜æ˜¯åå°" class="headerlink" title="å¦‚ä½•åˆ¤æ–­appåœ¨å‰å°è¿˜æ˜¯åå°?"></a>å¦‚ä½•åˆ¤æ–­appåœ¨å‰å°è¿˜æ˜¯åå°?</h2><p>Applicationç±»é‡Œæœ‰ActivityLifecycleCallbackså›è°ƒæ¥å£,å¯ä»¥ç›‘å¬Applicationçš„ç”Ÿå‘½å‘¨æœŸï¼Œé€šå¸¸æ‰§è¡Œonstart()è§†ä¸ºå‰å°ï¼Œæ‰§è¡ŒonStop()è§†ä¸ºåå° </p>
<h2 id="WindowManager-addView-ï¼ŒView-getParent-åˆ†åˆ«å¯¹åº”ï¼Ÿ"><a href="#WindowManager-addView-ï¼ŒView-getParent-åˆ†åˆ«å¯¹åº”ï¼Ÿ" class="headerlink" title="WindowManager.addView()ï¼ŒView.getParent()åˆ†åˆ«å¯¹åº”ï¼Ÿ"></a>WindowManager.addView()ï¼ŒView.getParent()åˆ†åˆ«å¯¹åº”ï¼Ÿ</h2><p><img src="https://s2.ax1x.com/2019/12/31/l1g5Z9.png" alt="å›¾ç‰‡"></p>
<p>WindowManager.addView()æ˜¯å°†DecorViewä½œä¸ºæ ¹å¸ƒå±€åŠ å…¥åˆ°PhoneWindowä¸­å»ï¼Œè€ŒView.getParent()æŒ‡å¾—æ˜¯æ™®é€šå­viewçš„çˆ¶view</p>
<h2 id="Serializableå’ŒParcelableçš„åŒºåˆ«ï¼Ÿ"><a href="#Serializableå’ŒParcelableçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="Serializableå’ŒParcelableçš„åŒºåˆ«ï¼Ÿ"></a>Serializableå’ŒParcelableçš„åŒºåˆ«ï¼Ÿ</h2><ul>
<li>1 æ•ˆç‡ä¸åŒï¼Œä¸¤è€…æœ€å¤§çš„åŒºåˆ«åœ¨äº å­˜å‚¨åª’ä»‹çš„ä¸åŒï¼ŒSerializableä¼šä½¿ç”¨åå°„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä½¿ç”¨ I/O è¯»å†™å­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šï¼Œè€Œ Parcelable ä¸éœ€è¦ç”¨åå°„ï¼Œç›´æ¥ åœ¨å†…å­˜ä¸­è¯»å†™ã€‚å¾ˆæ˜æ˜¾ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦é€šå¸¸å¤§äº IO è¯»å†™ï¼Œæ‰€ä»¥åœ¨ Android ä¸­ä¼ é€’æ•°æ®ä¼˜å…ˆé€‰æ‹© Parcelableã€‚</li>
<li>2 ç”¨æ³•ä¸åŒ<br>Serializableä½¿ç”¨ç®€å•<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class TestSerializable implements Serializable &#123;</span><br><span class="line">    String msg;</span><br><span class="line">    </span><br><span class="line">    List&lt;ItemBean&gt; datas;</span><br><span class="line">    </span><br><span class="line">    public static class ItemBean implements Serializable&#123;</span><br><span class="line">        String name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Parcelableè¾ƒä¸ºå¤æ‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class TestParcelable implements Parcelable &#123;</span><br><span class="line">    String msg;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int describeContents() &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void writeToParcel(Parcel dest, int flags) &#123;</span><br><span class="line">        dest.writeString(this.msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TestParcelable(String msg) &#123;</span><br><span class="line">        this.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private TestParcelable(Parcel in) &#123;</span><br><span class="line">        this.msg = in.readString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static final Creator&lt;TestParcelable&gt; CREATOR = new Creator&lt;TestParcelable&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public TestParcelable createFromParcel(Parcel source) &#123;</span><br><span class="line">            return new TestParcelable(source);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public TestParcelable[] newArray(int size) &#123;</span><br><span class="line">            return new TestParcelable[size];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Androidé‡Œé¢ä¸ºä»€ä¹ˆè¦è®¾è®¡å‡ºBundleè€Œä¸æ˜¯ç›´æ¥ç”¨Mapç»“æ„ï¼Ÿ"><a href="#Androidé‡Œé¢ä¸ºä»€ä¹ˆè¦è®¾è®¡å‡ºBundleè€Œä¸æ˜¯ç›´æ¥ç”¨Mapç»“æ„ï¼Ÿ" class="headerlink" title="Androidé‡Œé¢ä¸ºä»€ä¹ˆè¦è®¾è®¡å‡ºBundleè€Œä¸æ˜¯ç›´æ¥ç”¨Mapç»“æ„ï¼Ÿ"></a>Androidé‡Œé¢ä¸ºä»€ä¹ˆè¦è®¾è®¡å‡ºBundleè€Œä¸æ˜¯ç›´æ¥ç”¨Mapç»“æ„ï¼Ÿ</h3><ul>
<li>1 æ˜¯åœ¨Androidä¸­å¦‚æœä½¿ç”¨Intentæ¥æºå¸¦æ•°æ®çš„è¯ï¼Œéœ€è¦æ•°æ®æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…æ˜¯å¯åºåˆ—åŒ–ç±»å‹ï¼ŒHashMapä½¿ç”¨Serializableè¿›è¡Œåºåˆ—åŒ–ï¼Œè€ŒBundleåˆ™æ˜¯ä½¿ç”¨Parcelableè¿›è¡Œåºåˆ—åŒ–ã€‚è€Œåœ¨Androidå¹³å°ä¸­ï¼Œæ›´æ¨èä½¿ç”¨Parcelableå®ç°åºåˆ—åŒ–ï¼Œè™½ç„¶å†™æ³•å¤æ‚ï¼Œä½†æ˜¯å¼€é”€æ›´å°ï¼Œæ‰€ä»¥ä¸ºäº†æ›´åŠ å¿«é€Ÿçš„è¿›è¡Œæ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œç³»ç»Ÿå°è£…äº†Bundleç±»ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œæ•°æ®çš„ä¼ è¾“ã€‚</li>
<li>2 Bundleå†…éƒ¨æ˜¯ç”±ArrayMapå®ç°çš„ï¼ŒArrayMapçš„å†…éƒ¨å®ç°æ˜¯ä¸¤ä¸ªæ•°ç»„ï¼Œä¸€ä¸ªintæ•°ç»„æ˜¯å­˜å‚¨å¯¹è±¡æ•°æ®å¯¹åº”ä¸‹æ ‡ï¼Œä¸€ä¸ªå¯¹è±¡æ•°ç»„ä¿å­˜keyå’Œvalueï¼Œå†…éƒ¨ä½¿ç”¨äºŒåˆ†æ³•å¯¹keyè¿›è¡Œæ’åºï¼Œæ‰€ä»¥åœ¨æ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ä¼šä½¿ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œåªé€‚åˆäºå°æ•°æ®é‡æ“ä½œï¼Œå¦‚æœåœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå®ƒçš„æ€§èƒ½å°†é€€åŒ–ã€‚è€ŒHashMapå†…éƒ¨åˆ™æ˜¯æ•°ç»„+é“¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥åœ¨æ•°æ®é‡è¾ƒå°‘çš„æ—¶å€™ï¼ŒHashMapçš„Entry Arrayæ¯”ArrayMapå ç”¨æ›´å¤šçš„å†…å­˜ã€‚å› ä¸ºä½¿ç”¨Bundleçš„åœºæ™¯å¤§å¤šæ•°ä¸ºå°æ•°æ®é‡ï¼Œæˆ‘æ²¡è§è¿‡åœ¨ä¸¤ä¸ªActivityä¹‹é—´ä¼ é€’10ä¸ªä»¥ä¸Šæ•°æ®çš„åœºæ™¯ï¼Œæ‰€ä»¥ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ArrayMapä¿å­˜æ•°æ®ï¼Œåœ¨æ“ä½œé€Ÿåº¦å’Œå†…å­˜å ç”¨ä¸Šéƒ½å…·æœ‰ä¼˜åŠ¿ï¼Œå› æ­¤ä½¿ç”¨Bundleæ¥ä¼ é€’æ•°æ®ï¼Œå¯ä»¥ä¿è¯æ›´å¿«çš„é€Ÿåº¦å’Œæ›´å°‘çš„å†…å­˜å ç”¨ã€‚</li>
</ul>
<h2 id="Javaè‡ªåŠ¨è£…ç®±å’Œè‡ªåŠ¨æ‹†ç®±"><a href="#Javaè‡ªåŠ¨è£…ç®±å’Œè‡ªåŠ¨æ‹†ç®±" class="headerlink" title="Javaè‡ªåŠ¨è£…ç®±å’Œè‡ªåŠ¨æ‹†ç®±"></a>Javaè‡ªåŠ¨è£…ç®±å’Œè‡ªåŠ¨æ‹†ç®±</h2><p>è£…ç®±å°±æ˜¯è‡ªåŠ¨å°†åŸºæœ¬æ•°æ®ç±»å‹è½¬æ¢ä¸ºåŒ…è£…å™¨ç±»å‹ï¼›æ‹†ç®±å°±æ˜¯ è‡ªåŠ¨å°†åŒ…è£…å™¨ç±»å‹è½¬æ¢ä¸ºåŸºæœ¬æ•°æ®ç±»å‹ã€‚<br>ä¸¾ä¾‹ï¼šintæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼ŒIntegeræ˜¯åŒ…è£…å™¨ç±»å‹ï¼Œçœ‹Integer.valueOf ( int i ) æ–¹æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static Integer valueOf(int i) &#123;       </span><br><span class="line">        if (i &gt;= -128 &amp;&amp; i &lt;= 127)</span><br><span class="line">            return IntegerCache.cache[i + 127];</span><br><span class="line">            //å¦‚æœiçš„å€¼å¤§äº-128å°äº127åˆ™è¿”å›ä¸€ä¸ªç¼“å†²åŒºä¸­çš„ä¸€ä¸ªIntegerå¯¹è±¡</span><br><span class="line">        return new Integer(i);</span><br><span class="line">        //å¦åˆ™è¿”å› new ä¸€ä¸ªInteger å¯¹è±¡</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>åŸæ¥IntegerCache ç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”Ÿæˆäº†ä¸€ä¸ªå¤§å°ä¸º 256 çš„integer ç±»å‹çš„å¸¸é‡æ± ï¼Œå¹¶ä¸”integer.val çš„å€¼ä»-128-127ï¼Œå½“æˆ‘ä»¬è¿è¡Œ Integer c=a ;æ—¶ï¼Œå¦‚æœ -128&lt;=a&lt;=127æ—¶ï¼Œä¸ä¼šå†ç”Ÿæˆæ–°çš„integerå¯¹è±¡ï¼Œç›´æ¥ä»å¸¸é‡æ± ä¸­æ‰¾åˆ°å¯¹åº”çš„å·²ç»åˆå§‹åŒ–åçš„å¯¹è±¡ã€‚å½“ a&lt;-128||a&gt;127æ—¶ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p>
<h2 id="synchronizedä¸volatile"><a href="#synchronizedä¸volatile" class="headerlink" title="synchronizedä¸volatile"></a>synchronizedä¸volatile</h2><h3 id="synchronizedï¼š"><a href="#synchronizedï¼š" class="headerlink" title="synchronizedï¼š"></a>synchronizedï¼š</h3><p>åŒæ­¥å—å¤§å®¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰ï¼Œé€šè¿‡ synchronized å…³é”®å­—æ¥å®ç°ï¼Œæ‰€æœ‰åŠ ä¸Šsynchronized å’Œ å—è¯­å¥ï¼Œåœ¨å¤šçº¿ç¨‹è®¿é—®çš„æ—¶å€™ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç”¨<br>synchronized ä¿®é¥°çš„æ–¹æ³• æˆ–è€… ä»£ç å—ã€‚</p>
<h3 id="volatileï¼š"><a href="#volatileï¼š" class="headerlink" title="volatileï¼š"></a>volatileï¼š</h3><p>ç”¨volatileä¿®é¥°çš„å˜é‡ï¼Œçº¿ç¨‹åœ¨æ¯æ¬¡ä½¿ç”¨å˜é‡çš„æ—¶å€™ï¼Œéƒ½ä¼šå»è¯»ä¸»å†…å­˜ï¼Œå–å˜é‡ä¿®æ”¹åçš„æœ€æ–°çš„å€¼ã€‚</p>
<h4 id="JVMåœ¨è¿è¡Œæ—¶å€™çš„å†…å­˜åˆ†é…è¿‡ç¨‹ï¼š"><a href="#JVMåœ¨è¿è¡Œæ—¶å€™çš„å†…å­˜åˆ†é…è¿‡ç¨‹ï¼š" class="headerlink" title="JVMåœ¨è¿è¡Œæ—¶å€™çš„å†…å­˜åˆ†é…è¿‡ç¨‹ï¼š"></a>JVMåœ¨è¿è¡Œæ—¶å€™çš„å†…å­˜åˆ†é…è¿‡ç¨‹ï¼š</h4><p>æœ‰ä¸€ä¸ªå†…å­˜åŒºåŸŸæ˜¯jvmè™šæ‹Ÿæœºæ ˆï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹è¿è¡Œæ—¶éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ ˆï¼Œ<br>çº¿ç¨‹æ ˆä¿å­˜äº†çº¿ç¨‹è¿è¡Œæ—¶å€™å˜é‡å€¼ä¿¡æ¯ã€‚å½“çº¿ç¨‹è®¿é—®æŸä¸€ä¸ªå¯¹è±¡æ—¶å€™å€¼çš„æ—¶å€™ï¼Œé¦–å…ˆé€šè¿‡å¯¹è±¡çš„å¼•ç”¨æ‰¾åˆ°å¯¹åº”åœ¨å †å†…å­˜çš„å˜é‡çš„å€¼ï¼Œç„¶åæŠŠå †å†…å­˜<br>å˜é‡çš„å…·ä½“å€¼loadåˆ°çº¿ç¨‹æœ¬åœ°å†…å­˜ä¸­ï¼Œå»ºç«‹ä¸€ä¸ªå˜é‡å‰¯æœ¬ï¼Œä¹‹åçº¿ç¨‹å°±ä¸å†å’Œå¯¹è±¡åœ¨å †å†…å­˜å˜é‡å€¼æœ‰ä»»ä½•å…³ç³»ï¼Œè€Œæ˜¯ç›´æ¥ä¿®æ”¹å‰¯æœ¬å˜é‡çš„å€¼ï¼Œ<br>åœ¨ä¿®æ”¹å®Œä¹‹åçš„æŸä¸€ä¸ªæ—¶åˆ»ï¼ˆçº¿ç¨‹é€€å‡ºä¹‹å‰ï¼‰ï¼Œè‡ªåŠ¨æŠŠçº¿ç¨‹å˜é‡å‰¯æœ¬çš„å€¼å›å†™åˆ°å¯¹è±¡åœ¨å †ä¸­å˜é‡ã€‚è¿™æ ·åœ¨å †ä¸­çš„å¯¹è±¡çš„å€¼å°±äº§ç”Ÿå˜åŒ–äº†ã€‚<br><img src="https://s2.ax1x.com/2019/12/31/l1cs1O.png" alt="å›¾ç‰‡"><br>å°ç»“ï¼šåŠ ä¸Švolatileå…³é”®å­—ï¼Œå¼ºåˆ¶çº¿ç¨‹æ¯æ¬¡è¯»å–è¯¥å€¼çš„æ—¶å€™éƒ½å»â€œä¸»å†…å­˜â€ä¸­å–å€¼ã€‚ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚</p>
<h2 id="requestLayoutã€invalidateä¸postInvalidateåŒºåˆ«"><a href="#requestLayoutã€invalidateä¸postInvalidateåŒºåˆ«" class="headerlink" title="requestLayoutã€invalidateä¸postInvalidateåŒºåˆ«"></a>requestLayoutã€invalidateä¸postInvalidateåŒºåˆ«</h2><h3 id="requestLayout"><a href="#requestLayout" class="headerlink" title="requestLayout:"></a>requestLayout:</h3><p>ä»æ–¹æ³•åå­—å¯ä»¥çŸ¥é“ï¼Œâ€œè¯·æ±‚å¸ƒå±€â€ï¼Œé‚£å°±æ˜¯è¯´ï¼Œå¦‚æœè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªå­Viewæ¥è¯´ï¼Œåº”è¯¥ä¼šé‡æ–°è¿›è¡Œå¸ƒå±€æµç¨‹ã€‚ä½†æ˜¯ï¼ŒçœŸå®æƒ…å†µç•¥æœ‰ä¸åŒï¼Œå¦‚æœå­Viewè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œå…¶å®ä¼šä»Viewæ ‘é‡æ–°è¿›è¡Œä¸€æ¬¡æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶è¿™ä¸‰ä¸ªæµç¨‹ï¼Œæœ€ç»ˆå°±ä¼šæ˜¾ç¤ºå­Viewçš„æœ€ç»ˆæƒ…å†µã€‚</p>
<h3 id="invalidate"><a href="#invalidate" class="headerlink" title="invalidate:"></a>invalidate:</h3><p>viewçš„invalidateä¸ä¼šå¯¼è‡´ViewRootImplçš„invalidateè¢«è°ƒç”¨ï¼Œè€Œæ˜¯é€’å½’è°ƒç”¨çˆ¶viewçš„invalidateChildInParentï¼Œç›´åˆ°ViewRootImplçš„invalidateChildInParentï¼Œç„¶åè§¦å‘peformTraversalsï¼Œä¼šå¯¼è‡´å½“å‰viewè¢«é‡ç»˜,ç”±äºmLayoutRequestedä¸ºfalseï¼Œä¸ä¼šå¯¼è‡´onMeasureå’ŒonLayoutè¢«è°ƒç”¨ï¼Œè€ŒOnDrawä¼šè¢«è°ƒç”¨</p>
<h3 id="postInvalidate"><a href="#postInvalidate" class="headerlink" title="postInvalidate:"></a>postInvalidate:</h3><p>postInvalidateæ˜¯åœ¨éUIçº¿ç¨‹ä¸­è°ƒç”¨ï¼Œinvalidateåˆ™æ˜¯åœ¨UIçº¿ç¨‹ä¸­è°ƒç”¨ã€‚</p>
<p><img src="https://s2.ax1x.com/2019/12/31/l1prYq.png" alt="å›¾ç‰‡"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/28/Binderæœºåˆ¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/28/Binderæœºåˆ¶/" itemprop="url">Binderæœºåˆ¶</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-12-28T00:00:00+08:00">
                2019-12-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/28/Binderæœºåˆ¶/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/12/28/Binderæœºåˆ¶/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="æœ¬ç¯‡æ–‡ç« çš„èƒŒæ™¯ä»¥åŠå¤™æ„¿"><a href="#æœ¬ç¯‡æ–‡ç« çš„èƒŒæ™¯ä»¥åŠå¤™æ„¿" class="headerlink" title="æœ¬ç¯‡æ–‡ç« çš„èƒŒæ™¯ä»¥åŠå¤™æ„¿"></a>æœ¬ç¯‡æ–‡ç« çš„èƒŒæ™¯ä»¥åŠå¤™æ„¿</h2><ul>
<li>1 äº†è§£Binderæœºåˆ¶ï¼Œæ¯•ç«ŸæŒºéš¾çš„</li>
<li>2 é™ªåª³å¦‡å„¿åŠ ç­ä¸­ï¼Œå¾…ç€ä¹Ÿæ˜¯å¾…ç€</li>
</ul>
<h2 id="æ­£æ–‡ä¹‹å‰éœ€è¦è¯´å¾—Binder"><a href="#æ­£æ–‡ä¹‹å‰éœ€è¦è¯´å¾—Binder" class="headerlink" title="æ­£æ–‡ä¹‹å‰éœ€è¦è¯´å¾—Binder"></a>æ­£æ–‡ä¹‹å‰éœ€è¦è¯´å¾—Binder</h2><h3 id="æ¦‚å¿µï¼š"><a href="#æ¦‚å¿µï¼š" class="headerlink" title="æ¦‚å¿µï¼š"></a>æ¦‚å¿µï¼š</h3><p>ä¸€å¥è¯ï¼ŒBinderæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</p>
<h3 id="Androidä¸ºä»€ä¹ˆé€‰æ‹©Binder"><a href="#Androidä¸ºä»€ä¹ˆé€‰æ‹©Binder" class="headerlink" title="Androidä¸ºä»€ä¹ˆé€‰æ‹©Binder"></a>Androidä¸ºä»€ä¹ˆé€‰æ‹©Binder</h3><p>Android ç³»ç»Ÿæ˜¯åŸºäº Linux å†…æ ¸çš„ï¼ŒLinux å·²ç»æä¾›äº†ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜å’Œ Socket ç­‰ IPC æœºåˆ¶ã€‚é‚£ä¸ºä»€ä¹ˆ Android è¿˜è¦æä¾› Binder æ¥å®ç° IPC å‘¢ï¼Ÿä¸»è¦æ˜¯åŸºäºæ€§èƒ½ã€ç¨³å®šæ€§å’Œå®‰å…¨æ€§å‡ æ–¹é¢çš„åŸå› ã€‚</p>
<h4 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h4><p>é¦–å…ˆè¯´è¯´æ€§èƒ½ä¸Šçš„ä¼˜åŠ¿ã€‚Socket ä½œä¸ºä¸€æ¬¾é€šç”¨æ¥å£ï¼Œå…¶ä¼ è¾“æ•ˆç‡ä½ï¼Œå¼€é”€å¤§ï¼Œä¸»è¦ç”¨åœ¨è·¨ç½‘ç»œçš„è¿›ç¨‹é—´é€šä¿¡å’Œæœ¬æœºä¸Šè¿›ç¨‹é—´çš„ä½é€Ÿé€šä¿¡ã€‚æ¶ˆæ¯é˜Ÿåˆ—å’Œç®¡é“é‡‡ç”¨å­˜å‚¨-è½¬å‘æ–¹å¼ï¼Œå³æ•°æ®å…ˆä»å‘é€æ–¹ç¼“å­˜åŒºæ‹·è´åˆ°å†…æ ¸å¼€è¾Ÿçš„ç¼“å­˜åŒºä¸­ï¼Œç„¶åå†ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶æ–¹ç¼“å­˜åŒºï¼Œè‡³å°‘æœ‰ä¸¤æ¬¡æ‹·è´è¿‡ç¨‹ã€‚å…±äº«å†…å­˜è™½ç„¶æ— éœ€æ‹·è´ï¼Œä½†æ§åˆ¶å¤æ‚ï¼Œéš¾ä»¥ä½¿ç”¨ã€‚Binder åªéœ€è¦ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œæ€§èƒ½ä¸Šä»…æ¬¡äºå…±äº«å†…å­˜ã€‚</p>
<h4 id="ç¨³å®šæ€§"><a href="#ç¨³å®šæ€§" class="headerlink" title="ç¨³å®šæ€§"></a>ç¨³å®šæ€§</h4><p>Binder åŸºäº C/S æ¶æ„ï¼Œå®¢æˆ·ç«¯ï¼ˆClientï¼‰æœ‰ä»€ä¹ˆéœ€æ±‚å°±ä¸¢ç»™æœåŠ¡ç«¯ï¼ˆServerï¼‰å»å®Œæˆï¼Œæ¶æ„æ¸…æ™°ã€èŒè´£æ˜ç¡®åˆç›¸äº’ç‹¬ç«‹ï¼Œè‡ªç„¶ç¨³å®šæ€§æ›´å¥½ã€‚å…±äº«å†…å­˜è™½ç„¶æ— éœ€æ‹·è´ï¼Œä½†æ˜¯æ§åˆ¶è´Ÿè´£ï¼Œéš¾ä»¥ä½¿ç”¨ã€‚ä»ç¨³å®šæ€§çš„è§’åº¦è®²ï¼ŒBinder æœºåˆ¶æ˜¯ä¼˜äºå†…å­˜å…±äº«çš„ã€‚</p>
<h4 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h4><p>å¦ä¸€æ–¹é¢å°±æ˜¯å®‰å…¨æ€§ã€‚Android ä½œä¸ºä¸€ä¸ªå¼€æ”¾æ€§çš„å¹³å°ï¼Œå¸‚åœºä¸Šæœ‰å„ç±»æµ·é‡çš„åº”ç”¨ä¾›ç”¨æˆ·é€‰æ‹©å®‰è£…ï¼Œå› æ­¤å®‰å…¨æ€§å¯¹äº Android å¹³å°è€Œè¨€æå…¶é‡è¦ã€‚ä½œä¸ºç”¨æˆ·å½“ç„¶ä¸å¸Œæœ›æˆ‘ä»¬ä¸‹è½½çš„ APP å·å·è¯»å–æˆ‘çš„é€šä¿¡å½•ï¼Œä¸Šä¼ æˆ‘çš„éšç§æ•°æ®ï¼Œåå°å·è·‘æµé‡ã€æ¶ˆè€—æ‰‹æœºç”µé‡ã€‚ä¼ ç»Ÿçš„ IPC æ²¡æœ‰ä»»ä½•å®‰å…¨æªæ–½ï¼Œå®Œå…¨ä¾èµ–ä¸Šå±‚åè®®æ¥ç¡®ä¿ã€‚é¦–å…ˆä¼ ç»Ÿçš„ IPC æ¥æ”¶æ–¹æ— æ³•è·å¾—å¯¹æ–¹å¯é çš„è¿›ç¨‹ç”¨æˆ·ID/è¿›ç¨‹IDï¼ˆUID/PIDï¼‰ï¼Œä»è€Œæ— æ³•é‰´åˆ«å¯¹æ–¹èº«ä»½ã€‚Android ä¸ºæ¯ä¸ªå®‰è£…å¥½çš„ APP åˆ†é…äº†è‡ªå·±çš„ UIDï¼Œæ•…è€Œè¿›ç¨‹çš„ UID æ˜¯é‰´åˆ«è¿›ç¨‹èº«ä»½çš„é‡è¦æ ‡å¿—ã€‚ä¼ ç»Ÿçš„ IPC åªèƒ½ç”±ç”¨æˆ·åœ¨æ•°æ®åŒ…ä¸­å¡«å…¥ UID/PIDï¼Œä½†è¿™æ ·ä¸å¯é ï¼Œå®¹æ˜“è¢«æ¶æ„ç¨‹åºåˆ©ç”¨ã€‚å¯é çš„èº«ä»½æ ‡è¯†åªæœ‰ç”± IPC æœºåˆ¶åœ¨å†…æ ¸ä¸­æ·»åŠ ã€‚å…¶æ¬¡ä¼ ç»Ÿçš„ IPC è®¿é—®æ¥å…¥ç‚¹æ˜¯å¼€æ”¾çš„ï¼Œåªè¦çŸ¥é“è¿™äº›æ¥å…¥ç‚¹çš„ç¨‹åºéƒ½å¯ä»¥å’Œå¯¹ç«¯å»ºç«‹è¿æ¥ï¼Œä¸ç®¡æ€æ ·éƒ½æ— æ³•é˜»æ­¢æ¶æ„ç¨‹åºé€šè¿‡çŒœæµ‹æ¥æ”¶æ–¹åœ°å€è·å¾—è¿æ¥ã€‚åŒæ—¶ Binder æ—¢æ”¯æŒå®å Binderï¼Œåˆæ”¯æŒåŒ¿å Binderï¼Œå®‰å…¨æ€§é«˜ã€‚</p>
<h2 id="Linux-ä¸‹ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡åŸç†"><a href="#Linux-ä¸‹ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡åŸç†" class="headerlink" title="Linux ä¸‹ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡åŸç†"></a>Linux ä¸‹ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡åŸç†</h2><p><img src="https://s2.ax1x.com/2019/12/28/lmA4FP.png" alt="å›¾ç‰‡"></p>
<h3 id="æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š"><a href="#æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š" class="headerlink" title="æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š"></a>æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š</h3><ul>
<li><p>1 è¿›ç¨‹éš”ç¦»<br>ç®€å•çš„è¯´å°±æ˜¯æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹ä¸è¿›ç¨‹é—´å†…å­˜æ˜¯ä¸å…±äº«çš„ã€‚ä¸¤ä¸ªè¿›ç¨‹å°±åƒä¸¤ä¸ªå¹³è¡Œçš„ä¸–ç•Œï¼ŒA è¿›ç¨‹æ²¡æ³•ç›´æ¥è®¿é—® B è¿›ç¨‹çš„æ•°æ®ï¼Œè¿™å°±æ˜¯è¿›ç¨‹éš”ç¦»çš„é€šä¿—è§£é‡Šã€‚A è¿›ç¨‹å’Œ B è¿›ç¨‹ä¹‹é—´è¦è¿›è¡Œæ•°æ®äº¤äº’å°±å¾—é‡‡ç”¨ç‰¹æ®Šçš„é€šä¿¡æœºåˆ¶ï¼šè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ã€‚</p>
</li>
<li><p>2 è¿›ç¨‹ç©ºé—´åˆ’åˆ†<br>ç°åœ¨æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨çš„è™šæ‹Ÿå­˜å‚¨å™¨ï¼Œå¯¹äº 32 ä½ç³»ç»Ÿè€Œè¨€ï¼Œå®ƒçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰å°±æ˜¯ 2 çš„ 32 æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯ 4GBã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿå¯ä»¥è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æƒé™ã€‚ä¸ºäº†ä¿æŠ¤ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ï¼Œä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œæ“ä½œç³»ç»Ÿä»é€»è¾‘ä¸Šå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†ä¸ºç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰å’Œå†…æ ¸ç©ºé—´ï¼ˆKernel Spaceï¼‰ã€‚é’ˆå¯¹ Linux æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå°†æœ€é«˜çš„ 1GB å­—èŠ‚ä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼›è¾ƒä½çš„ 3GB å­—èŠ‚ä¾›å„è¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚</p>
</li>
<li><p>3 ç³»ç»Ÿè°ƒç”¨ï¼šç”¨æˆ·æ€ä¸å†…æ ¸æ€<br>è™½ç„¶ä»é€»è¾‘ä¸Šè¿›è¡Œäº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„åˆ’åˆ†ï¼Œä½†ä¸å¯é¿å…çš„ç”¨æˆ·ç©ºé—´éœ€è¦è®¿é—®å†…æ ¸èµ„æºï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€è®¿é—®ç½‘ç»œç­‰ç­‰ã€‚ä¸ºäº†çªç ´éš”ç¦»é™åˆ¶ï¼Œå°±éœ€è¦å€ŸåŠ©ç³»ç»Ÿè°ƒç”¨æ¥å®ç°ã€‚ç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æˆ·ç©ºé—´è®¿é—®å†…æ ¸ç©ºé—´çš„å”¯ä¸€æ–¹å¼ï¼Œä¿è¯äº†æ‰€æœ‰çš„èµ„æºè®¿é—®éƒ½æ˜¯åœ¨å†…æ ¸çš„æ§åˆ¶ä¸‹è¿›è¡Œçš„ï¼Œé¿å…äº†ç”¨æˆ·ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„è¶Šæƒè®¿é—®ï¼Œæå‡äº†ç³»ç»Ÿå®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</p>
</li>
</ul>
<p>Linux ä½¿ç”¨ä¸¤çº§ä¿æŠ¤æœºåˆ¶ï¼š0 çº§ä¾›ç³»ç»Ÿå†…æ ¸ä½¿ç”¨ï¼Œ3 çº§ä¾›ç”¨æˆ·ç¨‹åºä½¿ç”¨ã€‚<br>å½“ä¸€ä¸ªä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è€Œé™·å…¥å†…æ ¸ä»£ç ä¸­æ‰§è¡Œæ—¶ï¼Œç§°è¿›ç¨‹å¤„äºå†…æ ¸è¿è¡Œæ€ï¼ˆå†…æ ¸æ€ï¼‰ã€‚æ­¤æ—¶å¤„ç†å™¨å¤„äºç‰¹æƒçº§æœ€é«˜çš„ï¼ˆ0çº§ï¼‰å†…æ ¸ä»£ç ä¸­æ‰§è¡Œã€‚å½“è¿›ç¨‹å¤„äºå†…æ ¸æ€æ—¶ï¼Œæ‰§è¡Œçš„å†…æ ¸ä»£ç ä¼šä½¿ç”¨å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å†…æ ¸æ ˆã€‚<br>å½“è¿›ç¨‹åœ¨æ‰§è¡Œç”¨æˆ·è‡ªå·±çš„ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç§°å…¶å¤„äºç”¨æˆ·è¿è¡Œæ€ï¼ˆç”¨æˆ·æ€ï¼‰ã€‚æ­¤æ—¶å¤„ç†å™¨åœ¨ç‰¹æƒçº§æœ€ä½çš„ï¼ˆ3çº§ï¼‰ç”¨æˆ·ä»£ç ä¸­è¿è¡Œã€‚</p>
<h3 id="ä¼ ç»Ÿé€šä¿¡åŸç†ç®€è¿°"><a href="#ä¼ ç»Ÿé€šä¿¡åŸç†ç®€è¿°" class="headerlink" title="ä¼ ç»Ÿé€šä¿¡åŸç†ç®€è¿°"></a>ä¼ ç»Ÿé€šä¿¡åŸç†ç®€è¿°</h3><p>é€šå¸¸çš„åšæ³•æ˜¯æ¶ˆæ¯å‘é€æ–¹å°†è¦å‘é€çš„æ•°æ®å­˜æ”¾åœ¨å†…å­˜ç¼“å­˜åŒºä¸­ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ€ã€‚ç„¶åå†…æ ¸ç¨‹åºåœ¨å†…æ ¸ç©ºé—´åˆ†é…å†…å­˜ï¼Œå¼€è¾Ÿä¸€å—å†…æ ¸ç¼“å­˜åŒºï¼Œè°ƒç”¨ copy_from_user() å‡½æ•°å°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´çš„å†…å­˜ç¼“å­˜åŒºæ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„å†…æ ¸ç¼“å­˜åŒºä¸­ã€‚åŒæ ·çš„ï¼Œæ¥æ”¶æ–¹è¿›ç¨‹åœ¨æ¥æ”¶æ•°æ®æ—¶åœ¨è‡ªå·±çš„ç”¨æˆ·ç©ºé—´å¼€è¾Ÿä¸€å—å†…å­˜ç¼“å­˜åŒºï¼Œç„¶åå†…æ ¸ç¨‹åºè°ƒç”¨ copy_to_user() å‡½æ•°å°†æ•°æ®ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶è¿›ç¨‹çš„å†…å­˜ç¼“å­˜åŒºã€‚è¿™æ ·æ•°æ®å‘é€æ–¹è¿›ç¨‹å’Œæ•°æ®æ¥æ”¶æ–¹è¿›ç¨‹å°±å®Œæˆäº†ä¸€æ¬¡æ•°æ®ä¼ è¾“ï¼Œæˆ‘ä»¬ç§°å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´é€šä¿¡ã€‚<br>å¦‚ä¸‹å›¾ï¼š<br><img src="https://s2.ax1x.com/2019/12/28/lmEgpT.png" alt="å›¾ç‰‡"></p>
<h3 id="ä¼ ç»Ÿçš„-IPC-é€šä¿¡æ–¹å¼ç¼ºç‚¹"><a href="#ä¼ ç»Ÿçš„-IPC-é€šä¿¡æ–¹å¼ç¼ºç‚¹" class="headerlink" title="ä¼ ç»Ÿçš„ IPC é€šä¿¡æ–¹å¼ç¼ºç‚¹"></a>ä¼ ç»Ÿçš„ IPC é€šä¿¡æ–¹å¼ç¼ºç‚¹</h3><ul>
<li>1 æ€§èƒ½ä½ä¸‹ï¼Œä¸€æ¬¡æ•°æ®ä¼ é€’éœ€è¦ç»å†ï¼šå†…å­˜ç¼“å­˜åŒº â€“&gt; å†…æ ¸ç¼“å­˜åŒº â€“&gt; å†…å­˜ç¼“å­˜åŒºï¼Œéœ€è¦ 2 æ¬¡æ•°æ®æ‹·è´ï¼›</li>
<li>2 æ¥æ”¶æ•°æ®çš„ç¼“å­˜åŒºç”±æ•°æ®æ¥æ”¶è¿›ç¨‹æä¾›ï¼Œä½†æ˜¯æ¥æ”¶è¿›ç¨‹å¹¶ä¸çŸ¥é“éœ€è¦å¤šå¤§çš„ç©ºé—´æ¥å­˜æ”¾å°†è¦ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œå› æ­¤åªèƒ½å¼€è¾Ÿå°½å¯èƒ½å¤§çš„å†…å­˜ç©ºé—´æˆ–è€…å…ˆè°ƒç”¨ API æ¥æ”¶æ¶ˆæ¯å¤´æ¥è·å–æ¶ˆæ¯ä½“çš„å¤§å°ï¼Œè¿™ä¸¤ç§åšæ³•ä¸æ˜¯æµªè´¹ç©ºé—´å°±æ˜¯æµªè´¹æ—¶é—´ã€‚</li>
</ul>
<h2 id="Binderè·¨è¿›ç¨‹é€šä¿¡åŸç†"><a href="#Binderè·¨è¿›ç¨‹é€šä¿¡åŸç†" class="headerlink" title="Binderè·¨è¿›ç¨‹é€šä¿¡åŸç†"></a>Binderè·¨è¿›ç¨‹é€šä¿¡åŸç†</h2><h3 id="æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š-1"><a href="#æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š-1" class="headerlink" title="æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š"></a>æ¶‰åŠå‡ ä¸ªæ¦‚å¿µï¼š</h3><ul>
<li>1 åŠ¨æ€å†…æ ¸å¯åŠ è½½æ¨¡å—<br>æ¨¡å—æ˜¯å…·æœ‰ç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºï¼Œå®ƒå¯ä»¥è¢«å•ç‹¬ç¼–è¯‘ï¼Œä½†æ˜¯ä¸èƒ½ç‹¬ç«‹è¿è¡Œã€‚å®ƒåœ¨è¿è¡Œæ—¶è¢«é“¾æ¥åˆ°å†…æ ¸ä½œä¸ºå†…æ ¸çš„ä¸€éƒ¨åˆ†è¿è¡Œã€‚è¿™æ ·ï¼ŒAndroid ç³»ç»Ÿå°±å¯ä»¥é€šè¿‡åŠ¨æ€æ·»åŠ ä¸€ä¸ªå†…æ ¸æ¨¡å—è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·è¿›ç¨‹ä¹‹é—´é€šè¿‡è¿™ä¸ªå†…æ ¸æ¨¡å—ä½œä¸ºæ¡¥æ¢æ¥å®ç°é€šä¿¡ã€‚åœ¨ Android ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªè¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œè´Ÿè´£å„ä¸ªç”¨æˆ·è¿›ç¨‹é€šè¿‡ Binder å®ç°é€šä¿¡çš„å†…æ ¸æ¨¡å—å°±å« Binder é©±åŠ¨ï¼ˆBinder Dirverï¼‰ã€‚</li>
<li>2 å†…å­˜æ˜ å°„<br>Binder IPC æœºåˆ¶ä¸­æ¶‰åŠåˆ°çš„å†…å­˜æ˜ å°„é€šè¿‡ mmap() æ¥å®ç°ï¼Œmmap() æ˜¯æ“ä½œç³»ç»Ÿä¸­ä¸€ç§å†…å­˜æ˜ å°„çš„æ–¹æ³•ã€‚å†…å­˜æ˜ å°„ç®€å•çš„è®²å°±æ˜¯å°†ç”¨æˆ·ç©ºé—´çš„ä¸€å—å†…å­˜åŒºåŸŸæ˜ å°„åˆ°å†…æ ¸ç©ºé—´ã€‚æ˜ å°„å…³ç³»å»ºç«‹åï¼Œç”¨æˆ·å¯¹è¿™å—å†…å­˜åŒºåŸŸçš„ä¿®æ”¹å¯ä»¥ç›´æ¥ååº”åˆ°å†…æ ¸ç©ºé—´ï¼›åä¹‹å†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿèƒ½ç›´æ¥ååº”åˆ°ç”¨æˆ·ç©ºé—´ã€‚<br>å†…å­˜æ˜ å°„èƒ½å‡å°‘æ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå®ç°ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é«˜æ•ˆäº’åŠ¨ã€‚ä¸¤ä¸ªç©ºé—´å„è‡ªçš„ä¿®æ”¹èƒ½ç›´æ¥åæ˜ åœ¨æ˜ å°„çš„å†…å­˜åŒºåŸŸï¼Œä»è€Œè¢«å¯¹æ–¹ç©ºé—´åŠæ—¶æ„ŸçŸ¥ã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œå†…å­˜æ˜ å°„èƒ½å¤Ÿæä¾›å¯¹è¿›ç¨‹é—´é€šä¿¡çš„æ”¯æŒã€‚</li>
</ul>
<h3 id="Binder-IPC-å®ç°æ­¥éª¤ï¼š"><a href="#Binder-IPC-å®ç°æ­¥éª¤ï¼š" class="headerlink" title="Binder IPC å®ç°æ­¥éª¤ï¼š"></a>Binder IPC å®ç°æ­¥éª¤ï¼š</h3><ul>
<li>1 é¦–å…ˆ Binder é©±åŠ¨åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºä¸€ä¸ªæ•°æ®æ¥æ”¶ç¼“å­˜åŒºï¼›</li>
<li>2 æ¥ç€åœ¨å†…æ ¸ç©ºé—´å¼€è¾Ÿä¸€å—å†…æ ¸ç¼“å­˜åŒºï¼Œå»ºç«‹å†…æ ¸ç¼“å­˜åŒºå’Œå†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒºä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠå†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒºå’Œæ¥æ”¶è¿›ç¨‹ç”¨æˆ·ç©ºé—´åœ°å€çš„æ˜ å°„å…³ç³»ï¼›</li>
<li>3 å‘é€æ–¹è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ copy_from_user() å°†æ•°æ® copy åˆ°å†…æ ¸ä¸­çš„å†…æ ¸ç¼“å­˜åŒºï¼Œç”±äºå†…æ ¸ç¼“å­˜åŒºå’Œæ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´å­˜åœ¨å†…å­˜æ˜ å°„ï¼Œå› æ­¤ä¹Ÿå°±ç›¸å½“äºæŠŠæ•°æ®å‘é€åˆ°äº†æ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ä¾¿å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´çš„é€šä¿¡ã€‚<br>å¦‚ä¸‹å›¾ï¼š<br><img src="https://s2.ax1x.com/2019/12/28/lmDiGt.png" alt="å›¾ç‰‡"></li>
</ul>
<h2 id="Binderé€šä¿¡è¿‡ç¨‹"><a href="#Binderé€šä¿¡è¿‡ç¨‹" class="headerlink" title="Binderé€šä¿¡è¿‡ç¨‹"></a>Binderé€šä¿¡è¿‡ç¨‹</h2><p>ä¸€æ¬¡å®Œæ•´çš„è¿›ç¨‹é—´é€šä¿¡å¿…ç„¶è‡³å°‘åŒ…å«ä¸¤ä¸ªè¿›ç¨‹ï¼Œé€šå¸¸æˆ‘ä»¬ç§°é€šä¿¡çš„åŒæ–¹åˆ†åˆ«ä¸ºå®¢æˆ·ç«¯è¿›ç¨‹ï¼ˆClientï¼‰å’ŒæœåŠ¡ç«¯è¿›ç¨‹ï¼ˆServerï¼‰ï¼Œç”±äºè¿›ç¨‹éš”ç¦»æœºåˆ¶çš„å­˜åœ¨ï¼Œé€šä¿¡åŒæ–¹å¿…ç„¶éœ€è¦å€ŸåŠ© Binder æ¥å®ç°ã€‚</p>
<h3 id="äº’è”ç½‘é€šä¿¡è¿‡ç¨‹ï¼š"><a href="#äº’è”ç½‘é€šä¿¡è¿‡ç¨‹ï¼š" class="headerlink" title="äº’è”ç½‘é€šä¿¡è¿‡ç¨‹ï¼š"></a>äº’è”ç½‘é€šä¿¡è¿‡ç¨‹ï¼š</h3><p>åŒ…æ‹¬ Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨ã€‚å…¶ä¸­ Clientã€Serverã€Service Manager è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼ŒBinder é©±åŠ¨è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ã€‚å…¶ä¸­ Service Manager å’Œ Binder é©±åŠ¨ç”±ç³»ç»Ÿæä¾›ï¼Œè€Œ Clientã€Server ç”±åº”ç”¨ç¨‹åºæ¥å®ç°ã€‚Clientã€Server å’Œ ServiceManager å‡æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ openã€mmap å’Œ ioctl æ¥è®¿é—®è®¾å¤‡æ–‡ä»¶ /dev/binderï¼Œä»è€Œå®ç°ä¸ Binder é©±åŠ¨çš„äº¤äº’æ¥é—´æ¥çš„å®ç°è·¨è¿›ç¨‹é€šä¿¡ã€‚<br>å¦‚ä¸‹å›¾ï¼š<br><img src="https://s2.ax1x.com/2019/12/29/lus9jx.md.png" alt="å›¾ç‰‡"><br>Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨è¿™å‡ ä¸ªç»„ä»¶åœ¨é€šä¿¡è¿‡ç¨‹ä¸­æ‰®æ¼”çš„è§’è‰²å°±å¦‚åŒäº’è”ç½‘ä¸­æœåŠ¡å™¨ï¼ˆServerï¼‰ã€å®¢æˆ·ç«¯ï¼ˆClientï¼‰ã€DNSåŸŸåæœåŠ¡å™¨ï¼ˆServiceManagerï¼‰ä»¥åŠè·¯ç”±å™¨ï¼ˆBinder é©±åŠ¨ï¼‰ä¹‹é—´çš„å…³ç³»ã€‚<br>é€šå¸¸æˆ‘ä»¬è®¿é—®ä¸€ä¸ªç½‘é¡µçš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆåœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œå¦‚ <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a> ç„¶åæŒ‰ä¸‹å›è½¦é”®ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰åŠæ³•é€šè¿‡åŸŸååœ°å€ç›´æ¥æ‰¾åˆ°æˆ‘ä»¬è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œå› æ­¤éœ€è¦é¦–å…ˆè®¿é—® DNS åŸŸåæœåŠ¡å™¨ï¼ŒåŸŸåæœåŠ¡å™¨ä¸­ä¿å­˜äº† <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a> å¯¹åº”çš„ ip åœ°å€ 10.249.23.13ï¼Œç„¶åé€šè¿‡è¿™ä¸ª ip åœ°å€æ‰èƒ½æ”¾åˆ°åˆ° <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a> å¯¹åº”çš„æœåŠ¡å™¨ã€‚<br><img src="https://s2.ax1x.com/2019/12/29/lus2x1.png" alt="å›¾ç‰‡"></p>
<h3 id="Binderé€šä¿¡è¿‡ç¨‹ï¼š"><a href="#Binderé€šä¿¡è¿‡ç¨‹ï¼š" class="headerlink" title="Binderé€šä¿¡è¿‡ç¨‹ï¼š"></a>Binderé€šä¿¡è¿‡ç¨‹ï¼š</h3><p>å¤§è‡´èƒ½æ€»ç»“å‡º Binder é€šä¿¡è¿‡ç¨‹ï¼š</p>
<ul>
<li>1 é¦–å…ˆï¼Œä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ BINDER_SET_CONTEXT_MGR å‘½ä»¤é€šè¿‡ Binder é©±åŠ¨å°†è‡ªå·±æ³¨å†Œæˆä¸º ServiceManagerï¼›</li>
<li>2 Server é€šè¿‡é©±åŠ¨å‘ ServiceManager ä¸­æ³¨å†Œ Binderï¼ˆServer ä¸­çš„ Binder å®ä½“ï¼‰ï¼Œè¡¨æ˜å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ã€‚é©±åŠ¨ä¸ºè¿™ä¸ª Binder åˆ›å»ºä½äºå†…æ ¸ä¸­çš„å®ä½“èŠ‚ç‚¹ä»¥åŠ ServiceManager å¯¹å®ä½“çš„å¼•ç”¨ï¼Œå°†åå­—ä»¥åŠæ–°å»ºçš„å¼•ç”¨æ‰“åŒ…ä¼ ç»™ ServiceManagerï¼ŒServiceManger å°†å…¶å¡«å…¥æŸ¥æ‰¾è¡¨ã€‚</li>
<li>3 Client é€šè¿‡åå­—ï¼Œåœ¨ Binder é©±åŠ¨çš„å¸®åŠ©ä¸‹ä» ServiceManager ä¸­è·å–åˆ°å¯¹ Binder å®ä½“çš„å¼•ç”¨ï¼Œé€šè¿‡è¿™ä¸ªå¼•ç”¨å°±èƒ½å®ç°å’Œ Server è¿›ç¨‹çš„é€šä¿¡ã€‚<br><img src="https://s2.ax1x.com/2019/12/29/luy3sx.png" alt="å›¾ç‰‡"></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/24/Glideæºç åˆ†æ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Coding_dog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding_dogçš„æˆé•¿ç¬”è®°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/24/Glideæºç åˆ†æ/" itemprop="url">Glideæºç åˆ†æ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-10-24T00:00:00+08:00">
                2019-10-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/24/Glideæºç åˆ†æ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/10/24/Glideæºç åˆ†æ/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="GlideåŠ è½½æµç¨‹ï¼Ÿ"><a href="#GlideåŠ è½½æµç¨‹ï¼Ÿ" class="headerlink" title="GlideåŠ è½½æµç¨‹ï¼Ÿ"></a>GlideåŠ è½½æµç¨‹ï¼Ÿ</h2><p>å…ˆçœ‹ä¸€çœ¼Glideæœ€ç®€å•çš„ä½¿ç”¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(this).load(url).into(imageView);</span><br></pre></td></tr></table></figure></p>
<h3 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h3><p>å†çœ‹ä¸€çœ¼æ•´ä½“æ¶æ„å›¾<br><img src="https://s2.ax1x.com/2019/10/28/KcUoKH.png" alt="å›¾ç‰‡"><br>æˆ‘ä»¬ä¹Ÿä»è¿™ä¸‰ä¸ªæ–¹é¢æ¥åˆ†æ</p>
<h3 id="with-æ–¹æ³•"><a href="#with-æ–¹æ³•" class="headerlink" title="with()æ–¹æ³•"></a>with()æ–¹æ³•</h3><p>é¦–å…ˆwith()æ–¹æ³•çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>1 ä¼ é€’Activityï¼Œåˆ™æ­¤æ¬¡åŠ è½½å›¾ç‰‡ä¼šåœ¨é€€å‡ºActivityåè‡ªåŠ¨å–æ¶ˆï¼›</li>
<li>2 ä¼ é€’Fragmentï¼Œåˆ™åŠ è½½å›¾ç‰‡ä¼šåœ¨Fragmenté”€æ¯æ—¶å–æ¶ˆï¼›</li>
<li>3 ä¼ é€’Applicationï¼Œé‚£ä¹ˆGlideå°†æ— æ³•ç®¡ç†å›¾ç‰‡è¯·æ±‚ç”Ÿå‘½å‘¨æœŸã€‚<br>ç„¶åçœ‹with()æ–¹æ³•çš„æºç ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">       RequestManagerRetriever retriever = RequestManagerRetriever.get();</span><br><span class="line">       <span class="keyword">return</span> retriever.get(context);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">       RequestManagerRetriever retriever = RequestManagerRetriever.get();</span><br><span class="line">       <span class="keyword">return</span> retriever.get(activity);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">       RequestManagerRetriever retriever = RequestManagerRetriever.get();</span><br><span class="line">       <span class="keyword">return</span> retriever.get(activity);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(android.app.Fragment fragment)</span> </span>&#123;</span><br><span class="line">       RequestManagerRetriever retriever = RequestManagerRetriever.get();</span><br><span class="line">       <span class="keyword">return</span> retriever.get(fragment);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">       RequestManagerRetriever retriever = RequestManagerRetriever.get();</span><br><span class="line">       <span class="keyword">return</span> retriever.get(fragment);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ¯ä¸€ä¸ªwith()æ–¹æ³•é‡è½½çš„ä»£ç éƒ½éå¸¸ç®€å•ï¼Œéƒ½æ˜¯å…ˆè°ƒç”¨RequestManagerRetrieverçš„é™æ€get()æ–¹æ³•å¾—åˆ°ä¸€ä¸ªRequestManagerRetrieverå¯¹è±¡ï¼Œè¿™ä¸ªé™æ€get()æ–¹æ³•å°±æ˜¯ä¸€ä¸ªå•ä¾‹å®ç°ã€‚ç„¶åå†è°ƒç”¨RequestManagerRetrieverçš„å®ä¾‹get()æ–¹æ³•ï¼Œå»è·å–RequestManagerå¯¹è±¡ã€‚æ¢å¥è¯è¯´ï¼Œæ¯ä¸€ä¸ªActivityå­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„RequestManagerï¼Œæ¯ä¸€ä¸ªä¸åŒçš„Fragmentä¹Ÿæœ‰å…¶å¯¹åº”çš„RequestManagerï¼Œè€Œæ•´ä¸ªåº”ç”¨è¿è¡Œé˜¶æ®µåŒæ ·ä¼šæœ‰ä¸€ä¸ªRequestManagerã€‚è¿™äº›ä¸åŒçš„RequestManageré€šè¿‡RequestManagerRetriever.getè·å–ã€‚RequestManagerRetrieveråŒæ ·é‡è½½äº†å¤šä¸ªgetæ–¹æ³•ï¼Œä»¥get(FragmentActivity)ä¸ºä¾‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestManagerRetriever</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line">      <span class="keyword">return</span> get(activity.getApplicationContext());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      assertNotDestroyed(activity);</span><br><span class="line">      FragmentManager fm = activity.getSupportFragmentManager();</span><br><span class="line">      <span class="keyword">return</span> supportFragmentGet(activity, fm, <span class="comment">/*parentHint=*/</span> <span class="keyword">null</span>, isActivityVisible(activity));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œä»æ˜¯å¦åœ¨ä¸»çº¿ç¨‹çš„è§’åº¦æ¥çœ‹ï¼š</p>
<ul>
<li>1 è‹¥åœ¨ä¸»çº¿ç¨‹ï¼Œåˆ™è·å¾—Activityå¯¹åº”çš„FragmentManageræ¥è·å¾—RequestManagerï¼ˆFragmentåŒç†ï¼‰ã€‚</li>
<li>2 è‹¥åœ¨éä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸ç®¡ä½ æ˜¯ä¼ å…¥çš„Activityè¿˜æ˜¯Fragmentï¼Œéƒ½ä¼šè¢«å¼ºåˆ¶å½“æˆApplicationæ¥å¤„ç† ã€‚</li>
</ul>
<p>ä¹Ÿå¯ä»¥ä»ä¼ å…¥Applicationå’ŒéApplicationçš„è§’åº¦æ¥çœ‹ï¼š</p>
<ul>
<li>1 ä¼ Applicationï¼Œå› ä¸ºApplicationå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå³åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œå› æ­¤Glideå¹¶ä¸éœ€è¦åšä»€ä¹ˆç‰¹æ®Šçš„å¤„ç†ï¼Œå®ƒè‡ªåŠ¨å°±æ˜¯å’Œåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸæ˜¯åŒæ­¥çš„ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå…³é—­çš„è¯ï¼ŒGlideçš„åŠ è½½ä¹Ÿä¼šåŒæ—¶ç»ˆæ­¢ã€‚</li>
<li>2 ä¼ éApplicationï¼Œä¼ å…¥éApplicationå‚æ•°çš„æƒ…å†µã€‚ä¸ç®¡åœ¨Glide.with()æ–¹æ³•ä¸­ä¼ å…¥çš„æ˜¯Activityã€FragmentActivityã€v4åŒ…ä¸‹çš„Fragmentã€è¿˜æ˜¯appåŒ…ä¸‹çš„Fragmentï¼Œæœ€ç»ˆçš„æµç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œé‚£å°±æ˜¯ä¼šå‘å½“å‰çš„Activityå½“ä¸­æ·»åŠ ä¸€ä¸ªéšè—çš„Fragmentã€‚å› ä¸ºGlideéœ€è¦çŸ¥é“åŠ è½½çš„ç”Ÿå‘½å‘¨æœŸã€‚å¾ˆç®€å•çš„ä¸€ä¸ªé“ç†ï¼Œå¦‚æœä½ åœ¨æŸä¸ªActivityä¸Šæ­£åœ¨åŠ è½½ç€ä¸€å¼ å›¾ç‰‡ï¼Œç»“æœå›¾ç‰‡è¿˜æ²¡åŠ è½½å‡ºæ¥ï¼ŒActivityå°±è¢«ç”¨æˆ·å…³æ‰äº†ï¼Œé‚£ä¹ˆå›¾ç‰‡è¿˜åº”è¯¥ç»§ç»­åŠ è½½å—ï¼Ÿå½“ç„¶ä¸åº”è¯¥ã€‚å¯æ˜¯Glideå¹¶æ²¡æœ‰åŠæ³•çŸ¥é“Activityçš„ç”Ÿå‘½å‘¨æœŸï¼Œäºæ˜¯Glideå°±ä½¿ç”¨äº†æ·»åŠ éšè—Fragmentçš„è¿™ç§å°æŠ€å·§ï¼Œå› ä¸ºFragmentçš„ç”Ÿå‘½å‘¨æœŸå’ŒActivityæ˜¯åŒæ­¥çš„ï¼Œå¦‚æœActivityè¢«é”€æ¯äº†ï¼ŒFragmentæ˜¯å¯ä»¥ç›‘å¬åˆ°çš„ï¼Œè¿™æ ·Glideå°±å¯ä»¥æ•è·è¿™ä¸ªäº‹ä»¶å¹¶åœæ­¢å›¾ç‰‡åŠ è½½äº†ã€‚</li>
</ul>
<p>é‚£ä¹ˆ</p>
<h4 id="å¦‚ä½•ç»‘å®šç”Ÿå‘½å‘¨æœŸ"><a href="#å¦‚ä½•ç»‘å®šç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å¦‚ä½•ç»‘å®šç”Ÿå‘½å‘¨æœŸ"></a>å¦‚ä½•ç»‘å®šç”Ÿå‘½å‘¨æœŸ</h4><p>ç»§ç»­æ¥ç€ä¸Šé¢çš„ä»£ç çœ‹supportFragmentGet<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RequestManager <span class="title">supportFragmentGet</span><span class="params">(Context context, FragmentManager fm)</span> </span>&#123;</span><br><span class="line">       SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm);</span><br><span class="line">       RequestManager requestManager = current.getRequestManager();</span><br><span class="line">       <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">           requestManager = <span class="keyword">new</span> RequestManager(context, current.getLifecycle(), current.getRequestManagerTreeNode());</span><br><span class="line">           current.setRequestManager(requestManager);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> requestManager;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨fragment ä¸­åˆ›å»ºRequestManagerï¼Œå¹¶ä¸”ä¼ å…¥getLifecycle()ï¼Œé€šè¿‡Lifecycleå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®š</p>
<h3 id="load-æ–¹æ³•"><a href="#load-æ–¹æ³•" class="headerlink" title="load()æ–¹æ³•"></a>load()æ–¹æ³•</h3><p><code>Glide.with</code>è·å¾—RequestManagerä¹‹åï¼Œæ‰§è¡Œloadæ–¹æ³•è®¾ç½®å›¾ç‰‡æºã€‚å›¾ç‰‡æºå¯ä»¥æ˜¯ï¼šå›¾ç‰‡æ•°æ®å­—èŠ‚æ•°ç»„ã€Fileæ–‡ä»¶ï¼Œç½‘ç»œå›¾ç‰‡åœ°å€ç­‰ã€‚ä»¥<code>load(String)</code>ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadæ–¹æ³•é»˜è®¤è®¾ç½®ç›®æ ‡èµ„æºä¸º <strong>Drawable</strong>ï¼Œè·å¾—ä¸€ä¸ªRequestBuilderã€‚ç´§æ¥ç€è°ƒç”¨<code>RequestBuilder.load</code>æ–¹æ³•è®°å½•åŠ è½½çš„model(å›¾ç‰‡æº)ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadGeneric(string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.model = model;</span><br><span class="line">    isModelSet = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RequestBuilderæ˜¯è¯·æ±‚æ„å»ºè€…ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å®ƒè®¾ç½®å¦‚ï¼šå•ç‹¬çš„ç¼“å­˜ç­–ç•¥ã€åŠ è½½æˆåŠŸå‰å ä½å›¾ã€åŠ è½½å¤±è´¥åæ˜¾ç¤ºå›¾ç‰‡ç­‰ç­‰åŠ è½½å›¾ç‰‡çš„å„ç§é…ç½®ã€‚å½“RequestBuilder æ„å»ºå®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥å°±ç­‰å¾…æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ã€‚</p>
<h3 id="into-æ–¹æ³•"><a href="#into-æ–¹æ³•" class="headerlink" title="into()æ–¹æ³•"></a>into()æ–¹æ³•</h3><p><code>Glide.with</code>è·å¾—RequestManagerä¹‹åï¼Œæ‰§è¡Œloadæ–¹æ³•è®¾ç½®å›¾ç‰‡æºã€‚å›¾ç‰‡æºå¯ä»¥æ˜¯ï¼šå›¾ç‰‡æ•°æ®å­—èŠ‚æ•°ç»„ã€Fileæ–‡ä»¶ï¼Œç½‘ç»œå›¾ç‰‡åœ°å€ç­‰ã€‚ä»¥<code>load(String)</code>ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadæ–¹æ³•é»˜è®¤è®¾ç½®ç›®æ ‡èµ„æºä¸º <strong>Drawable</strong>ï¼Œè·å¾—ä¸€ä¸ªRequestBuilderã€‚ç´§æ¥ç€è°ƒç”¨<code>RequestBuilder.load</code>æ–¹æ³•è®°å½•åŠ è½½çš„model(å›¾ç‰‡æº)ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadGeneric(string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.model = model;</span><br><span class="line">    isModelSet = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RequestBuilderæ˜¯è¯·æ±‚æ„å»ºè€…ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å®ƒè®¾ç½®å¦‚ï¼šå•ç‹¬çš„ç¼“å­˜ç­–ç•¥ã€åŠ è½½æˆåŠŸå‰å ä½å›¾ã€åŠ è½½å¤±è´¥åæ˜¾ç¤ºå›¾ç‰‡ç­‰ç­‰åŠ è½½å›¾ç‰‡çš„å„ç§é…ç½®ã€‚å½“RequestBuilder æ„å»ºå®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥å°±ç­‰å¾…æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ã€‚</p>
<p>ä½¿ç”¨Glideæœ€ç®€å•çš„æ–¹å¼åŠ è½½å›¾ç‰‡æœ€åä¸€ä¸ªé˜¶æ®µå°±æ˜¯æ‰§è¡Œintoæ–¹æ³•ã€‚ä»intoæ–¹æ³•ä¸ºå…¥å£å¼€å§‹æ‰§è¡Œå›¾ç‰‡åŠ è½½ï¼Œé€»è¾‘ä¹Ÿå¼€å§‹å¤æ‚èµ·æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestBuilder</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(@NonNull ImageView view)</span> </span>&#123;</span><br><span class="line">    Util.assertMainThread();</span><br><span class="line">    Preconditions.checkNotNull(view);</span><br><span class="line"></span><br><span class="line">    BaseRequestOptions&lt;?&gt; requestOptions = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (!requestOptions.isTransformationSet()</span><br><span class="line">        &amp;&amp; requestOptions.isTransformationAllowed()</span><br><span class="line">        &amp;&amp; view.getScaleType() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Clone in this method so that if we use this RequestBuilder to load into a View and then</span></span><br><span class="line">      <span class="comment">// into a different target, we don't retain the transformation applied based on the previous</span></span><br><span class="line">      <span class="comment">// View's scale type.</span></span><br><span class="line">      <span class="keyword">switch</span> (view.getScaleType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> CENTER_CROP:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterCrop();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CENTER_INSIDE:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FIT_CENTER:</span><br><span class="line">        <span class="keyword">case</span> FIT_START:</span><br><span class="line">        <span class="keyword">case</span> FIT_END:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalFitCenter();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FIT_XY:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CENTER:</span><br><span class="line">        <span class="keyword">case</span> MATRIX:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="comment">// Do nothing.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> into(</span><br><span class="line">        glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">        <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">        requestOptions,</span><br><span class="line">        Executors.mainThreadExecutor());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œintoæ—¶ä¼ å…¥ä¸€ä¸ªImageViewç”¨äºæ˜¾ç¤ºã€‚åœ¨è¿™ä¸ªintoæ–¹æ³•ä¸­ï¼Œå…ˆç¡®å®šæœ¬æ¬¡åŠ è½½çš„BaseRequestOptionsï¼Œç„¶åæ‰§è¡Œé‡è½½çš„å¦ä¸€ä¸ªintoæ–¹æ³•ã€‚å…¶ä¸­BaseRequestOptionså°±æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„RequestBuilderå¯ä»¥è®¾ç½®å›¾ç‰‡åŠ è½½çš„å„ç§é…ç½®ï¼Œè¿™äº›é…ç½®é€‰é¡¹å°±è¢«å°è£…åœ¨BaseRequestOptionsä¸­(RequestBuilder extends BaseRequestOptions)ã€‚è€Œé‡è½½çš„intoæ–¹æ³•å®ç°ä¸º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GenericRequestBuilder</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(Y target)</span> </span>&#123;</span><br><span class="line">        Util.assertMainThread();</span><br><span class="line">        <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must pass in a non null Target"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isModelSet) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must first set a model (try #load())"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Request previous = target.getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">            previous.clear();</span><br><span class="line">            requestTracker.removeRequest(previous);</span><br><span class="line">            previous.recycle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Request request = buildRequest(target);</span><br><span class="line">        target.setRequest(request);</span><br><span class="line">        lifecycle.addListener(target);</span><br><span class="line">        requestTracker.runRequest(request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªintoæ–¹æ³•ä¸­é¦–å…ˆè°ƒç”¨ buildRequest æ„å»ºäº†ä¸€ä¸ªè¯·æ±‚Requestï¼Œç„¶åæŠŠRequestäº¤ç»™RequestManagerè·Ÿè¸ª(ç”Ÿå‘½å‘¨æœŸ)å¹¶å¯åŠ¨è¯·æ±‚ã€‚<br>è·Ÿè¿›requestTracker.runRequest()ï¼›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Starts tracking the given request.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">      requests.add(request);</span><br><span class="line">      <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">          request.begin();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          pendingRequests.add(request);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆåˆ¤æ–­Glideå½“å‰æ˜¯ä¸æ˜¯å¤„ç†æš‚åœçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯æš‚åœçŠ¶æ€å°±è°ƒç”¨Requestçš„begin()æ–¹æ³•æ¥æ‰§è¡ŒRequestï¼Œå¦åˆ™çš„è¯å°±å…ˆå°†Requestæ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—é‡Œé¢ï¼Œç­‰æš‚åœçŠ¶æ€è§£é™¤äº†ä¹‹åå†æ‰§è¡Œã€‚<br>è·Ÿè¿›request.begin();<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    startTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">        onException(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = Status.WAITING_FOR_SIZE;</span><br><span class="line">    <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">        onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        target.getSize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isComplete() &amp;&amp; !isFailed() &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">        target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        logV(<span class="string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è·Ÿè¿›onException(null);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"load failed"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = Status.FAILED;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> what if this is a thumbnail request?</span></span><br><span class="line">    <span class="keyword">if</span> (requestListener == <span class="keyword">null</span> || !requestListener.onException(e, model, target, isFirstReadyResource())) &#123;</span><br><span class="line">        setErrorPlaceholder(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å†è·ŸsetErrorPlaceholder(e);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">          Log.d(TAG, <span class="string">"load failed"</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      status = Status.FAILED;</span><br><span class="line">      <span class="comment">//<span class="doctag">TODO:</span> what if this is a thumbnail request?</span></span><br><span class="line">      <span class="keyword">if</span> (requestListener == <span class="keyword">null</span> || !requestListener.onException(e, model, target, isFirstReadyResource())) &#123;</span><br><span class="line">          setErrorPlaceholder(e);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setErrorPlaceholder</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!canNotifyStatusChanged()) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Drawable error = model == <span class="keyword">null</span> ? getFallbackDrawable() : <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (error == <span class="keyword">null</span>) &#123;</span><br><span class="line">        error = getErrorDrawable();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (error == <span class="keyword">null</span>) &#123;</span><br><span class="line">          error = getPlaceholderDrawable();</span><br><span class="line">      &#125;</span><br><span class="line">      target.onLoadFailed(e, error);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>å…¶å®å°±æ˜¯å°†è¿™å¼ errorå ä½å›¾æ˜¾ç¤ºåˆ°ImageViewä¸Šè€Œå·²ï¼Œå› ä¸ºç°åœ¨å‡ºç°äº†å¼‚å¸¸ï¼Œæ²¡åŠæ³•å±•ç¤ºæ­£å¸¸çš„å›¾ç‰‡äº†ã€‚è€Œå¦‚æœä½ ä»”ç»†çœ‹ä¸‹åˆšæ‰begin()æ–¹æ³•çš„ç¬¬15è¡Œï¼Œä½ ä¼šå‘ç°å®ƒåˆè°ƒç”¨äº†ä¸€ä¸ªtarget.onLoadStarted()æ–¹æ³•ï¼Œå¹¶ä¼ å…¥äº†ä¸€ä¸ªloadingå ä½å›¾ï¼Œåœ¨ä¹Ÿå°±è¯´ï¼Œåœ¨å›¾ç‰‡è¯·æ±‚å¼€å§‹ä¹‹å‰ï¼Œä¼šå…ˆä½¿ç”¨è¿™å¼ å ä½å›¾ä»£æ›¿æœ€ç»ˆçš„å›¾ç‰‡æ˜¾ç¤ºã€‚</p>
<p>å›åˆ°begin()ï¼Œä¸»è¦æ˜¯åˆ¤æ–­å½“å‰Requestçš„å„ç§çŠ¶æ€å¹¶ä¸”è®¾ç½®å ä½å›¾ï¼Œè€Œå¯åŠ¨åŠ è½½æ˜¯åœ¨ç¬¬å››æ­¥å¼€å§‹çš„ã€‚å½“ç”¨æˆ·è®¾ç½®äº†å›¾ç‰‡çš„å®½é«˜æ—¶æ‰§è¡Œ<code>onSizeReady</code>å¯åŠ¨åŠ è½½ï¼Œè€Œå¦‚æœæœªè®¾ç½®åˆ™ä¼šæ‰§è¡Œ<code>target.getSize(this)</code>è®¡ç®—ç›®æ ‡View(éœ€è¦æ˜¾ç¤ºçš„ImageView)çš„å¤§å°ï¼Œåœ¨è®¡ç®—å®Œä¹‹åï¼Œå®ƒä¹Ÿä¼šè°ƒç”¨onSizeReady()æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡æ˜¯å“ªç§æƒ…å†µï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°onSizeReady()æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (requestLock) &#123;</span><br><span class="line">      status = Status.RUNNING;</span><br><span class="line">      loadStatus =</span><br><span class="line">          engine.load(</span><br><span class="line">              glideContext,</span><br><span class="line">              model,</span><br><span class="line">              requestOptions.getSignature(),</span><br><span class="line">              <span class="keyword">this</span>.width,</span><br><span class="line">              <span class="keyword">this</span>.height,</span><br><span class="line">              requestOptions.getResourceClass(),</span><br><span class="line">              transcodeClass,</span><br><span class="line">              priority,</span><br><span class="line">              requestOptions.getDiskCacheStrategy(),</span><br><span class="line">              requestOptions.getTransformations(),</span><br><span class="line">              requestOptions.isTransformationRequired(),</span><br><span class="line">              requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">              requestOptions.getOptions(),</span><br><span class="line">              requestOptions.isMemoryCacheable(),</span><br><span class="line">              requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">              requestOptions.getUseAnimationPool(),</span><br><span class="line">              requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">              <span class="keyword">this</span>,</span><br><span class="line">              callbackExecutor);</span><br><span class="line">      <span class="comment">//.....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨onSizeReadyå°†è·å¾—ä¸€ç³»åˆ—çš„å€¼ä¸€èµ·ä¼ å…¥åˆ°äº†Engineçš„load()æ–¹æ³•å½“ä¸­å¼€å§‹åŠ è½½å›¾ç‰‡ã€‚</p>
<p><strong>Engine</strong>ç±»é¡¾åæ€ä¹‰:å¼•æ“ï¼Œæ˜¯GlideåŠ è½½çš„å‘åŠ¨æœºï¼Œè·Ÿè¿›Engineçš„load()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">    <span class="comment">//1ã€æ ¹æ®å‚æ•°ï¼ˆæ¨¡å‹ã€å®½ã€é«˜ç­‰ï¼‰æ„å»ºåŠ è½½çš„æ ‡è¯†key</span></span><br><span class="line">    EngineKey key =</span><br><span class="line">        keyFactory.buildKey(</span><br><span class="line">            model,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            transformations,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            options);</span><br><span class="line"></span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(active, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Loaded resource from active resources"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(cached, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Loaded resource from cache"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">      current.addCallback(cb, callbackExecutor);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Added to existing load"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//2ã€åˆ›å»ºæ–°çš„jobå¹¶æ‰§è¡ŒåŠ è½½</span></span><br><span class="line">    EngineJob&lt;R&gt; engineJob =</span><br><span class="line">        engineJobFactory.build(</span><br><span class="line">            key,</span><br><span class="line">            isMemoryCacheable,</span><br><span class="line">            useUnlimitedSourceExecutorPool,</span><br><span class="line">            useAnimationPool,</span><br><span class="line">            onlyRetrieveFromCache);</span><br><span class="line"> <span class="comment">// DecodeJobå°±æ˜¯ä¸€ä¸ªRunnable,EngineJobåŒ…å«çš„çº¿ç¨‹æ± å¯åŠ¨çº¿ç¨‹å¹¶èƒ½å¤Ÿæ¥æ”¶çº¿ç¨‹ä¸­æ‰§è¡Œè¿‡ç¨‹çš„å›è°ƒ</span></span><br><span class="line">    DecodeJob&lt;R&gt; decodeJob =</span><br><span class="line">        decodeJobFactory.build(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            key,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            diskCacheStrategy,</span><br><span class="line">            transformations,</span><br><span class="line">            isTransformationRequired,</span><br><span class="line">            isScaleOnlyOrNoTransform,</span><br><span class="line">            onlyRetrieveFromCache,</span><br><span class="line">            options,</span><br><span class="line">            engineJob);</span><br><span class="line"></span><br><span class="line">    jobs.put(key, engineJob);</span><br><span class="line"></span><br><span class="line">    engineJob.addCallback(cb, callbackExecutor);</span><br><span class="line">    <span class="comment">// å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">    engineJob.start(decodeJob);</span><br><span class="line">    <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">      logWithTimeAndKey(<span class="string">"Started new load"</span>, startTime, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¼•æ“ä¸­æ²¡æœ‰åŒæ ·çš„æ­£åœ¨åŠ è½½çš„è¯·æ±‚ï¼Œæ­¤å¤„ä¼šåˆ›å»ºä¸€ä¸ªå®ç°äº†Runableæ¥å£çš„DecodeJobå¹¶æ‰§è¡Œã€‚<br>è·Ÿè¿›engineJob.start(decodeJob);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EngineJob </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(DecodeJob&lt;R&gt; decodeJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decodeJob = decodeJob;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± </span></span><br><span class="line">    GlideExecutor executor =</span><br><span class="line">        decodeJob.willDecodeFromCache() ? diskCacheExecutor : getActiveSourceExecutor();</span><br><span class="line">    executor.execute(decodeJob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡DecodeJobã€‚</p>
<blockquote>
<p>å¦‚æœéœ€è¦è·å–ä¸€å¼ å›¾ç‰‡ï¼Œé‚£ä¹ˆå…ˆä»å†…å­˜ç¼“å­˜ä¸­è·å¾—ï¼Œå†…å­˜ç¼“å­˜ä¸éœ€è¦è¿›è¡Œé¢å¤–çš„æ“ä½œï¼Œåªè¦åŒ¹é…å°±èƒ½ç›´æ¥è·å–ã€‚ä½†æ˜¯å†…å­˜ç¼“å­˜ä¸å­˜åœ¨ï¼Œè¿™æ—¶å€™å°±éœ€è¦å…ˆæ£€æŸ¥ç£ç›˜ç¼“å­˜æœ€åå†å†³å®šæ˜¯å¦éœ€è¦å‘å›¾ç‰‡æº(å¦‚ç½‘ç»œ)è¿›è¡ŒåŠ è½½ã€‚è€Œæ— è®ºæ˜¯è¿›è¡Œå›¾ç‰‡ç£ç›˜ç¼“å­˜çš„è·å–è¿˜æ˜¯å‘ç½‘ç»œè¯·æ±‚éƒ½æ˜¯è€—æ—¶æ“ä½œï¼Œè¿™æ—¶å€™å°±éœ€è¦å¼€å¯çº¿ç¨‹æ¥æ‰§è¡ŒåŠ è½½ã€‚å› æ­¤å†…å­˜ç¼“å­˜ä¸€æ—¦ä¸å­˜åœ¨ï¼Œå°±ä¼šä½¿ç”¨çº¿ç¨‹æ± å¼€å¯DecodeJobå¼‚æ­¥ä»»åŠ¡ã€‚è€ŒDecodeJobä¸­å°±ä¼šå»ç£ç›˜ç¼“å­˜æŸ¥æ‰¾æˆ–è€…ç½‘ç»œä¸­ä¸‹è½½å›¾ç‰‡ã€‚</p>
</blockquote>
<p>DecodeJobæ˜¯å®ç°äº†Runableæ¥å£çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå½“ä½¿ç”¨çº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œè‡ªç„¶å°±ä¼šæ‰§è¡Œrunæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DecodeJob</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">      runWrapped();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>runæ–¹æ³•ä¸­é™¤äº†å–æ¶ˆä¸åŠ è½½å¤±è´¥çš„åˆ¤æ–­ï¼Œæ ¸å¿ƒçš„åŠ è½½é€»è¾‘éƒ½æ”¾åœ¨äº†runWrappedä¸­ã€‚åœ¨ä»‹ç»è¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œå…ˆç®€å•çš„äº†è§£ä¸‹Glideä¸­ç£ç›˜ç¼“å­˜ã€‚ Glideå¯ä»¥ç¼“å­˜ä¸¤ç§ä¸åŒçš„æ•°æ®åœ¨ç£ç›˜æ–‡ä»¶ä¸­ï¼š</p>
<ul>
<li>1 èµ„æºç±»å‹ï¼ˆResourceï¼‰ - æ›¾è¢«è§£ç ã€è½¬æ¢å¹¶å†™å…¥çš„ç£ç›˜ç¼“å­˜ã€‚å¦‚å¯¹åŸå›¾ç‰‡è¿›è¡Œäº†ç¼©æ”¾ï¼Œå­˜æ”¾ç¼©æ”¾åçš„å›¾ç‰‡ã€‚</li>
<li>2 æ•°æ®æ¥æº (Data) - åŸå›¾ç‰‡ç¼“å­˜</li>
</ul>
<p>è€ŒrunWrappedæ–¹æ³•çš„å®ç°ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DecodeJob</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">      <span class="keyword">case</span> INITIALIZE: </span><br><span class="line">        <span class="comment">// 1. è·å–ä»»åŠ¡çš„åœºæ™¯</span></span><br><span class="line">        stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">        <span class="comment">// 2. è·å–è¿™ä¸ªåœºæ™¯çš„æ‰§è¡Œè€…</span></span><br><span class="line">        currentGenerator = getNextGenerator();</span><br><span class="line">        <span class="comment">// 3. æ‰§è¡Œè€…æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">        runGenerators();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">        <span class="comment">// å½“å›¾ç‰‡æ•°æ®æ— æ³•ä»ç¼“å­˜åŠ è½½æ—¶ï¼Œä¼šåˆ‡æ¢æ‰§è¡ŒåŸå› å¹¶è®°å½•ï¼Œç„¶åé‡æ–°æäº¤æœ¬ä»»åŠ¡ç»™çº¿ç¨‹æ± </span></span><br><span class="line">        <span class="comment">// ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œå›¾ç‰‡æºåŠ è½½ï¼Œå¦‚ï¼šç½‘ç»œåŠ è½½ä»»åŠ¡ï¼‰</span></span><br><span class="line">        runGenerators();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">        <span class="comment">// åˆ‡æ¢ä¸ºè§£ç å›¾ç‰‡,è·å¾—çš„å›¾ç‰‡æ•°æ®ï¼Œæ¯”å¦‚ç½‘ç»œä¸‹è½½äº† a.png å¾—åˆ°å…¶byteæ•°ç»„ï¼Œ</span></span><br><span class="line">        <span class="comment">// byteæ•°ç»„ä¸­è®°å½•çš„æ˜¯pngç¼–ç åçš„æ•°æ®ï¼ŒBitmapFactory.decodeXX ä¼šè§£ç ç”ŸæˆBitmapå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// åŒæ—¶è§£ç è¿‡ç¨‹ä¸­å¯èƒ½è¿˜éœ€è¦è¿›è¡Œç¼©æ”¾ã€å˜æ¢ç­‰æ“ä½œ    </span></span><br><span class="line">        decodeFromRetrievedData();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized run reason: "</span> + runReason);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">       <span class="comment">// 1 å¦‚æœé…ç½®çš„ç¼“å­˜ç­–ç•¥å…è®¸ä» èµ„æºç¼“å­˜ ä¸­è¯»æ•°æ®, åˆ™è¿”å› Stage.RESOURCE_CACHE</span></span><br><span class="line">      <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">        <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">            ? Stage.RESOURCE_CACHE</span><br><span class="line">            : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="comment">// 2 å¦‚æœé…ç½®çš„ç¼“å­˜ç­–ç•¥å…è®¸ä» æºæ•°æ®ç¼“å­˜ ä¸­è¯»æ•°æ®, åˆ™è¿”å› Stage.DATA_CACHE</span></span><br><span class="line">        <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">            ? Stage.DATA_CACHE</span><br><span class="line">            : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">        <span class="comment">// 3 å¦‚æœåªå…è®¸ä»ç¼“å­˜ä¸­è·å–æ•°æ®, åˆ™ç›´æ¥ FINISH, å¦åˆ™è¿”å› Stage.SOURCE,è¡¨ç¤ºåŠ è½½ä¸€ä¸ªæ–°çš„èµ„æº</span></span><br><span class="line">        <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">      <span class="keyword">case</span> SOURCE:</span><br><span class="line">      <span class="keyword">case</span> FINISHED:</span><br><span class="line">        <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unrecognized stage: "</span> + current);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">      <span class="comment">// èµ„æºç£ç›˜ç¼“å­˜çš„æ‰§è¡Œè€…</span></span><br><span class="line">      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">     <span class="comment">// æºæ•°æ®ç£ç›˜ç¼“å­˜çš„æ‰§è¡Œè€…</span></span><br><span class="line">      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> SOURCE:</span><br><span class="line">     <span class="comment">// æ— ç¼“å­˜, è·å–æ•°æ®çš„æºçš„æ‰§è¡Œè€…</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> FINISHED:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized stage: "</span> + stage);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨ DataFetcherGenerator.startNext() æ‰§è¡Œè¯·æ±‚æ“ä½œ</span></span><br><span class="line">    <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!isCancelled</span><br><span class="line">        &amp;&amp; currentGenerator != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;</span><br><span class="line">      <span class="comment">//å¦‚æœæ‰§è¡Œè€…æœªæ‰§è¡Œï¼Œè·å–ä¸‹ä¸€ä¸ªåœºæ™¯çš„æ‰§è¡Œè€…</span></span><br><span class="line">      stage = getNextStage(stage);</span><br><span class="line">      currentGenerator = getNextGenerator();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (stage == Stage.SOURCE) &#123;</span><br><span class="line">        reschedule();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We've run out of stages and generators, give up.</span></span><br><span class="line">    <span class="keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">      notifyFailed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DecodeJob ä»»åŠ¡æ‰§è¡Œæ—¶, å®ƒæ ¹æ®ä¸åŒçš„åœºæ™¯, è·å–ä¸åŒçš„åœºæ™¯æ‰§è¡Œå™¨, ç„¶åè°ƒç”¨äº†å®ƒä»¬çš„ startNext æ–¹æ³•åŠ è½½è¯·æ±‚ä»»åŠ¡çš„æ•°æ®ã€‚</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>åœºæ™¯æè¿°</th>
<th>åœºæ™¯æ‰§è¡Œè€…</th>
</tr>
</thead>
<tbody>
<tr>
<td>Stage.RESOURCE_CACHE</td>
<td>ä»ç£ç›˜ä¸­è·å–è½¬æ¢åçš„å›¾ç‰‡ç¼“å­˜</td>
<td>ResourceCacheGenerator</td>
</tr>
<tr>
<td>Stage.DATA_CACHE</td>
<td>ä»ç£ç›˜ä¸­è·å–åŸå›¾ç‰‡ç¼“å­˜æ•°æ®</td>
<td>DataCacheGenerator</td>
</tr>
<tr>
<td>Stage.SOURCE</td>
<td>å›¾ç‰‡æºè¯·æ±‚æ•°æ®</td>
<td>SourceGenerator</td>
</tr>
</tbody>
</table>
<p>æ€»çš„æ¥è¯´ï¼ŒGlideåœ¨åŠ è½½å›¾ç‰‡çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆä»å†…å­˜ç¼“å­˜è·å–ï¼Œå¦‚æœå†…å­˜ç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåœ¨ç£ç›˜ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦åˆ™ä»æºåœ°å€è¿›è¡ŒåŠ è½½ã€‚</p>
<h2 id="Glideç¼“å­˜"><a href="#Glideç¼“å­˜" class="headerlink" title="Glideç¼“å­˜"></a>Glideç¼“å­˜</h2><p>ç®€å•æ¥è¯´åˆ†ä¸º æ´»åŠ¨ç¼“å­˜ï¼ˆå¼±å¼•ç”¨activeResourcesï¼‰ï¼Œå†…å­˜ç¼“å­˜ï¼ˆLruResourceCacheï¼‰ï¼Œèµ„æºç¼“å­˜ï¼Œæ•°æ®ç¼“å­˜</p>
<h3 id="æ´»åŠ¨ç¼“å­˜å’Œå†…å­˜ç¼“å­˜"><a href="#æ´»åŠ¨ç¼“å­˜å’Œå†…å­˜ç¼“å­˜" class="headerlink" title="æ´»åŠ¨ç¼“å­˜å’Œå†…å­˜ç¼“å­˜"></a>æ´»åŠ¨ç¼“å­˜å’Œå†…å­˜ç¼“å­˜</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGlideè‡ªåŠ¨å°±æ˜¯å¼€å¯å†…å­˜ç¼“å­˜çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨GlideåŠ è½½äº†ä¸€å¼ å›¾ç‰‡ä¹‹åï¼Œè¿™å¼ å›¾ç‰‡å°±ä¼šè¢«ç¼“å­˜åˆ°å†…å­˜å½“ä¸­ï¼Œåªè¦åœ¨å®ƒè¿˜æ²¡ä»å†…å­˜ä¸­è¢«æ¸…é™¤ä¹‹å‰ï¼Œä¸‹æ¬¡ä½¿ç”¨Glideå†åŠ è½½è¿™å¼ å›¾ç‰‡éƒ½ä¼šç›´æ¥ä»å†…å­˜å½“ä¸­è¯»å–ï¼Œè€Œä¸ç”¨é‡æ–°ä»ç½‘ç»œæˆ–ç¡¬ç›˜ä¸Šè¯»å–äº†ï¼Œè¿™æ ·æ— ç–‘å°±å¯ä»¥å¤§å¹…åº¦æå‡å›¾ç‰‡çš„åŠ è½½æ•ˆç‡ã€‚æ¯”æ–¹è¯´ä½ åœ¨ä¸€ä¸ªRecyclerViewå½“ä¸­åå¤ä¸Šä¸‹æ»‘åŠ¨ï¼ŒRecyclerViewä¸­åªè¦æ˜¯GlideåŠ è½½è¿‡çš„å›¾ç‰‡éƒ½å¯ä»¥ç›´æ¥ä»å†…å­˜å½“ä¸­è¿…é€Ÿè¯»å–å¹¶å±•ç¤ºå‡ºæ¥ï¼Œä»è€Œå¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒã€‚ä¸è¿‡å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼ç¦æ‰é»˜è®¤ç¼“å­˜ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(this)</span><br><span class="line">     .load(url)</span><br><span class="line">     .skipMemoryCache(true)</span><br><span class="line">     .into(imageView);</span><br><span class="line">//skipMemoryCacheä¼ trueå°±å¯ä»¥å•¦</span><br></pre></td></tr></table></figure></p>
<p>é‚£ä¹ˆçœ‹ä¸€çœ‹åŸç†ï¼š<br>load()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å½“æ—¶åˆ†æåˆ°äº†åœ¨loadGeneric()æ–¹æ³•ä¸­ä¼šè°ƒç”¨Glide.buildStreamModelLoader()æ–¹æ³•æ¥è·å–ä¸€ä¸ªModelLoaderå¯¹è±¡<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T, Y&gt; <span class="function">ModelLoader&lt;T, Y&gt; <span class="title">buildModelLoader</span><span class="params">(Class&lt;T&gt; modelClass, Class&lt;Y&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">           Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (modelClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">               Log.d(TAG, <span class="string">"Unable to load null model, setting placeholder only"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Glide.get(context).getLoaderFactory().buildModelLoader(modelClass, resourceClass);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (Glide.class) &#123;</span><br><span class="line">               <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   Context applicationContext = context.getApplicationContext();</span><br><span class="line">                   List&lt;GlideModule&gt; modules = <span class="keyword">new</span> ManifestParser(applicationContext).parse();</span><br><span class="line">                   GlideBuilder builder = <span class="keyword">new</span> GlideBuilder(applicationContext);</span><br><span class="line">                   <span class="keyword">for</span> (GlideModule <span class="keyword">module</span> : modules) &#123;</span><br><span class="line">                       <span class="keyword">module</span>.applyOptions(applicationContext, builder);</span><br><span class="line">                   &#125;</span><br><span class="line">                   glide = builder.createGlide();</span><br><span class="line">                   <span class="keyword">for</span> (GlideModule <span class="keyword">module</span> : modules) &#123;</span><br><span class="line">                       <span class="keyword">module</span>.registerComponents(applicationContext, glide);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> glide;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>è·ŸcreateGlideï¼ˆï¼‰æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Glide <span class="title">createGlide</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (sourceService == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> cores = Math.max(<span class="number">1</span>, Runtime.getRuntime().availableProcessors());</span><br><span class="line">           sourceService = <span class="keyword">new</span> FifoPriorityThreadPoolExecutor(cores);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (diskCacheService == <span class="keyword">null</span>) &#123;</span><br><span class="line">           diskCacheService = <span class="keyword">new</span> FifoPriorityThreadPoolExecutor(<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       MemorySizeCalculator calculator = <span class="keyword">new</span> MemorySizeCalculator(context);</span><br><span class="line">       <span class="keyword">if</span> (bitmapPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">               <span class="keyword">int</span> size = calculator.getBitmapPoolSize();</span><br><span class="line">               bitmapPool = <span class="keyword">new</span> LruBitmapPool(size);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               bitmapPool = <span class="keyword">new</span> BitmapPoolAdapter();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (memoryCache == <span class="keyword">null</span>) &#123;</span><br><span class="line">           memoryCache = <span class="keyword">new</span> LruResourceCache(calculator.getMemoryCacheSize());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (diskCacheFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">           diskCacheFactory = <span class="keyword">new</span> InternalCacheDiskCacheFactory(context);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (engine == <span class="keyword">null</span>) &#123;</span><br><span class="line">           engine = <span class="keyword">new</span> Engine(memoryCache, diskCacheFactory, diskCacheService, sourceService);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (decodeFormat == <span class="keyword">null</span>) &#123;</span><br><span class="line">           decodeFormat = DecodeFormat.DEFAULT;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Glide(engine, memoryCache, bitmapPool, context, decodeFormat);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>è€Œ memoryCache = new LruResourceCache(calculator.getMemoryCacheSize()); å°±æ˜¯Glideå®ç°å†…å­˜ç¼“å­˜æ‰€ä½¿ç”¨çš„LruCacheå¯¹è±¡äº†ï¼Œæœ‰å¯¹è±¡è¿˜ä¸å¤Ÿï¼Œå…³é”®åœ¨äºEngineç±»load()æ–¹æ³•ï¼Œåœ¨load()æ–¹æ³•ä¸­Glideçš„å›¾ç‰‡åŠ è½½è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ä¸¤ä¸ªæ–¹æ³•æ¥è·å–å†…å­˜ç¼“å­˜ï¼ŒloadFromCache()å’ŒloadFromActiveResources()ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­ä¸€ä¸ªä½¿ç”¨çš„å°±æ˜¯LruCacheç®—æ³•ï¼Œå¦ä¸€ä¸ªä½¿ç”¨çš„å°±æ˜¯å¼±å¼•ç”¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒä»¬çš„æºç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Engine</span> <span class="keyword">implements</span> <span class="title">EngineJobListener</span>,</span></span><br><span class="line"><span class="class">        <span class="title">MemoryCache</span>.<span class="title">ResourceRemovedListener</span>,</span></span><br><span class="line"><span class="class">        <span class="title">EngineResource</span>.<span class="title">ResourceListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MemoryCache cache;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Key, WeakReference&lt;EngineResource&lt;?&gt;&gt;&gt; activeResources;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromCache(Key key, <span class="keyword">boolean</span> isMemoryCacheable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        EngineResource&lt;?&gt; cached = getEngineResourceFromCache(key);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cached.acquire();</span><br><span class="line">            activeResources.put(key, <span class="keyword">new</span> ResourceWeakReference(key, cached, getReferenceQueue()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cached;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EngineResource&lt;?&gt; getEngineResourceFromCache(Key key) &#123;</span><br><span class="line">        Resource&lt;?&gt; cached = cache.remove(key);</span><br><span class="line">        <span class="keyword">final</span> EngineResource result;</span><br><span class="line">        <span class="keyword">if</span> (cached == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cached <span class="keyword">instanceof</span> EngineResource) &#123;</span><br><span class="line">            result = (EngineResource) cached;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = <span class="keyword">new</span> EngineResource(cached, <span class="keyword">true</span> <span class="comment">/*isCacheable*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromActiveResources(Key key, <span class="keyword">boolean</span> isMemoryCacheable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        EngineResource&lt;?&gt; active = <span class="keyword">null</span>;</span><br><span class="line">        WeakReference&lt;EngineResource&lt;?&gt;&gt; activeRef = activeResources.get(key);</span><br><span class="line">        <span class="keyword">if</span> (activeRef != <span class="keyword">null</span>) &#123;</span><br><span class="line">            active = activeRef.get();</span><br><span class="line">            <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">                active.acquire();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                activeResources.remove(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> active;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨loadFromCache()æ–¹æ³•çš„ä¸€å¼€å§‹ï¼Œé¦–å…ˆå°±åˆ¤æ–­äº†isMemoryCacheableæ˜¯ä¸æ˜¯falseï¼Œå¦‚æœæ˜¯falseçš„è¯å°±ç›´æ¥è¿”å›nullï¼Œæ„æ€æ˜¯åˆšåˆšçš„skipMemoryCache()æ–¹æ³•ï¼Œå¦‚æœåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼ å…¥trueï¼Œé‚£ä¹ˆè¿™é‡Œçš„isMemoryCacheableå°±ä¼šæ˜¯falseï¼Œè¡¨ç¤ºå†…å­˜ç¼“å­˜å·²è¢«ç¦ç”¨ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­ä½ä¸‹çœ‹ï¼Œæ¥ç€è°ƒç”¨äº†getEngineResourceFromCache()æ–¹æ³•æ¥è·å–ç¼“å­˜ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šä½¿ç”¨ç¼“å­˜Keyæ¥ä»cacheå½“ä¸­å–å€¼ï¼Œè€Œè¿™é‡Œçš„cacheå¯¹è±¡å°±æ˜¯åœ¨æ„å»ºGlideå¯¹è±¡æ—¶åˆ›å»ºçš„LruResourceCacheï¼Œé‚£ä¹ˆè¯´æ˜è¿™é‡Œå…¶å®ä½¿ç”¨çš„å°±æ˜¯LruCacheç®—æ³•äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬ä»LruResourceCacheä¸­è·å–åˆ°ç¼“å­˜å›¾ç‰‡ä¹‹åä¼šå°†å®ƒä»ç¼“å­˜ä¸­ç§»é™¤ï¼Œç„¶åå°†è¿™ä¸ªç¼“å­˜å›¾ç‰‡å­˜å‚¨åˆ°activeResourceså½“ä¸­ã€‚activeResourceså°±æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨çš„HashMapï¼Œç”¨æ¥ç¼“å­˜æ­£åœ¨ä½¿ç”¨ä¸­çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒloadFromActiveResources()æ–¹æ³•å°±æ˜¯ä»activeResourcesè¿™ä¸ªHashMapå½“ä¸­å–å€¼çš„ã€‚ä½¿ç”¨activeResourcesæ¥ç¼“å­˜æ­£åœ¨ä½¿ç”¨ä¸­çš„å›¾ç‰‡ï¼Œå¯ä»¥ä¿æŠ¤è¿™äº›å›¾ç‰‡ä¸ä¼šè¢«LruCacheç®—æ³•å›æ”¶æ‰ã€‚</p>
<p>æ¦‚æ‹¬ä¸€ä¸‹æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœèƒ½ä»å†…å­˜ç¼“å­˜å½“ä¸­è¯»å–åˆ°è¦åŠ è½½çš„å›¾ç‰‡ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿›è¡Œå›è°ƒï¼Œå¦‚æœè¯»å–ä¸åˆ°çš„è¯ï¼Œæ‰ä¼šå¼€å¯çº¿ç¨‹æ‰§è¡Œåé¢çš„å›¾ç‰‡åŠ è½½é€»è¾‘ã€‚</p>
<h3 id="èµ„æºç¼“å­˜ï¼Œæ•°æ®ç¼“å­˜"><a href="#èµ„æºç¼“å­˜ï¼Œæ•°æ®ç¼“å­˜" class="headerlink" title="èµ„æºç¼“å­˜ï¼Œæ•°æ®ç¼“å­˜"></a>èµ„æºç¼“å­˜ï¼Œæ•°æ®ç¼“å­˜</h3><p>ç”¨æ³•ä¸Šï¼Œå®ƒä¹Ÿæ˜¯å¯ç¦çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(this)</span><br><span class="line">     .load(url)</span><br><span class="line">     .diskCacheStrategy(DiskCacheStrategy.NONE)</span><br><span class="line">     .into(imageView);</span><br></pre></td></tr></table></figure></p>
<p>è°ƒç”¨diskCacheStrategy()æ–¹æ³•å¹¶ä¼ å…¥DiskCacheStrategy.NONEï¼Œå°±å¯ä»¥ç¦ç”¨æ‰Glideçš„ç¡¬ç›˜ç¼“å­˜åŠŸèƒ½äº†ã€‚</p>
<p>è¿™ä¸ªdiskCacheStrategy()æ–¹æ³•åŸºæœ¬ä¸Šå°±æ˜¯Glideç¡¬ç›˜ç¼“å­˜åŠŸèƒ½çš„ä¸€åˆ‡ï¼Œå®ƒå¯ä»¥æ¥æ”¶å››ç§å‚æ•°ï¼š</p>
<p>DiskCacheStrategy.NONEï¼š è¡¨ç¤ºä¸ç¼“å­˜ä»»ä½•å†…å®¹ã€‚<br>DiskCacheStrategy.SOURCEï¼š è¡¨ç¤ºåªç¼“å­˜åŸå§‹å›¾ç‰‡ã€‚<br>DiskCacheStrategy.RESULTï¼š è¡¨ç¤ºåªç¼“å­˜è½¬æ¢è¿‡åçš„å›¾ç‰‡ï¼ˆé»˜è®¤é€‰é¡¹ï¼‰ã€‚<br>DiskCacheStrategy.ALL ï¼š è¡¨ç¤ºæ—¢ç¼“å­˜åŸå§‹å›¾ç‰‡ï¼Œä¹Ÿç¼“å­˜è½¬æ¢è¿‡åçš„å›¾ç‰‡ã€‚<br>ä¸Šé¢å››ç§å‚æ•°çš„è§£é‡Šæœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆéš¾ç†è§£çš„åœ°æ–¹ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨Glideå»åŠ è½½ä¸€å¼ å›¾ç‰‡çš„æ—¶å€™ï¼ŒGlideé»˜è®¤å¹¶ä¸ä¼šå°†åŸå§‹å›¾ç‰‡å±•ç¤ºå‡ºæ¥ï¼Œè€Œæ˜¯ä¼šå¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©å’Œè½¬æ¢ï¼ˆæˆ‘ä»¬ä¼šåœ¨åé¢å­¦ä¹ è¿™æ–¹é¢çš„å†…å®¹ï¼‰ã€‚æ€»ä¹‹å°±æ˜¯ç»è¿‡ç§ç§ä¸€ç³»åˆ—æ“ä½œä¹‹åå¾—åˆ°çš„å›¾ç‰‡ï¼Œå°±å«è½¬æ¢è¿‡åçš„å›¾ç‰‡ã€‚è€ŒGlideé»˜è®¤æƒ…å†µä¸‹åœ¨ç¡¬ç›˜ç¼“å­˜çš„å°±æ˜¯è½¬æ¢è¿‡åçš„å›¾ç‰‡ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨diskCacheStrategy()æ–¹æ³•åˆ™å¯ä»¥æ”¹å˜è¿™ä¸€é»˜è®¤è¡Œä¸ºã€‚</p>
<p>æ¥ä¸‹æ¥è¿˜æ˜¯é€šè¿‡é˜…è¯»æºç æ¥åˆ†æä¸€ä¸‹ï¼ŒGlideçš„ç¡¬ç›˜ç¼“å­˜åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ã€‚<br>é¦–å…ˆï¼Œå’Œå†…å­˜ç¼“å­˜ç±»ä¼¼ï¼Œç¡¬ç›˜ç¼“å­˜çš„å®ç°ä¹Ÿæ˜¯ä½¿ç”¨çš„LruCacheç®—æ³•ï¼Œè€Œä¸”Googleè¿˜æä¾›äº†ä¸€ä¸ªç°æˆçš„å·¥å…·ç±»DiskLruCache<br>ï¼ŒGlideå¼€å¯çº¿ç¨‹æ¥åŠ è½½å›¾ç‰‡åä¼šæ‰§è¡ŒEngineRunnableçš„run()æ–¹æ³•ï¼Œrun()æ–¹æ³•ä¸­åˆä¼šè°ƒç”¨ä¸€ä¸ªdecode()æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡æ–°å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªdecode()æ–¹æ³•çš„æºç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Resource&lt;?&gt; decode() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDecodingFromCache()) &#123;</span><br><span class="line">        <span class="keyword">return</span> decodeFromCache();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> decodeFromSource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¼šåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯è°ƒç”¨decodeFromCache()æ–¹æ³•ä»ç¡¬ç›˜ç¼“å­˜å½“ä¸­è¯»å–å›¾ç‰‡ï¼Œä¸€ç§æ˜¯è°ƒç”¨decodeFromSource()æ¥è¯»å–åŸå§‹å›¾ç‰‡ã€‚é»˜è®¤æƒ…å†µä¸‹Glideä¼šä¼˜å…ˆä»ç¼“å­˜å½“ä¸­è¯»å–ï¼Œåªæœ‰ç¼“å­˜ä¸­ä¸å­˜åœ¨è¦è¯»å–çš„å›¾ç‰‡æ—¶ï¼Œæ‰ä¼šå»è¯»å–åŸå§‹å›¾ç‰‡ã€‚é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹decodeFromCache()æ–¹æ³•çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Resource&lt;?&gt; decodeFromCache() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Resource&lt;?&gt; result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = decodeJob.decodeResultFromCache();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"Exception decoding result from cache: "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = decodeJob.decodeSourceFromCache();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¼šå…ˆå»è°ƒç”¨DecodeJobçš„decodeResultFromCache()æ–¹æ³•æ¥è·å–ç¼“å­˜ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œä¼šå†è°ƒç”¨decodeSourceFromCache()æ–¹æ³•è·å–ç¼“å­˜ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«å…¶å®å°±æ˜¯DiskCacheStrategy.RESULT(å‹ç¼©åçš„)å’ŒDiskCacheStrategy.SOURCE(åŸå§‹çš„)<br>çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„æºç <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Z&gt; <span class="title">decodeResultFromCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!diskCacheStrategy.cacheResult()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line">    Resource&lt;T&gt; transformed = loadFromCache(resultKey);</span><br><span class="line">    startTime = LogTime.getLogTime();</span><br><span class="line">    Resource&lt;Z&gt; result = transcode(transformed);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Z&gt; <span class="title">decodeSourceFromCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!diskCacheStrategy.cacheSource()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line"></span><br><span class="line">    Resource&lt;T&gt; decoded = loadFromCache(resultKey.getOriginalKey());</span><br><span class="line">    <span class="keyword">return</span> transformEncodeAndTranscode(decoded);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä»¬éƒ½æ˜¯è°ƒç”¨äº†loadFromCache()æ–¹æ³•ä»ç¼“å­˜å½“ä¸­è¯»å–æ•°æ®ï¼Œå¦‚æœæ˜¯decodeResultFromCache()æ–¹æ³•å°±ç›´æ¥å°†æ•°æ®è§£ç å¹¶è¿”å›ï¼Œå¦‚æœæ˜¯decodeSourceFromCache()æ–¹æ³•ï¼Œè¿˜è¦è°ƒç”¨ä¸€ä¸‹transformEncodeAndTranscode()æ–¹æ³•å…ˆå°†æ•°æ®è½¬æ¢ä¸€ä¸‹å†è§£ç å¹¶è¿”å›ã€‚<br>çœ‹ä¸€ä¸‹loadFromCache()æ–¹æ³•çš„æºç <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Resource&lt;T&gt; <span class="title">loadFromCache</span><span class="params">(Key key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    File cacheFile = diskCacheProvider.getDiskCache().get(key);</span><br><span class="line">    <span class="keyword">if</span> (cacheFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Resource&lt;T&gt; result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = loadProvider.getCacheDecoder().decode(cacheFile, width, height);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            diskCacheProvider.getDiskCache().delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘éå¸¸ç®€å•ï¼Œè°ƒç”¨getDiskCache()æ–¹æ³•è·å–åˆ°çš„å°±æ˜¯Glideè‡ªå·±ç¼–å†™çš„DiskLruCacheå·¥å…·ç±»çš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨å®ƒçš„get()æ–¹æ³•å¹¶æŠŠç¼“å­˜Keyä¼ å…¥ï¼Œå°±èƒ½å¾—åˆ°ç¡¬ç›˜ç¼“å­˜çš„æ–‡ä»¶äº†ã€‚å¦‚æœæ–‡ä»¶ä¸ºç©ºå°±è¿”å›nullï¼Œå¦‚æœæ–‡ä»¶ä¸ä¸ºç©ºåˆ™å°†å®ƒè§£ç æˆResourceå¯¹è±¡åè¿”å›å³å¯ã€‚</p>
<h2 id="çœ‹æºç ä¹‹å‰ä¸æ¸…æ¥šçš„ä¸¤ä¸ªé—®é¢˜ï¼š"><a href="#çœ‹æºç ä¹‹å‰ä¸æ¸…æ¥šçš„ä¸¤ä¸ªé—®é¢˜ï¼š" class="headerlink" title="çœ‹æºç ä¹‹å‰ä¸æ¸…æ¥šçš„ä¸¤ä¸ªé—®é¢˜ï¼š"></a>çœ‹æºç ä¹‹å‰ä¸æ¸…æ¥šçš„ä¸¤ä¸ªé—®é¢˜ï¼š</h2><ul>
<li><p>1 Glideçš„æ–¹æ³•èƒ½åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨å—ï¼Ÿ</p>
<blockquote>
<p>Glideçš„with()æ–¹æ³•å’Œload()æ–¹æ³•æ˜¯å¯ä»¥çš„ï¼Œå…¶ä¸­with()ä¼ å…¥çš„contextï¼Œè‹¥åœ¨éä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸ç®¡ä½ æ˜¯ä¼ å…¥çš„Activityè¿˜æ˜¯Fragmentï¼Œéƒ½ä¼šè¢«å¼ºåˆ¶å½“æˆApplicationæ¥å¤„ç†ï¼Œå¯èƒ½é€ æˆå†…å­˜æ³„æ¼ï¼›è€Œinto()æ— æ³•åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸â€œYou must call this method on the main threadâ€</p>
</blockquote>
</li>
<li><p>2 å¦‚ä½•å¤„ç†ä¸€ä¸ªå¤§å›¾çš„ç¼“å­˜ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;<span class="comment">//åªè¯»å–å›¾ç‰‡ï¼Œä¸åŠ è½½åˆ°å†…å­˜ä¸­</span></span><br><span class="line">        BitmapFactory.decodeFile(file, options);</span><br><span class="line">        options.inSampleSize=computeSampleSize(options, -<span class="number">1</span>, <span class="number">512</span>*<span class="number">512</span>);<span class="comment">//è¿”å›åˆé€‚çš„inSampleSizeå€¼,inSampleSizeæ˜¯ç¼©æ”¾å‚æ•°ï¼Œå¿…é¡»è¢«äºŒæ•´é™¤</span></span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;<span class="comment">//åŠ è½½åˆ°å†…å­˜ä¸­</span></span><br><span class="line">        bitmap = BitmapFactory.decodeFile(file, options);</span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/me.jpg"
                alt="Coding_dog" />
            
              <p class="site-author-name" itemprop="name">Coding_dog</p>
              <p class="site-description motion-element" itemprop="description">ä½ æ„¿æ„é™ªæˆ‘ä¸€èµ·èœé¸¡å˜å‡¤å‡°å—</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Coding_dog</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'lKEXk4PjEE7zRpQT1zDMocSF-gzGzoHsz',
        appKey: 'oUy3OQ2TDAHq3mNInqu0U6eH',
        placeholder: 'è¯´ä¸¤å¥',
        avatar:'wavatar',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
